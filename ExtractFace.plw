#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# Tool name     : ExtractFace
# Description   : Dump Facebook stuff for analysis or reporting purposes
# WebSite				: http://le-tools.com/ExtractFace.html
# Documentation	: http://le-tools.com/ExtractFaceDoc.html
# CodePlex			: https://extractface.codeplex.com
# GitHub				: https://github.com/arioux/ExtractFace
# Creation      : 2015-08-01
# Modified      : 2017-01-24
my $VERSION     = "5.0";
# Author        : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2015-2017  Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#

#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use utf8;
use arybase;
use Encode qw(encode decode);
use Excel::Writer::XLSX;
use File::Copy::Recursive qw(rcopy);
use File::Path qw(remove_tree);
use Firefox::Application::API40;
use Firefox::Application;
use HTML::Entities;
use Image::Info qw(image_info dim);
use LWP::UserAgent;
use Module::Pluggable::Fast;
use MozRepl::Client;
use MozRepl::Log;
use MozRepl::RemoteObject;
use MozRepl;
use threads;
use threads::shared;
use Time::Local;
use Time::HiRes qw(usleep);
use DateTime;
use DateTime::Format::Strptime;
use URI::Escape::JavaScript qw(unescape);
use Win32::API();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::GUI qw( WS_POPUP WS_CAPTION WS_THICKFRAME WS_EX_TOPMOST );
use Win32::GUI::BitmapInline();
use Win32::GUI::Grid;
use Win32::Process;
use WWW::Mechanize::Firefox;
require "ExtractFaceGraph.pl";
require "ExtractFaceLang.pl";

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#

my ($winICO, $logoBmp, $albumBmp, $friendsBmp, $eventBmp, $contribBmp, $chatBmp,
    $configBmp, $browseBmp, $explorerBmp, $refresh16) = &loadGraph();
  
#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\ExtractFace") { $USERDIR = "$ENV{'APPDATA'}\\ExtractFace"; }
else                                   { $USERDIR = $PROGDIR;                       }
my $CONFIG_FILE  = "$USERDIR\\ExtractFace.ini";                                # Configuration file
my $DEBUG_FILE   = "$USERDIR\\debug.log";                                      # Debug log file
my $LANG_FILE    = "$USERDIR\\Lang.ini";                                       # Langage file
my $URL_DOC      = "http://le-tools.com/ExtractFaceDoc.html";                  # Online documentation
my $URL_TOOL     = 'http://le-tools.com/ExtractFace.html#Download';            # Url of the tool (download)
my $URL_VER      = 'http://www.le-tools.com/download/ExtractFaceVer.txt';      # Url of the version file
my %CONFIG;                                                                    # Configuration
my %STR;                                                                       # Strings for GUI
my $ARROW       :shared;                                                       # Arrow pointer
my $HOURGLASS   :shared;                                                       # Hourglass pointer
my $START       = 0;                                                           # Indicate when program is started
my $THR;                                                                       # Thread

#------------------------------------------------------------------------------#
# Strings
#------------------------------------------------------------------------------#

&loadDefaultStr(\%STR); # Load default language (en)
if (-e $LANG_FILE and -T $LANG_FILE) { &loadStr(\%STR, $LANG_FILE); } # If language file, load translated strings

#------------------------------------------------------------------------------#
# Splash window
#------------------------------------------------------------------------------#

my $splash = new Win32::GUI::Window ( -name       => 'Splash'                   ,
                                      -text       => 'Splash'                   ,
                                      -size       => [128,128]                  ,
                                      -pos        => [100,100]                  ,
                                      -addstyle   => WS_POPUP                   ,
                                      -popstyle   => WS_CAPTION | WS_THICKFRAME ,
                                      -addexstyle => WS_EX_TOPMOST              , );
$splash->AddLabel(                    -name       => 'Bitmap'                   ,
                                      -size       => [128,128]                  ,
                                      -pos        => [  0,  0]                  ,
                                      -bitmap     => $logoBmp                   , );

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#

my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);     # Width
my $scrnY     = Win32::GUI::Height($screen);    # Height
my $winWidth  = 520;
my $winHeight = 195;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;

my $win = Win32::GUI::Window->new( -name       => 'main'               ,
                                   -title      => 'ExtractFace'        ,
                                   -background => [255, 255, 255]      ,
                                   -width      => $winWidth            ,
                                   -height     => $winHeight           ,
                                   -pos        => [$winPosX, $winPosY] ,
                                   -resizable  => 0                    ,
                                   -hasmaximize=> 0                    , );
$win->SetIcon($winICO);

# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my $fontGB;
my $fontGB2;
my $font8;
my $font10;
my $font10t;

# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name       => 'Arial '             ,
                                  -size       => 10                   ,
                                  -bold       => 1                    , );
  $fontGB2 = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       => 10                   ,
                                  -bold       => 1                    ,
                                  -underline  => 1                    , );
  $font8   = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  6                   , );
  $font10  = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                  , );
  $font10t = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                  ,
                                  -underline  =>  1                   , );
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name       => 'Arial '             ,
                                  -size       => 12                   ,
                                  -bold       => 1                    , );
  $fontGB2 = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       => 12                   ,
                                  -bold       => 1                    ,
                                  -underline  => 1                    , );
  $font8   = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  8                   , );
  $font10  = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  10                  , );
  $font10t = new Win32::GUI::Font(-name       => 'Arial'              ,
                                  -size       =>  10                  ,
                                  -underline  =>  1                   , );
}

# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);

# Taskbar
$win->AddNotifyIcon(-name    => "Tray"           , 
                    -icon    => $winICO          ,
                    -tip     => 'ExtractFace'    ,
                    -balloon => 1                , );

# Main section
$win->AddLabel(   -name        => 'lblLogo'           ,
                  -size        => [128,128]           ,
                  -pos         => [  0,  5]           ,
                  -bitmap      => $logoBmp            ,
                  -background  => [255, 255, 255]     , );
$win->AddLabel(   -name        => 'lblText1'          ,
                  -size        => [ 90, 65]           ,
                  -pos         => [135, 10]           ,
                  -font        => $font10             ,
                  -foreground  => [0  , 0  , 102]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => $STR{'update4'}.":\n".$STR{'website'}.":\n".$STR{'author'}.":\n".$STR{'translatedBy'}.':', );
$win->AddLabel(   -name        => 'lblText2'          ,
                  -size        => [270, 65]           ,
                  -pos         => [230, 10]           ,
                  -font        => $font10             ,
                  -foreground  => [185, 154,   0]     ,
                  -background  => [255, 255, 255]     ,
                  -text        =>  "$VERSION\nhttp://www.le-tools.com/\nAlain Rioux (admin\@le-tools.com)\n$STR{'translatorName'}", );
$win->AddLabel(   -name        => 'lblText3'          ,
                  -size        => [300, 20]           ,
                  -pos         => [135, 80]           ,
                  -font        => $font10             ,
                  -foreground  => [0  , 0  , 102]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => '© Copyright 2015-2016 Alain Rioux', );
$win->AddLabel(   -name        => 'lblText4'          ,
                  -size        => [340, 22]           ,
                  -pos         => [180,110]           ,
                  -font        => $font10             ,
                  -foreground  => [255,   0,   0]     ,
                  -background  => [255, 255, 255]     ,
                  -text        => '>> '.$STR{'lblText4'}.' <<', );
$win->AddCheckbox(-name        => 'chStartMinimized'  ,
                  -size        => [300, 22]           ,
                  -pos         => [ 10,140]           ,
                  -text        => $STR{'chStartMinimized'},
                  -background  => [255, 255, 255]     ,
                  -font        => $font10             , );

# Load taskbar menu
my $trayMenu = Win32::GUI::Menu->new(
 	"SysTray"             => "SysTray",
  ">$STR{'menu1'}"      => { -name => "ScrollExpand" , -onClick => \&scrollExpand           },
  ">$STR{'menu2'}"      => { -name => "Scrolling"    , -onClick => \&scroll                 },
  ">$STR{'menu3'}"      => { -name => "Expand"       , -onClick => \&expand                 },
  " > -"                => 0,
  ">$STR{'menu5'}..."   => { -name => "Albums"       , -onClick => \&winAlbumsNormal        },
  ">$STR{'menu6'}..."   => { -name => "Friends"      , -onClick => \&winFriends             },
  ">$STR{'menu7'}..."   => { -name => "Events"       , -onClick => \&winEvent               },
  ">$STR{'menu17'}..."  => { -name => "Contributors" , -onClick => \&winContrib             },
	">$STR{'chat'}"     	=> 0,
	">>$STR{'menu18'}"    	=> { -name => "ScrollContacts", -onClick => \&scrollContacts       },
  ">>$STR{'menu8'}"      	=> { -name => "ScrollChat"    , -onClick => \&scrollChat           },
  ">>$STR{'menu9'}"      	=> { -name => "LoadOldMsg"    , -onClick => \&loadOldMsg           },
  ">>$STR{'menu10'}"     	=> { -name => "LoadNewMsg"    , -onClick => \&loadNewMsg           },
  ">>$STR{'menu11'}..."  	=> { -name => "Chat"          , -onClick => \&winChat              },
  ">>$STR{'menu20'}..."  	=> { -name => "VocalMessage"  , -onClick => \&winVocalMsg          },
  ">$STR{'menu4'}"      => 1,
  ">>$STR{'menu5'}..."   	=> { -name => "GroupAlbums"   , -onClick => \&winGroupAlbums       },
  ">>$STR{'menu19'}..."  	=> { -name => "GroupMembers"  , -onClick => \&winGroupMembers      },
  " > -"                => 0,
  ">$STR{'menu12'}..."  => { -name => "Config"       , -onClick => \&winConfig              },
  " > -"                => 0,
  ">$STR{'menu14'}..."  => { -name => "Help"         , -onClick => \&help                   },
  ">$STR{'menu15'}..."  => { -name => "About"        , -onClick => \&Tray_DblClick          },
  ">$STR{'menu16'}"     => { -name => "Quit"         , -onClick => \&main_Quit              },
);

#------------------------------------------------------------------------------#
# Dump albums window
#------------------------------------------------------------------------------#
my $winAlbums = Win32::GUI::DialogBox->new( -name        => 'winAlbums'           ,
                                            -parent      => $win                  ,
                                            -text        => $STR{'winAlbums'}			,
                                            -pos         => [$winPosX, $winPosY]	,
                                            -size        => [790,390]             ,
                                            -background  => [255, 255, 255]       ,
                                            -hasmaximize => 1                     ,
                                            -hasminimize => 1                     ,
                                            -helpbutton  => 0                     ,
                                            -resizable   => 1                     ,
                                            -topmost     => 1                     ,
                                            -dialogui    => 1                     , );
$winAlbums->SetIcon($winICO);

$winAlbums->AddLabel(             -name         => 'lblLogo'                      ,
                                  -size         => [128,128]                      ,
                                  -pos          => [  5,  5]                      ,
                                  -bitmap       => $albumBmp                      ,
                                  -background   => [255, 255, 255]                , );
$winAlbums->AddLabel(             -name         => 'lblAlbumTitle'                ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 18]                      ,
                                  -text         => $STR{'file'}.':'               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddTextfield(         -name         => 'tfAlbumTitle'                 ,
                                  -size         => [440, 22]                      ,
                                  -pos          => [220, 15]                      , );
$winAlbums->AddCheckbox(          -name         => 'chAlbumGroup'                 ,
                                  -size         => [200, 20]                      ,
                                  -pos          => [665, 15]                      ,
                                  -text         => $STR{'group'}                  ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -visible      => 0                              , );
$winAlbums->AddLabel(             -name         => 'lblDirSaveAlbums'             ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 48]                      ,
                                  -text         => $STR{'dir'}.':'                ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddTextfield(         -name         => 'tfDirSaveAlbums'              ,
                                  -size         => [440, 22]                      ,
                                  -pos          => [220, 45]                      , );
$winAlbums->AddButton(            -name         => 'btnDirSaveAlbums'             ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [662, 45]                      ,
                                  -bitmap       => $browseBmp                     , );
$winAlbums->AddButton(            -name         => 'btnBrowseDirSaveAlbums'       ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [685, 45]                      ,
                                  -bitmap       => $explorerBmp                   ,
                                  -tip          => $STR{'browseFolder'}           , );
$winAlbums->AddCheckbox(          -name         => 'chSaveAlbumDir'               ,
                                  -size         => [200, 20]                      ,
                                  -pos          => [220, 73]                      ,
                                  -text         => $STR{'remDir'}                 ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -checked      => 0                              , );
$winAlbums->AddLabel(             -name         => 'lblInProgress'                ,
                                  -size         => [256, 22]                      ,
                                  -pos          => [490, 74]                      ,
                                  -font         => $font10                        ,
                                  -foreground   => [0, 153, 0]                    ,
                                  -background   => [255, 255, 255]                ,
                                  -visible      => 1                              , );
$winAlbums->AddButton(            -name         => 'btnAlbumsRefresh'             ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [748, 76]                      ,
                                  -bitmap       => $refresh16                     ,
                                  -tip          => $STR{'btnRefreshTip'}          ,
                                  -tabstop      => 1                              , );
$winAlbums->AddGrid (             -name         => 'GridAlbums'                   ,
                                  -pos          => [140,100]                      ,
                                  -size         => [630,145]                      ,
                                  -fixedrows    => 1                              ,
                                  -fixedcolumns => 0                              ,
                                  -editable     => 0                              , );
$winAlbums->GridAlbums->SetListMode(1);
$winAlbums->AddLabel(             -name         => 'lblAlbumsOpt'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,250]                      ,
                                  -text         => $STR{'lblOptions'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winAlbums->AddCheckbox(          -name         => 'chPublishDate'                ,
                                  -size         => [190, 20]                      ,
                                  -pos          => [220,250]                      ,
                                  -text         => $STR{'chPublishDate'}          ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddCheckbox(          -name         => 'chAlbumsOpenHTML'             ,
                                  -size         => [180, 20]                      ,
                                  -pos          => [415,250]                      ,
                                  -text         => $STR{'openHTML'}               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddCheckbox(          -name         => 'chAlbumsOpenDir'              ,
                                  -size         => [170, 20]                      ,
                                  -pos          => [600,250]                      ,
                                  -text         => $STR{'openAlbumDir'}           ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        , );
$winAlbums->AddLabel(             -name         => 'lblPicturesSize'              ,
                                  -size         => [100, 22]                      ,
                                  -pos          => [220,283]                      ,
                                  -text         => $STR{'picSize'}.':'            ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winAlbums->AddCombobox(          -name         => 'cbPicturesSize'               ,
                                  -size         => [ 80,100]                      ,
                                  -pos          => [325,280]                      ,
                                  -font         => $font10                        ,
                                  -dropdownlist => 1                              ,
                                  -vscroll      => 1                              , );
$winAlbums->cbPicturesSize->Add( $STR{'small'}, $STR{'medium'}, $STR{'full'},);
$winAlbums->cbPicturesSize->SetCurSel(2);

$winAlbums->AddButton(            -name         => 'btnAlbumsOk'                  ,
                                  -size         => [ 85, 30]                      ,
                                  -pos          => [355,310]                      ,
                                  -text         => $STR{'dump'}                   ,
                                  -font         => $font10                        ,
                                  -disabled     => 1                              ,
                                  -ok           => 1                              ,
                                  -default      => 1                              , );

#------------------------------------------------------------------------------#
# Dump friends window
#------------------------------------------------------------------------------#
my $winFriends = Win32::GUI::DialogBox->new(-name        => 'winFriends'          ,
                                            -parent      => $win                  ,
                                            -text        => $STR{'winFriends'}		,
                                            -pos         => [$winPosX, $winPosY]	,
                                            -size        => [800,315]             ,
                                            -background  => [255, 255, 255]       ,
                                            -hasmaximize => 0                     ,
                                            -hasminimize => 1                     ,
                                            -helpbutton  => 0                     ,
                                            -resizable   => 0                     ,
                                            -topmost     => 1                     ,
                                            -dialogui    => 1                     , );
$winFriends->SetIcon($winICO);

$winFriends->AddLabel(              -name       => 'lblLogo'                      ,
                                    -size       => [128,128]                      ,
                                    -pos        => [  0,  5]                      ,
                                    -bitmap     => $friendsBmp                    ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddLabel(              -name       => 'lblFriendName'                ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 18]                      ,
                                    -text       => $STR{'file'}.':'               ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddTextfield(          -name       => 'tfFriendName'                 ,
                                    -size       => [332, 22]                      ,
                                    -pos        => [220, 15]                      ,
                                    -tabstop    => 1                              , );
$winFriends->AddCombobox(           -name       => 'cbFriendsFormat'              ,
                                    -size       => [ 55, 22]                      ,
                                    -pos        => [555, 15]                      ,
                                    -dropdownlist => 1                            ,
                                    -vscroll    => 1                              ,
                                    -tabstop    => 1                              , );
$winFriends->cbFriendsFormat->Add(  'XLSX', 'HTML', 'TXT'                         , );
$winFriends->cbFriendsFormat->SetCurSel(0);
$winFriends->AddCheckbox(           -name       => 'chFriendsOpenOutput'          ,
                                    -size       => [165, 22]                      ,
                                    -pos        => [615, 15]                      ,
                                    -text       => $STR{'chOpenOutput'}           ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddLabel(              -name       => 'lblDirSaveFriends'            ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 48]                      ,
                                    -text       => $STR{'dir'}.':'                ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddTextfield(          -name       => 'tfDirSaveFriends'             ,
                                    -size       => [342, 22]                      ,
                                    -pos        => [220, 45]                      ,
                                    -tabstop    => 1                              , );
$winFriends->AddButton(             -name       => 'btnDirSaveFriends'            ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [564, 45]                      ,
                                    -bitmap     => $browseBmp                     ,
                                    -tabstop    => 1                              , );
$winFriends->AddButton(             -name       => 'btnBrowseDirSaveFriends'      ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [588, 45]                      ,
                                    -bitmap     => $explorerBmp                   ,
                                    -tip        => $STR{'browseFolder'}           ,
                                    -tabstop    => 1                              , );
$winFriends->AddCheckbox(           -name       => 'chSaveFriendsDir'             ,
                                    -size       => [200, 20]                      ,
                                    -pos        => [615, 45]                      ,
                                    -text       => $STR{'remDir'}                 ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddLabel(              -name       => 'lblFriendsOpt'                ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 76]                      ,
                                    -text       => $STR{'lblOptions'}.':'         ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winFriends->AddCheckbox(           -name       => 'chFriendsProfileIcons'        ,
                                    -size       => [170, 20]                      ,
                                    -pos        => [220, 75]                      ,
                                    -text       => $STR{'chIncludeIcons'}         ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winFriends->AddLabel(              -name       => 'lblInProgress'                ,
                                    -size       => [200, 22]                      ,
                                    -pos        => [560, 76]                      ,
                                    -font       => $font10                        ,
                                    -foreground => [0, 153, 0]                    ,
                                    -background => [255, 255, 255]                ,
                                    -visible    => 1                              , );
$winFriends->AddButton(             -name       => 'btnFriendsRefresh'            ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [763, 76]                      ,
                                    -bitmap     => $refresh16                     ,
                                    -tip        => $STR{'btnRefreshTip'}          ,
                                    -tabstop    => 1                              , );
$winFriends->AddGrid (              -name         => 'GridFriends'                ,
                                    -pos          => [140,100]                    ,
                                    -size         => [645,145]                    ,
                                    -fixedrows    => 1                            ,
                                    -fixedcolumns => 0                            ,
                                    -editable     => 0                            , );
$winFriends->GridFriends->SetListMode(1);
$winFriends->AddButton(             -name       => 'btnFriendsOk'                 ,
                                    -size       => [ 90, 30]                      ,
                                    -pos        => [355,250]                      ,
                                    -text       => $STR{'dump'}                   ,
                                    -font       => $font10                        ,
                                    -disabled   => 1                              ,
                                    -tabstop    => 1                              ,
                                    -ok         => 1                              ,
                                    -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Event members window
#------------------------------------------------------------------------------#
my $winEvent = Win32::GUI::DialogBox->new( -name        => 'winEvent'           ,
                                           -parent      => $win                 ,
                                           -text        => $STR{'winEvent'}			,
                                           -pos         => [$winPosX, $winPosY] ,
                                           -size        => [745,380]            ,
                                           -background  => [255, 255, 255]      ,
                                           -hasmaximize => 0                    ,
                                           -hasminimize => 1                    ,
                                           -helpbutton  => 0                    ,
                                           -resizable   => 0                    ,
                                           -topmost     => 1                    ,
                                           -dialogui    => 1                    , );
$winEvent->SetIcon($winICO);

$winEvent->AddLabel(              -name         => 'lblLogo'                      ,
                                  -size         => [128,128]                      ,
                                  -pos          => [  0,  5]                      ,
                                  -bitmap       => $eventBmp                      ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddLabel(              -name         => 'lblEventName'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 18]                      ,
                                  -text         => $STR{'file'}.':'               ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfEventName'                  ,
                                  -size         => [260, 22]                      ,
                                  -pos          => [220, 15]                      ,
                                  -tabstop      => 1                              , );
$winEvent->AddLabel(              -name         => 'lblDirSaveEvent'              ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140, 48]                      ,
                                  -text         => $STR{'dir'}.':'                ,
                                  -font         => $font10                        , 
                                  -background   => [255, 255, 255]                ,);
$winEvent->AddTextfield(          -name         => 'tfDirSaveEvent'               ,
                                  -size         => [340, 22]                      ,
                                  -pos          => [220, 45]                      ,
                                  -tabstop      => 1                              , );
$winEvent->AddButton(             -name         => 'btnDirSaveEvent'              ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [562, 45]                      ,
                                  -bitmap       => $browseBmp                     ,
                                  -tabstop      => 1                              , );
$winEvent->AddButton(             -name         => 'btnBrowseDirSaveEvent'        ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [585, 45]                      ,
                                  -bitmap       => $explorerBmp                   ,
                                  -tip          => $STR{'browseFolder'}           ,
                                  -tabstop      => 1                              , );
$winEvent->AddCheckbox(           -name         => 'chSaveEventDir'               ,
                                  -size         => [200, 20]                      ,
                                  -pos          => [220, 73]                      ,
                                  -text         => $STR{'remDir'}                 ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddLabel(              -name         => 'lblEventsOpt'                 ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,101]                      ,
                                  -text         => $STR{'lblOptions'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddCheckbox(           -name         => 'chEventProfileIcons'          ,
                                  -size         => [170, 22]                      ,
                                  -pos          => [220,100]                      ,
                                  -text         => $STR{'chIncludeIcons'}         ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chEventOpenXLSX'              ,
                                  -size         => [170, 22]                      ,
                                  -pos          => [395,100]                      ,
                                  -text         => $STR{'openXLSX'}               ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
# Event Details
$winEvent->AddLabel(              -name         => 'lblEventDetailsT'             ,
                                  -size         => [590, 22]                      ,
                                  -pos          => [140,135]                      ,
                                  -text         => $STR{'lblEventDetailsT'}       ,
                                  -font         => $fontGB                        ,
                                  -background   => [206, 221, 255]                , );
$winEvent->AddLabel(              -name         => 'lblEventID'                   ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,168]                      ,
                                  -text         => $STR{'lblEventID'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfEventID'                    ,
                                  -size         => [220, 22]                      ,
                                  -pos          => [260,165]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblInProgress'                ,
                                  -size         => [216, 22]                      ,
                                  -pos          => [490,168]                      ,
                                  -font         => $font10                        ,
                                  -foreground   => [0, 153, 0]                    ,
                                  -background   => [255, 255, 255]                ,
                                  -visible      => 1                              , );
$winEvent->AddButton(             -name         => 'btnEventRefresh'              ,
                                  -size         => [ 22, 22]                      ,
                                  -pos          => [708,166]                      ,
                                  -bitmap       => $refresh16                     ,
                                  -tip          => $STR{'btnRefreshTip'}          ,
                                  -tabstop      => 1                              , );
$winEvent->AddLabel(              -name         => 'lblAuthorID'                  ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,198]                      ,
                                  -text         => $STR{'lblAuthorID'}.':'        ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfAuthorID'                   ,
                                  -size         => [220, 22]                      ,
                                  -pos          => [260,195]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblDataURL'                   ,
                                  -size         => [115, 22]                      ,
                                  -pos          => [140,228]                      ,
                                  -text         => $STR{'lblDataURL'}.':'         ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddTextfield(          -name         => 'tfDataURL'                    ,
                                  -size         => [470, 22]                      ,
                                  -pos          => [260,225]                      ,
                                  -tabstop      => 1                              ,
                                  -readonly     => 1                              , );
$winEvent->AddLabel(              -name         => 'lblGuestLists'                ,
                                  -size         => [ 75, 22]                      ,
                                  -pos          => [140,258]                      ,
                                  -text         => $STR{'lblGuestLists'}.':'      ,
                                  -font         => $font10                        ,
                                  -background   => [255, 255, 255]                , );
$winEvent->AddCheckbox(           -name         => 'chGoing'                      ,
                                  -size         => [160, 20]                      ,
                                  -pos          => [260,255]                      ,
                                  -text         => 'Going'                        ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chMaybe'                      ,
                                  -size         => [160, 20]                      ,
                                  -pos          => [425,255]                      ,
                                  -text         => 'Maybe'                        ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chInvited'                    ,
                                  -size         => [160, 20]                      ,
                                  -pos          => [260,278]                      ,
                                  -text         => 'Invited'                      ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddCheckbox(           -name         => 'chDeclined'                   ,
                                  -size         => [160, 20]                      ,
                                  -pos          => [425,278]                      ,
                                  -text         => 'Declined'                     ,
                                  -background   => [255, 255, 255]                ,
                                  -font         => $font10                        ,
                                  -tabstop      => 1                              ,
                                  -checked      => 0                              , );
$winEvent->AddButton(             -name         => 'btnEventOk'                   ,
                                  -size         => [ 90, 30]                      ,
                                  -pos          => [360,310]                      ,
                                  -text         => $STR{'dump'}                   ,
                                  -font         => $font10                        ,
                                  -disabled     => 1                              ,
                                  -tabstop      => 1                              ,
                                  -ok           => 1                              ,
                                  -default      => 1                              , );

#------------------------------------------------------------------------------#
# Dump Contributors window
#------------------------------------------------------------------------------#
my $winContrib = Win32::GUI::DialogBox->new(  -name        => 'winContrib'          ,
                                              -parent      => $win                  ,
                                              -text        => $STR{'menu17'}				,
                                              -pos         => [$winPosX, $winPosY]	,
                                              -size        => [625,320]             ,
                                              -background  => [255, 255, 255]       ,
                                              -hasmaximize => 0                     ,
                                              -hasminimize => 1                     ,
                                              -helpbutton  => 0                     ,
                                              -resizable   => 0                     ,
                                              -topmost     => 1                     ,
                                              -dialogui    => 1                     , );
$winContrib->SetIcon($winICO);
$winContrib->AddLabel(            -name       => 'lblLogo'                      ,
                                  -size       => [128,128]                      ,
                                  -pos        => [  0,  5]                      ,
                                  -bitmap     => $contribBmp                    ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddLabel(            -name       => 'lblContribName'               ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 18]                      ,
                                  -text       => $STR{'file'}.':'               ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddTextfield(        -name       => 'tfContribName'                ,
                                  -size       => [260, 22]                      ,
                                  -pos        => [220, 15]                      ,
                                  -tabstop    => 1                              , );
$winContrib->AddLabel(            -name       => 'lblDirSaveContrib'            ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 48]                      ,
                                  -text       => $STR{'dir'}.':'                ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winContrib->AddTextfield(        -name       => 'tfDirSaveContrib'             ,
                                  -size       => [342, 22]                      ,
                                  -pos        => [220, 45]                      ,
                                  -tabstop    => 1                              , );
$winContrib->AddButton(           -name       => 'btnDirSaveContrib'            ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [564, 45]                      ,
                                  -bitmap     => $browseBmp                     ,
                                  -tabstop    => 1                              , );
$winContrib->AddButton(           -name       => 'btnBrowseDirSaveContrib'      ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [587, 45]                      ,
                                  -bitmap     => $explorerBmp                   ,
                                  -tip        => $STR{'browseFolder'}           ,
                                  -tabstop    => 1                              , );
$winContrib->AddCheckbox(         -name       => 'chSaveContribDir'             ,
                                  -size       => [200, 20]                      ,
                                  -pos        => [220, 72]                      ,
                                  -text       => $STR{'remDir'}                 ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Types section
$winContrib->AddLabel(            -name       => 'lblContribCat'                ,
                                  -size       => [470, 22]                      ,
                                  -pos        => [140,102]                      ,
                                  -text       => $STR{'lblContribTypes'}        ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winContrib->AddCheckbox(         -name       => 'chContribComments'            ,
                                  -size       => [105, 20]                      ,
                                  -pos        => [140,132]                      ,
                                  -text       => $STR{'chContribComments'}      ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribLikes'               ,
                                  -size       => [ 80, 20]                      ,
                                  -pos        => [250,132]                      ,
                                  -text       => $STR{'chContribLikes'}         ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribVPosts'              ,
                                  -size       => [250, 20]                      ,
                                  -pos        => [335,132]                      ,
                                  -text       => $STR{'chContribVPosts'}        ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Options section
$winContrib->AddLabel(            -name       => 'lblContribOpt'                ,
                                  -size       => [470, 22]                      ,
                                  -pos        => [140,162]                      ,
                                  -text       => $STR{'lblOptions'}             ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winContrib->AddCheckbox(         -name       => 'chContribProfileIcons'        ,
                                  -size       => [170, 22]                      ,
                                  -pos        => [140,192]                      ,
                                  -text       => $STR{'chIncludeIcons'}         ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribOpenXLSX'            ,
                                  -size       => [210, 22]                      ,
                                  -pos        => [325,192]                      ,
                                  -text       => $STR{'openXLSX'}               ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              , );
$winContrib->AddCheckbox(         -name       => 'chContribDontScrollVPosts'    ,
                                  -size       => [300, 22]                      ,
                                  -pos        => [140,217]                      ,
                                  -text       => $STR{'dontScrollVPosts'}       ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -checked    => 0                              ,
                                  -disabled   => 1                              , );

$winContrib->AddButton(           -name       => 'btnContribOk'                 ,
                                  -size       => [ 85, 30]                      ,
                                  -pos        => [310,250]                      ,
                                  -text       => $STR{'dump'}                   ,
                                  -font       => $font10                        ,
                                  -disabled   => 1                              ,
                                  -tabstop    => 1                              ,
                                  -ok         => 1                              ,
                                  -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Group Members window
#------------------------------------------------------------------------------#
my $winGroupMembers = Win32::GUI::DialogBox->new( -name        => 'winGroupMembers'       ,
																									-parent      => $win                    ,
																									-text        => $STR{'winGroupMembers'} ,
																									-pos         => [$winPosX, $winPosY]		,
																									-size        => [800,240]               ,
																									-background  => [255, 255, 255]         ,
																									-hasmaximize => 0                       ,
																									-hasminimize => 1                       ,
																									-helpbutton  => 0                       ,
																									-resizable   => 0                       ,
																									-topmost     => 1                       ,
																									-dialogui    => 1                       , );
$winGroupMembers->SetIcon($winICO);

$winGroupMembers->AddLabel(         -name       => 'lblLogo'                      ,
                                    -size       => [128,128]                      ,
                                    -pos        => [  0,  5]                      ,
                                    -bitmap     => $eventBmp               				,
                                    -background => [255, 255, 255]                , );
$winGroupMembers->AddLabel(         -name       => 'lblGroupMembersName'          ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 18]                      ,
                                    -text       => $STR{'file'}.':'               ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winGroupMembers->AddTextfield(     -name       => 'tfGroupMembersName'           ,
                                    -size       => [332, 22]                      ,
                                    -pos        => [220, 15]                      ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddCombobox(      -name       => 'cbGroupMembersFormat'         ,
                                    -size       => [ 55, 22]                      ,
                                    -pos        => [555, 15]                      ,
                                    -dropdownlist => 1                            ,
                                    -vscroll    => 1                              ,
                                    -tabstop    => 1                              , );
$winGroupMembers->cbGroupMembersFormat->Add('XLSX', 'HTML', 'TXT', );
$winGroupMembers->cbGroupMembersFormat->SetCurSel(0);
$winGroupMembers->AddCheckbox(      -name       => 'chGroupMembersOpenOutput'     ,
                                    -size       => [165, 22]                      ,
                                    -pos        => [615, 15]                      ,
                                    -text       => $STR{'chOpenOutput'}           ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddLabel(         -name       => 'lblDirSaveGroupMembers'       ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 48]                      ,
                                    -text       => $STR{'dir'}.':'                ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winGroupMembers->AddTextfield(     -name       => 'tfDirSaveGroupMembers'        ,
                                    -size       => [342, 22]                      ,
                                    -pos        => [220, 45]                      ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddButton(        -name       => 'btnDirSaveGroupMembers'       ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [564, 45]                      ,
                                    -bitmap     => $browseBmp                     ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddButton(        -name       => 'btnBrowseDirSaveGroupMembers' ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [588, 45]                      ,
                                    -bitmap     => $explorerBmp                   ,
                                    -tip        => $STR{'browseFolder'}           ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddCheckbox(      -name       => 'chSaveGroupMembersDir'        ,
                                    -size       => [200, 20]                      ,
                                    -pos        => [615, 45]                      ,
                                    -text       => $STR{'remDir'}                 ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddLabel(         -name       => 'lblGroupMembersOpt'           ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 76]                      ,
                                    -text       => $STR{'lblOptions'}.':'         ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winGroupMembers->AddCheckbox(      -name       => 'chGroupMembersProfileIcons'   ,
                                    -size       => [170, 20]                      ,
                                    -pos        => [220, 75]                      ,
                                    -text       => $STR{'chIncludeIcons'}         ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddButton(        -name       => 'btnGroupMembersRefresh'       ,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [763, 73]                      ,
                                    -bitmap     => $refresh16                     ,
                                    -tip        => $STR{'btnRefreshTip'}          ,
                                    -tabstop    => 1                              , );
$winGroupMembers->AddLabel(         -name       => 'lblGroupMembersList'          ,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140,101]                      ,
                                    -text       => $STR{'dump'}.':'               ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winGroupMembers->AddListView(  		-name       => 'lvGroupMembersListSel'        ,
																		-pos        => [220,100]             					,
																		-size       => [342, 65]             					,
																		-font       => $font10               					,
																		-background => [255, 255, 255]       					,
																		-checkboxes => 1                     					,
																		-gridlines  => 0                     					,
																		-hottrack   => 1                     					,
																		-nocolumnheader => 1                  				,
																		-tabstop    => 1                     					, );
$winGroupMembers->lvGroupMembersListSel->InsertColumn(-width => 322, index => 0, -text => '1',);
$winGroupMembers->AddButton(        -name       => 'btnGroupMembersOk'            ,
                                    -size       => [ 90, 30]                      ,
                                    -pos        => [355,175]                      ,
                                    -text       => $STR{'dump'}                   ,
                                    -font       => $font10                        ,
                                    -disabled   => 1                              ,
                                    -tabstop    => 1                              ,
                                    -ok         => 1                              ,
                                    -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Chat window
#------------------------------------------------------------------------------#
my $winChat = Win32::GUI::DialogBox->new(  -name        => 'winChat'            ,
                                           -parent      => $win									,
                                           -text        => $STR{'winChat'}			,
                                           -pos         => [$winPosX, $winPosY]	,
                                           -size        => [665,325]            ,
                                           -background  => [255, 255, 255]      ,
                                           -hasmaximize => 0                    ,
                                           -hasminimize => 1                    ,
                                           -helpbutton  => 0                    ,
                                           -resizable   => 0                    ,
                                           -topmost     => 1                    ,
                                           -dialogui    => 1                    , );
$winChat->SetIcon($winICO);

$winChat->AddLabel(               -name       => 'lblLogo'                      ,
                                  -size       => [128,128]                      ,
                                  -pos        => [  0,  5]                      ,
                                  -bitmap     => $chatBmp                       ,
                                  -background => [255, 255, 255]                , );
$winChat->AddLabel(               -name       => 'lblChatName'                  ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 18]                      ,
                                  -text       => $STR{'file'}.':'               ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddTextfield(           -name       => 'tfChatName'                   ,
                                  -size       => [260, 22]                      ,
                                  -pos        => [220, 15]                      ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblDirSaveChat'               ,
                                  -size       => [ 70, 22]                      ,
                                  -pos        => [140, 48]                      ,
                                  -text       => $STR{'dir'}.':'                ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddTextfield(           -name       => 'tfDirSaveChat'                ,
                                  -size       => [383, 22]                      ,
                                  -pos        => [220, 45]                      ,
                                  -tabstop    => 1                              , );
$winChat->AddButton(              -name       => 'btnDirSaveChat'               ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [605, 45]                      ,
                                  -bitmap     => $browseBmp                     ,
                                  -tabstop    => 1                              , );
$winChat->AddButton(              -name       => 'btnBrowseDirSaveChat'         ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [628, 45]                      ,
                                  -bitmap     => $explorerBmp                   ,
                                  -tip        => $STR{'browseFolder'}           ,
                                  -tabstop    => 1                              , );
$winChat->AddCheckbox(            -name       => 'chSaveChatDir'                ,
                                  -size       => [200, 20]                      ,
                                  -pos        => [220, 72]                      ,
                                  -text       => $STR{'remDir'}                 ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

# Options
$winChat->AddLabel(               -name       => 'lblChatOpt'                   ,
                                  -size       => [510, 22]                      ,
                                  -pos        => [140,100]                      ,
                                  -text       => $STR{'lblOptions'}             ,
                                  -font       => $fontGB                        ,
                                  -background => [206, 221, 255]                , );
$winChat->AddRadioButton(         -name       => 'rbChatNormalMode'             ,
                                  -size       => [125, 22]                      ,
                                  -pos        => [140,125]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatNormalMode'}       ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 1                              ,
                                  -group      => 1                              , );
$winChat->AddRadioButton(         -name       => 'rbChatSafeMode'               ,
                                  -size       => [140, 22]                      ,
                                  -pos        => [270,125]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'chSafeMode'}             ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddButton(              -name       => 'btnChatRefresh'               ,
                                  -size       => [ 22, 22]                      ,
                                  -pos        => [628,125]                      ,
                                  -bitmap     => $refresh16                     ,
                                  -tip        => $STR{'btnRefreshTip'}          ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblChatDownload'              ,
                                  -size       => [ 75, 22]                      ,
                                  -pos        => [140,155]                      ,
                                  -text       => $STR{'download'}.':'           ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddCheckbox(            -name       => 'chDownloadImg'                ,
                                  -size       => [100, 20]                      ,
                                  -pos        => [220,155]                      ,
                                  -text       => $STR{'chDownloadImg'}          ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadAD'                 ,
                                  -size       => [170, 20]                      ,
                                  -pos        => [325, 155]                     ,
                                  -text       => $STR{'chDownloadAD'}           ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddCheckbox(            -name       => 'chDownloadVid'                ,
                                  -size       => [105, 20]                      ,
                                  -pos        => [500,155]                      ,
                                  -text       => $STR{'chDownloadVid'}          ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );
$winChat->AddLabel(               -name       => 'lblChatDates'                 ,
                                  -size       => [ 75, 22]                      ,
                                  -pos        => [140,180]                      ,
                                  -text       => $STR{'dates'}.':'              ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddRadioButton(         -name       => 'rbChatDatesAll'               ,
                                  -size       => [ 50, 22]                      ,
                                  -pos        => [220,180]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatDatesAll'}         ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 1                              ,
                                  -group      => 1                              , );
$winChat->AddRadioButton(         -name       => 'rbChatDatesRange'             ,
                                  -size       => [ 60, 22]                      ,
                                  -pos        => [220,200]                      ,
                                  -background => [255, 255, 255]                ,
                                  -text       => $STR{'rbChatDatesRange'}       ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblChatDatesRangeS'           ,
                                  -size       => [ 50, 22]                      ,
                                  -pos        => [285,203]                      ,
                                  -text       => $STR{'start'}.':'              ,
                                  -align      => 'right'                        ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddDateTime(            -name       => 'dtChatDatesRangeS'            ,
                                  -size       => [ 90, 22]                      ,
                                  -pos        => [340,200]                      ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                ,
                                  -format     => 'shortdate'                    ,
                                  -tabstop    => 1                              , );
$winChat->AddLabel(               -name       => 'lblChatDatesRangeE'           ,
                                  -size       => [ 40, 22]                      ,
                                  -pos        => [435,203]                      ,
                                  -text       => $STR{'end'}.':'                ,
                                  -align      => 'right'                        ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                , );
$winChat->AddDateTime(            -name       => 'dtChatDatesRangeE'            ,
                                  -size       => [ 90, 22]                      ,
                                  -pos        => [480,200]                      ,
                                  -font       => $font10                        ,
                                  -background => [255, 255, 255]                ,
                                  -format     => 'shortdate'                    ,
                                  -tabstop    => 1                              , );
$winChat->AddCheckbox(            -name       => 'chHideMe'                     ,
                                  -size       => [220, 20]                      ,
                                  -pos        => [140,230]                      ,
                                  -text       => $STR{'chHideMe'}               ,
                                  -background => [255, 255, 255]                ,
                                  -font       => $font10                        ,
                                  -tabstop    => 1                              ,
                                  -checked    => 0                              , );

$winChat->AddButton(              -name       => 'btnChatOk'                    ,
                                  -size       => [ 85, 30]                      ,
                                  -pos        => [300,255]                      ,
                                  -text       => $STR{'dump'}                   ,
                                  -font       => $font10                        ,
                                  -disabled   => 1                              ,
                                  -tabstop    => 1                              ,
                                  -ok         => 1                              ,
                                  -default    => 1                              , );

#------------------------------------------------------------------------------#
# Dump Vocal Messages window
#------------------------------------------------------------------------------#
my $winVocalMsg = Win32::GUI::DialogBox->new( -name        => 'winVocalMsg'           ,
																							-parent      => $win                    ,
																							-text        => $STR{'winVocalMsg'}     ,
																							-pos         => [$winPosX, $winPosY]		,
																							-size        => [640,170]               ,
																							-background  => [255, 255, 255]         ,
																							-hasmaximize => 0                       ,
																							-hasminimize => 1                       ,
																							-helpbutton  => 0                       ,
																							-resizable   => 0                       ,
																							-topmost     => 1                       ,
																							-dialogui    => 1                       , );
$winVocalMsg->SetIcon($winICO);

$winVocalMsg->AddLabel(         		-name       => 'lblLogo'                      ,
                                    -size       => [128,128]                      ,
                                    -pos        => [  0,  5]                      ,
                                    -bitmap     => $chatBmp               				,
                                    -background => [255, 255, 255]                , );
$winVocalMsg->AddLabel(         		-name       => 'lblVocalMsgName'          		,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 18]                      ,
                                    -text       => $STR{'file'}.':'               ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winVocalMsg->AddTextfield(     		-name       => 'tfVocalMsgName'           		,
                                    -size       => [342, 22]                      ,
                                    -pos        => [220, 15]                      ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddButton(        		-name       => 'btnVocalMsgRefresh'       		,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [588, 15]                      ,
                                    -bitmap     => $refresh16                     ,
                                    -tip        => $STR{'btnRefreshTip'}          ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddLabel(         		-name       => 'lblDirSaveVocalMsg'       		,
                                    -size       => [ 75, 22]                      ,
                                    -pos        => [140, 48]                      ,
                                    -text       => $STR{'dir'}.':'                ,
                                    -font       => $font10                        ,
                                    -background => [255, 255, 255]                , );
$winVocalMsg->AddTextfield(     		-name       => 'tfDirSaveVocalMsg'        		,
                                    -size       => [342, 22]                      ,
                                    -pos        => [220, 45]                      ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddButton(        		-name       => 'btnDirSaveVocalMsg'       		,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [564, 45]                      ,
                                    -bitmap     => $browseBmp                     ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddButton(        		-name       => 'btnBrowseDirSaveVocalMsg' 		,
                                    -size       => [ 22, 22]                      ,
                                    -pos        => [588, 45]                      ,
                                    -bitmap     => $explorerBmp                   ,
                                    -tip        => $STR{'browseFolder'}           ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddCheckbox(      		-name       => 'chSaveVocalMsgDir'        		,
                                    -size       => [200, 20]                      ,
                                    -pos        => [220, 75]                      ,
                                    -text       => $STR{'remDir'}                 ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddCheckbox(      		-name       => 'chVocalMsgOpenOutput'     		,
                                    -size       => [165, 22]                      ,
                                    -pos        => [425, 75]                      ,
                                    -text       => $STR{'openHTML'}               ,
                                    -background => [255, 255, 255]                ,
                                    -font       => $font10                        ,
                                    -tabstop    => 1                              , );
$winVocalMsg->AddButton(        		-name       => 'btnVocalMsgOk'            		,
                                    -size       => [ 90, 30]                      ,
                                    -pos        => [305,105]                      ,
                                    -text       => $STR{'dump'}                   ,
                                    -font       => $font10                        ,
                                    -disabled   => 1                              ,
                                    -tabstop    => 1                              ,
                                    -ok         => 1                              ,
                                    -default    => 1                              , );

#------------------------------------------------------------------------------#
# Config window
#------------------------------------------------------------------------------#
my $winConfig = Win32::GUI::DialogBox->new( -name        => 'winConfig'           ,
                                            -parent      => $win                  ,
                                            -text        => $STR{'winConfig'}			,
                                            -pos         => [$winPosX, $winPosY]	,
                                            -size        => [650,300]             ,
                                            -background  => [255, 255, 255]       ,
                                            -hasmaximize => 0                     ,
                                            -hasminimize => 0                     ,
                                            -helpbutton  => 0                     ,
                                            -resizable   => 0                     ,
                                            -topmost     => 1                     ,
                                            -dialogui    => 1                     , );
$winConfig->SetIcon($winICO);

$winConfig->AddLabel(     -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $configBmp            ,
                          -background   => [255, 255, 255]       , );

# Tabstrip
$winConfig->AddTabStrip(            -name         => 'configTab'           ,
                                    -size         => [500,260]             ,
                                    -pos          => [140,  5]             ,
                                    -fixedwidth   => 1                     ,
                                    -tabstop      => 1                     ,
                                    -background   => [255, 255, 255]       , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblGenOpt'}     , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblScrollOpt'}  , );
$winConfig->configTab->InsertItem(  -text         => $STR{'lblExpOpt'}     , );
$winConfig->configTab->SetItemSize(126,20);

# General options
# Tool Section
$winConfig->AddLabel(     -name        => 'lblTool'             ,
                          -size        => [ 80, 22]             ,
                          -pos         => [150, 38]             ,
                          -background  => [255, 255, 255]       ,
                          -foreground  => [  0, 102, 204]       ,
                          -text        => $STR{'Tool'}.':'      ,
                          -font        => $fontGB2              , );
$winConfig->AddButton(    -name        => 'btnExportLang'       ,
                          -size        => [125, 24]             ,
                          -pos         => [150, 68]             ,
                          -text        => $STR{'btnExportLang'} ,
                          -font        => $font10               ,
                          -tabstop     => 1                     , );
$winConfig->AddButton(    -name        => 'btnCheckUpdate'      ,
                          -size        => [125, 24]             ,
                          -pos         => [150, 98]             ,
                          -text        => $STR{'menu13'}        ,
                          -font        => $font10               , );
$winConfig->AddCheckbox(  -name        => 'chAutoUpdate'        ,
                          -size        => [310, 20]             ,
                          -pos         => [285,100]             ,
                          -text        => $STR{'chAutoUpdate'}  ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     , );
# Functions section
$winConfig->AddLabel(     -name        => 'lblFunctions'        ,
                          -size        => [120, 22]             ,
                          -pos         => [150,140]             ,
                          -background  => [255, 255, 255]       ,
                          -foreground  => [  0, 102, 204]       ,
                          -text        => $STR{'Functions'}.':' ,
                          -font        => $fontGB2              , );
$winConfig->AddCheckbox(  -name        => 'chRememberPos'       ,
                          -size        => [250, 20]             ,
                          -pos         => [285,140]             ,
                          -text        => $STR{'chRememberPos'} ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               , );
$winConfig->AddLabel(     -name        => 'lblTimeToWait'       ,
                          -size        => [115, 22]             ,
                          -pos         => [150,173]             ,
                          -text        => $STR{'lblTimeToWait'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddTextfield( -name        => 'tfTimeToWait'        ,
                          -size        => [ 40, 22]             ,
                          -pos         => [270,170]             ,
                          -tip         => $STR{'tfTimeToWaitTip'}, );
$winConfig->AddUpDown(    -name        => 'upTimeToWait'        ,
                          -tabstop     => 1                     , );
$winConfig->upTimeToWait->SetRange(1,10);
$winConfig->AddLabel(     -name        => 'lblTimeToWait2'      ,
                          -size        => [ 60, 22]             ,
                          -pos         => [313,173]             ,
                          -text        => $STR{'lblTimeToWait2'},
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddLabel(     -name        => 'lblNbrResume'        ,
                          -size        => [135, 22]             ,
                          -pos         => [400,173]             ,
                          -text        => $STR{'lblNbrResume'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddTextfield( -name        => 'tfNbrResume'         ,
                          -size        => [ 40, 22]             ,
                          -pos         => [540,170]             ,
                          -tip         => $STR{'tfNbrResumeTip'}, );
$winConfig->AddUpDown(    -name        => 'upNbrResume'         ,
                          -tabstop     => 1                     , );
$winConfig->upNbrResume->SetRange(1,99);
$winConfig->AddCheckbox(  -name        => 'chDelTempFiles'      ,
                          -size        => [230, 20]             ,
                          -pos         => [150,200]             ,
                          -text        => $STR{'chDelTempFiles'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     , );
$winConfig->AddCheckbox(  -name        => 'chDebugLogging'      ,
                          -size        => [200, 20]             ,
                          -pos         => [400,200]             ,
                          -text        => $STR{'chDebugLogging'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     , );
$winConfig->AddLabel(     -name        => 'lblCharset'          ,
                          -size        => [ 70, 22]             ,
                          -pos         => [150,233]             ,
                          -text        => $STR{'lblCharset'}.':',
                          -font        => $font10               ,
                          -background  => [255, 255, 255]       , );
$winConfig->AddCombobox(  -name        => 'cbCharset'           ,
                          -size        => [110,100]             ,
                          -pos         => [235,230]             ,
                          -font        => $font10               ,
                          -dropdown    => 1                     ,
                          -vscroll     => 1                     ,
                          -tabstop     => 1                     , );
$winConfig->cbCharset->Add('cp1252'     , 'iso-8859-1' , 'iso-8859-2' , 'iso-8859-3' ,
                           'iso-8859-4' , 'iso-8859-5' , 'iso-8859-6' , 'iso-8859-7' ,
                           'iso-8859-8' , 'iso-8859-9' , 'iso-8859-10', 'iso-8859-11', 
                           'iso-8859-13', 'iso-8859-14', 'iso-8859-15', 'iso-8859-16', );
$winConfig->AddButton(     -name       => 'btnOpenLog'          ,
                           -size       => [150, 24]             ,
                           -pos        => [400,230]             ,
                           -text       => $STR{'OpenLog'}       ,
                           -font       => $font10               ,
                           -visible    => 0                     , );

# Scroll options
$winConfig->AddLabel(       -name        => 'lblMaxScrollChat'    ,
                            -size        => [165, 22]             ,
                            -pos         => [150, 48]             ,
                            -text        => $STR{'lblMaxLoading'}.':',
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -visible     => 0                     , );
$winConfig->AddRadioButton( -name        => 'rbMaxScrollChatByPage',
                            -size        => [100, 22]             ,
                            -pos         => [320, 45]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByPage'}.':' ,
                            -font        => $font10               ,
                            -checked     => 1                     ,
                            -group       => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddTextfield(   -name        => 'tfMaxScrollChat'     ,
                            -size        => [ 40, 22]             ,
                            -pos         => [425, 45]             ,
                            -tip         => $STR{'tfMaxScrollByPageTip'},
                            -number      => 1                     ,
                            -tabstop     => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddUpDown(      -name        => 'upMaxScrollChat'     ,
                            -tabstop     => 1                     , );
$winConfig->upMaxScrollChat->SetRange(0,99);
$winConfig->AddRadioButton( -name        => 'rbMaxScrollChatByDate',
                            -size        => [100, 22]             ,
                            -pos         => [320, 75]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByDate'}.':' ,
                            -font        => $font10               ,
                            -visible     => 0                     , );
$winConfig->AddDateTime(    -name        => 'dtMaxScrollChatByDate',
                            -size        => [ 90, 22]             ,
                            -pos         => [425, 75]             ,
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -format      => 'shortdate'           ,
                            -tip         => $STR{'tfMaxScrollByDateTip'},
                            -visible     => 0                     , );
$winConfig->AddLabel(       -name        => 'lblMaxScroll'        ,
                            -size        => [165, 22]             ,
                            -pos         => [150,108]             ,
                            -text        => $STR{'lblMaxScroll'}.':',
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -visible     => 0                     , );
$winConfig->AddRadioButton( -name        => 'rbMaxScrollByPage'   ,
                            -size        => [100, 22]             ,
                            -pos         => [320,105]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByPage'}.':' ,
                            -font        => $font10               ,
                            -checked     => 1                     ,
                            -group       => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddTextfield(   -name        => 'tfMaxScroll'         ,
                            -size        => [ 40, 22]             ,
                            -pos         => [425,105]             ,
                            -tip         => $STR{'tfMaxScrollByPageTip'},
                            -number      => 1                     ,
                            -tabstop     => 1                     ,
                            -visible     => 0                     , );
$winConfig->AddUpDown(      -name        => 'upMaxScroll'         ,
                            -tabstop     => 1                     , );
$winConfig->upMaxScroll->SetRange(0,99);
$winConfig->AddRadioButton( -name        => 'rbMaxScrollByDate'   ,
                            -size        => [100, 22]             ,
                            -pos         => [320,135]             ,
                            -background  => [255, 255, 255]       ,
                            -text        => $STR{'rbMaxScrollByDate'}.':' ,
                            -font        => $font10               ,
                            -visible     => 0                     , );
$winConfig->AddDateTime(    -name        => 'dtMaxScrollByDate'   ,
                            -size        => [ 90, 22]             ,
                            -pos         => [425,135]             ,
                            -font        => $font10               ,
                            -background  => [255, 255, 255]       ,
                            -format      => 'shortdate'           ,
                            -tip         => $STR{'tfMaxScrollByDateTip'},
                            -visible     => 0                     , );
$winConfig->AddCheckbox(    -name        => 'chOptScrollTop'      ,
                            -size        => [310, 20]             ,
                            -pos         => [150,170]             ,
                            -text        => $STR{'chOptScrollTop'},
                            -background  => [255, 255, 255]       ,
                            -font        => $font10               ,
                            -tabstop     => 1                     ,
                            -checked     => 1                     , );

# Expand options
$winConfig->AddCheckbox(  -name        => 'chOptSeemore'        ,
                          -size        => [200, 20]             ,
                          -pos         => [150, 35]             ,
                          -text        => $STR{'chOptSeemore'}  ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptComments'       ,
                          -size        => [305, 20]             ,
                          -pos         => [150, 60]             ,
                          -text        => $STR{'chOptComments'} ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptPosts'          ,
                          -size        => [200, 20]             ,
                          -pos         => [150, 85]             ,
                          -text        => $STR{'chOptPosts'}    ,
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );
$winConfig->AddCheckbox(  -name        => 'chOptTranslate'      ,
                          -size        => [200, 20]             ,
                          -pos         => [150,110]             ,
                          -text        => $STR{'chOptTranslate'},
                          -background  => [255, 255, 255]       ,
                          -font        => $font10               ,
                          -tabstop     => 1                     ,
                          -checked     => 1                     ,
                          -visible     => 0                     , );

#------------------------------------------------------------------------------#
# Progress window
#------------------------------------------------------------------------------#
my $winPb = Win32::GUI::DialogBox->new( -name        => 'winPb'                   ,
                                        -parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]			,
                                        -size        => [740, 180]                ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -topmost     => 1                         ,
                                        -dialogui    => 1                         , );
$winPb->SetIcon($winICO);

$winPb->AddLabel(       -name        => 'lblLogo'        ,
                        -size        => [128,128]        ,
                        -pos         => [  0, 10]        ,
                        -bitmap      => $logoBmp         ,
                        -background  => [255, 255, 255]  , );
$winPb->AddLabel(       -name        => 'lblPbCurr1'     ,
                        -size        => [578, 22]        ,
                        -pos         => [140,  8]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb1'       ,
                        -size        => [470, 22]        ,
                        -pos         => [140, 32]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount1'      ,
                        -size        => [100, 22]        ,
                        -pos         => [620, 33]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddLabel(       -name        => 'lblPbCurr2'     ,
                        -size        => [578, 22]        ,
                        -pos         => [140, 60]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddProgressBar( -name        => 'pbWinPb2'       ,
                        -size        => [470, 22]        ,
                        -pos         => [140, 84]        ,
                        -smooth      => 1                , );
$winPb->AddLabel(       -name        => 'lblCount2'      ,
                        -size        => [100, 22]        ,
                        -pos         => [620, 85]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb->AddButton(      -name        => 'btnCancel'      ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [330,115]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Simple Progress window
#------------------------------------------------------------------------------#
my $winPb2 = Win32::GUI::DialogBox->new(-name        => 'winPb2'                  ,
                                        -parent      => $win                      ,
                                        -text        => $STR{'winPb'}             ,
                                        -pos         => [$winPosX, $winPosY]			,
                                        -size        => [590,175]                 ,
                                        -background  => [255, 255, 255]           ,
                                        -hasmaximize => 0                         ,
                                        -hasminimize => 1                         ,
                                        -helpbutton  => 0                         ,
                                        -resizable   => 0                         ,
                                        -topmost     => 1                         ,
                                        -dialogui    => 1                         , );
$winPb2->SetIcon($winICO);

$winPb2->AddLabel(      -name        => 'lblLogo'        ,
                        -size        => [128,128]        ,
                        -pos         => [  0,  5]        ,
                        -bitmap      => $logoBmp         ,
                        -background  => [255, 255, 255]  , );
$winPb2->AddLabel(      -name        => 'lblPbCurr'      ,
                        -size        => [350, 40]        ,
                        -pos         => [140, 30]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb2->AddLabel(      -name        => 'lblCount'       ,
                        -size        => [ 80, 22]        ,
                        -pos         => [495, 30]        ,
                        -font        => $font10          ,
                        -truncate    => 1                ,
                        -background  => [255, 255, 255]  ,
                        -foreground  => [  0,   0, 102]  , );
$winPb2->AddButton(     -name        => 'btnCancel2'     ,
                        -text        => $STR{'cancel'}   ,
                        -font        => $font10          ,
                        -size        => [ 80, 30]        ,
                        -pos         => [280, 80]        ,
                        -cancel      => 1                , );

#------------------------------------------------------------------------------#
# Starting program
#------------------------------------------------------------------------------#

# Center the splash and show it
$splash->Center();
$splash->Show();
Win32::GUI::DoEvents();

# Taskbar
$win->Tray->Change(-balloon_icon    => 'info'         ,
                   -balloon_title   => 'ExtractFace'  ,
                   -balloon_timeout => 5000           , );

# Header Dump albums grid
$winAlbums->GridAlbums->SetRows(1);
$winAlbums->GridAlbums->SetColumns(3); # 1: checkbox, 2: Album name, 3e: Album url
$winAlbums->GridAlbums->SetCellText(0, 0, ''        );
$winAlbums->GridAlbums->SetCellType(0, 0, GVIT_CHECK);
$winAlbums->GridAlbums->SetCellCheck(0, 0, 1);
$winAlbums->GridAlbums->SetCellText(0, 1, $STR{'albumNames'});
$winAlbums->GridAlbums->SetCellText(0, 2, $STR{'albumURLs'});
$winAlbums->GridAlbums->SetColumnWidth(0, 25);
$winAlbums->GridAlbums->SetColumnWidth(1, 80);
$winAlbums->GridAlbums->ExpandLastColumn();

# Header Dump friends grid
$winFriends->GridFriends->SetRows(1);
$winFriends->GridFriends->SetColumns(4); # 1: checkbox, 2: Category name, 3e: Category Id (hidden), 4e: Category url
$winFriends->GridFriends->SetCellText(0, 0, ''        );
$winFriends->GridFriends->SetCellType(0, 0, GVIT_CHECK);
$winFriends->GridFriends->SetCellCheck(0, 0, 1);
$winFriends->GridFriends->SetCellText(0, 1, $STR{'friendCat'});
$winFriends->GridFriends->SetCellText(0, 3, $STR{'url'});
$winFriends->GridFriends->SetColumnWidth(0, 25);
$winFriends->GridFriends->SetColumnWidth(1, 80);
$winFriends->GridFriends->SetColumnWidth(2, 0);
$winFriends->GridFriends->ExpandLastColumn();

&loadConfig(\%CONFIG);

# Auto-Update
if ($CONFIG{'AUTO_UPDATE'} == 1) { threads->create(sub { &checkUpdate(0); }); }

my $API = new Win32::API('user32','GetForegroundWindow','', 'N');
Win32::GUI::DoEvents();
usleep(500000);
$splash->Hide;

# Position the window
if ($winConfig->chRememberPos->Checked() and exists($CONFIG{'MAIN_LEFT'}) and exists($CONFIG{'MAIN_TOP'})) {
  $win->Left($CONFIG{'MAIN_LEFT'});
  $win->Top($CONFIG{'MAIN_TOP'});
}

$START = 1;
if (!$CONFIG{'START_MINIMIZED'}) { $win->Show(); }
Win32::GUI::Dialog();

#--------------------------#
sub chStartMinimized_Click
#--------------------------#
{
  # Save the choice
  if ($win->chStartMinimized->Checked()) {
    $CONFIG{'START_MINIMIZED'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'START_MINIMIZED'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chStartMinimized_Click

#--------------------------#
sub main_Terminate
#--------------------------#
{
  $win->Disable();  # Act as minimize, to quit, user must use the taskbar function
  $win->Hide();
  if ($THR and $THR->is_running()) { $win->Tray->ShowBalloon(); }
  return(0);

}  #--- End main_Terminate

#--------------------------#
sub main_Quit
#--------------------------#
{
  $win->Tray->Remove();
  
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft          = $win->AbsLeft();
    my $winTop           = $win->AbsTop();
    $CONFIG{'MAIN_LEFT'} = $winLeft;
    $CONFIG{'MAIN_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  -1; # Exit signal

}  #--- End main_Quit

#--------------------------#
sub main_Minimize
#--------------------------#
{
  $win->Disable();
  $win->Hide();
  if ($THR and $THR->is_running()) { $win->Tray->ShowBalloon(); }
  return(0);

}  #--- End main_Minimize

#--------------------------#
sub Tray_DblClick
#--------------------------#
{
  $win->Enable();
  $win->Show();  

}  #--- End Tray_DblClick

#--------------------------#
sub Tray_RightClick
#--------------------------#
{
  $win->TrackPopupMenu($trayMenu->{SysTray});
  return(1);

}  #--- End Tray_Click

#--------------------------#
sub scroll
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&scrollThr, $nbrRetries, $count);
  }
}  #--- End scroll

#--------------------------#
sub scrollThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollThr, $nbrRetries, $count);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center($win);
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
    &scrollToBottom(\$mech, $CONFIG{'TIME_TO_WAIT'}, $count);
    
    # Scroll to the top
    if ($winConfig->chOptScrollTop->Checked()) { $mech->eval_in_page('window.scrollTo(0,0)'); }
    
    $win->Tray->Change(-tip => $STR{'scrollTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
    $win->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End scrollThr

#--------------------------#
sub expand
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    if ($winConfig->chOptSeemore->Checked()  or $winConfig->chOptPosts->Checked()    or
        $winConfig->chOptComments->Checked() or $winConfig->chOptTranslate->Checked()) {
      # Start the thread
      my $nbrRetries = 0;
      $THR = threads->create(\&expandThr, $nbrRetries);
    } else { Win32::GUI::MessageBox($win, $STR{'warn2'}, $STR{'warn2T'}, 0x40010); }
  }
}  #--- End expand

#--------------------------#
sub expandThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'expandTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&expandThr, $nbrRetries);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'expandTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center($win);
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'expandTaskP'}.'...');
    &expandContent(\$mech);
    &expandContent(\$mech); # Do it again
    
    $win->Tray->Change(-tip => $STR{'expandTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'expandTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
    $win->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End expandThr

#--------------------------#
sub scrollExpand
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $status     = 0; # If status == 1, scrolling finished
    my $count      = 0;
    $THR = threads->create(\&scrollExpandThr, $nbrRetries, $status, $count);
  }
}  #--- End scrollExpand

#--------------------------#
sub scrollExpandThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $status, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrExpTaskC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->Tray->Change(-tip => 'ExtractFace');
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollExpandThr, $nbrRetries, $status, $count);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
      }
    }
    threads->exit();
  };
  
  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollTaskP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center($win);
    $winPb2->Show();
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  if ($mech->uri() =~ /facebook.com/) {
    # Show starting of the process
    $win->Tray->Change(-tip => $STR{'scrollTaskP'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollTaskP'} , );
      $win->Tray->ShowBalloon(1);
    }
    
    # Scroll one page at a time and expand until end of page is reached
    $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
    my $maxScrollByDate = $winConfig->rbMaxScrollByDate->Checked();
    my $maxDate;
    my $maxScroll;
    if ($maxScrollByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScroll = $winConfig->tfMaxScroll->Text(); }
   
    my $end = &scrollPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
    $count++;
    while (!$end) { # If $end == 1, we reached the end of the page
      # Expand
      if ($winConfig->chOptSeemore->Checked()  or $winConfig->chOptPosts->Checked()    or
          $winConfig->chOptComments->Checked() or $winConfig->chOptTranslate->Checked()) {
        # Expand all additional content
        $winPb2->lblPbCurr->Text($STR{'expandTaskP'}.'...');
        $win->Tray->Change(-tip => $STR{'expandTaskP'}.'...');
        &expandContent(\$mech);
        &expandContent(\$mech); # Do it again
      }
      
      # Scroll again
      $winPb2->lblPbCurr->Text($STR{'scrollTaskP'}.'...');
      if ($maxScrollByDate and $maxDate) { # Stop by date
        my $lastDisplayedDate = ($mech->selector('a._5pcq abbr'))[-1];
        if ($lastDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
          my $date = $1;
          if ($date <= $maxDate) { last; }
        }
      } elsif ($maxScroll and $count >= $maxScroll) { last; } # Stop by page
      $end = &scrollPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
      $count++;
    }
    
    # Scroll to the top
    if ($winConfig->chOptScrollTop->Checked()) { $mech->eval_in_page('window.scrollTo(0,0)'); }
    
    $win->Tray->Change(-tip => $STR{'expandTaskF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrExpTaskF'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;
  $win->ChangeCursor($ARROW);

}  #--- End scrollExpandThr

#--------------------------#
sub winAlbums_Resize
#--------------------------#
{
  if ($START) {
    $winAlbums->tfAlbumTitle->Width($winAlbums->ScaleWidth()-320);
    $winAlbums->chAlbumGroup->Left($winAlbums->ScaleWidth()-95);
    $winAlbums->tfDirSaveAlbums->Width($winAlbums->ScaleWidth()-320);
    $winAlbums->btnDirSaveAlbums->Left($winAlbums->ScaleWidth()-97);
    $winAlbums->btnBrowseDirSaveAlbums->Left($winAlbums->ScaleWidth()-73);
    $winAlbums->lblInProgress->Left($winAlbums->ScaleWidth()-283);
    $winAlbums->btnAlbumsRefresh->Left($winAlbums->ScaleWidth()-25);
    $winAlbums->GridAlbums->Width($winAlbums->ScaleWidth()-144);
    $winAlbums->GridAlbums->Height($winAlbums->ScaleHeight()-205);
    $winAlbums->GridAlbums->AutoSize();
    $winAlbums->GridAlbums->ExpandLastColumn();
    $winAlbums->lblAlbumsOpt->Top($winAlbums->ScaleHeight()-97);
    $winAlbums->chPublishDate->Top($winAlbums->ScaleHeight()-98);
    $winAlbums->chAlbumsOpenHTML->Top($winAlbums->ScaleHeight()-98);
    $winAlbums->chAlbumsOpenDir->Top($winAlbums->ScaleHeight()-98);
    $winAlbums->lblPicturesSize->Top($winAlbums->ScaleHeight()-67);
    $winAlbums->cbPicturesSize->Top($winAlbums->ScaleHeight()-70);
    $winAlbums->btnAlbumsOk->Left(($winAlbums->ScaleWidth()/2));
    $winAlbums->btnAlbumsOk->Top($winAlbums->ScaleHeight()-35);
  }

}  #--- End winAlbums_Resize

#--------------------------#
sub winAlbumsNormal
#--------------------------#
{
  $winAlbums->chAlbumGroup->Checked(0);
  &winAlbums();
  
}  #--- End winAlbumsNormal

#--------------------------#
sub winGroupAlbums
#--------------------------#
{
  $winAlbums->chAlbumGroup->Checked(1);
  &winAlbums();
  
}  #--- End winGroupAlbums

#--------------------------#
sub winAlbums
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    &winAlbums_Resize();
    $winAlbums->tfAlbumTitle->Text('');
    $winAlbums->GridAlbums->DeleteNonFixedRows();
    
    # Start the thread
    $THR = threads->create(\&winAlbumsThr);
    
    usleep(500000);
    $winAlbums->GridAlbums->AutoSize();
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINALBUMS_LEFT'} and $CONFIG{'WINALBUMS_TOP'}) {
      $winAlbums->Left($CONFIG{'WINALBUMS_LEFT'});
      $winAlbums->Top($CONFIG{'WINALBUMS_TOP'});
    } else { $winAlbums->Center(); }
    $winAlbums->DoModal();
  }

}  #--- End winAlbums

#--------------------------#
sub btnAlbumsRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winAlbums->tfAlbumTitle->Text('');
    $winAlbums->GridAlbums->DeleteNonFixedRows();
    
    # Start the thread
    $THR = threads->create(\&winAlbumsThr);
  }
  
}  #--- End btnAlbumsRefresh_Click

#--------------------------#
sub winAlbumsThr
#--------------------------#
{
  # Local variables
  my $tempDir = "$USERDIR\\temp";
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winAlbumsThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
			my $err = (split(/ at /, $msgErr))[0];
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winAlbums, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
			threads->exit();
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winAlbums->btnAlbumsOk->Disable();
      Win32::GUI::MessageBox($winAlbums, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Gather album names
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    $winAlbums->ChangeCursor($HOURGLASS);
    &validAlbumPage(\$mech);

    # Get album names and urls
    my %albums;
    my @albums;
    if ($winAlbums->chAlbumGroup->Checked()) { @albums = $mech->selector('div._3hpt._2pif a');                            }
    else                                     { @albums = $mech->selector('td._51m-.vTop.hLeft.pbm.prm a.photoTextTitle'); }
    foreach my $album (@albums) {
      my $albumName = $album->{innerHTML};
      $albumName   =~ s/<[^\>]+>//g;
      $albumName   = encode($CONFIG{'CHARSET'}, $albumName);
      my $albumUrl = $album->{href};
      $albums{$albumName} = $albumUrl;
    }
    
    # Feed the Album Grid
    $winAlbums->GridAlbums->SetCellCheck(0, 0, 1);
    foreach my $albumName (sort keys %albums) {
      if (exists($albums{$albumName}) and my $i = $winAlbums->GridAlbums->InsertRow($albumName, -1)) {
        $winAlbums->GridAlbums->SetCellText($i, 0, ''        );
        $winAlbums->GridAlbums->SetCellType($i, 0, GVIT_CHECK);
        $winAlbums->GridAlbums->SetCellCheck($i, 0, 1);
        $winAlbums->GridAlbums->SetCellText($i, 1, $albumName);
        $winAlbums->GridAlbums->SetCellText($i, 2, $albums{$albumName});
        $winAlbums->GridAlbums->AutoSize();
        $winAlbums->GridAlbums->Refresh();
      }
    }
    
    $winAlbums->lblInProgress->Text('');
    $winAlbums->ChangeCursor($ARROW);
  } else { Win32::GUI::MessageBox($winAlbums, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Ready ?
  &isDumpAlbumsReady();

}  #--- End winAlbumsThr

#--------------------------#
sub validAlbumPage
#--------------------------#
{
  # Local variables
  my ($refMech) = @_;
  
  my $currURL = $$refMech->uri();
  my $currTitle;
  if ($currURL !~ /photos_albums$/ and $currURL !~ /collection_token=\w+%\w+%3A6$/) {
    # Trying to get the good page
    if ($winAlbums->chAlbumGroup->Checked() and $currURL =~ /https:\/\/www.facebook.com\/([^\/]+)/) { # Album from a Group page
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      my $goodURL = "https://www.facebook.com/$1/photos/?tab=albums";
      ($currURL, $currTitle) = &loadPage($refMech, $goodURL);
    } elsif ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) {
      my $profilID = $1;
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      my $goodURL = "https://www.facebook.com/profile.php?id=$profilID&sk=photos&collection_token=$profilID%3A2305272732%3A6";
      ($currURL, $currTitle) = &loadPage($refMech, $goodURL);
    } elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/]+)/) {
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      my $goodURL = "https://www.facebook.com/$1/photos_albums";
      ($currURL, $currTitle) = &loadPage($refMech, $goodURL);
    }
    
    # Re evaluate current page
    if (($currURL !~ /photos_albums$/ and $currURL !~ /collection_token=\w+%\w+%3A6$/) and $currURL !~ /photos\/\?tab=albums/ or
        $currTitle =~ /Page Not Found/) {
      $winAlbums->btnAlbumsOk->Disable();
      Win32::GUI::MessageBox($winAlbums, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    } else {
      $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
      &scrollPage($refMech, $CONFIG{'TIME_TO_WAIT'});
    }
  # You are in the right page, scroll down to load the whole page
  } else {
    if ($currURL and $currURL =~ /https:\/\/www.facebook.com\//) {
      if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
      elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
    }
    $winAlbums->lblInProgress->Text($STR{'loadAlbum'}.'...');
    &scrollPage($refMech, $CONFIG{'TIME_TO_WAIT'});
  }
  
  # Write title (used for HTML Album)
  if ($currTitle) {
    if ($currTitle =~ /#$/) { chop($currTitle); }
    $currTitle .= " - Albums";
    $winAlbums->tfAlbumTitle->Text($currTitle);
  }

}  #--- End validAlbumPage

#--------------------------#
sub tfDirSaveAlbums_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
  
  # Remember
  if ($saveDir and -d $saveDir and $winAlbums->chSaveAlbumDir->Checked()) {
      $CONFIG{'DIR_SAVE_ALBUMS'} = $saveDir;
      &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpAlbumsReady();

}  #--- End tfDirSaveAlbums_Change

#--------------------------#
sub btnDirSaveAlbums_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winAlbums->tfDirSaveAlbums->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winAlbums     ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winAlbums     ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winAlbums->tfDirSaveAlbums->Text($dir);
  }
  
}  #--- End btnDirSaveAlbums_Click

#--------------------------#
sub btnBrowseDirSaveAlbums_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winAlbums->tfDirSaveAlbums->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveAlbums_Click

#--------------------------#
sub chSaveAlbumDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winAlbums->tfDirSaveAlbums->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winAlbums->chSaveAlbumDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_ALBUMS'} = 1;
    $CONFIG{'DIR_SAVE_ALBUMS'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winAlbums->chSaveAlbumDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_ALBUMS'} = 0;
    delete($CONFIG{'DIR_SAVE_ALBUMS'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveAlbumDir_Click

#--------------------------#
sub GridAlbums_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  
  # Select
  if (!$column) {
    my $selStatus = $winAlbums->GridAlbums->GetCellCheck($row, $column);
    if (!$row) {
      # Check all
      if (!$selStatus) { for (my $i = 0; $i < $winAlbums->GridAlbums->GetRows(); $i++) { $winAlbums->GridAlbums->SetCellCheck($i, 0, 1); } }
      # Uncheck all
      else             { for (my $i = 0; $i < $winAlbums->GridAlbums->GetRows(); $i++) { $winAlbums->GridAlbums->SetCellCheck($i, 0, 0); } }
    } else {
      # Check
      if (!$selStatus) { $winAlbums->GridAlbums->SetCellCheck($row, $column, 1); }
      # Uncheck
      else             { $winAlbums->GridAlbums->SetCellCheck($row, $column, 0); }
    }
  }
  
  return(1);

}  #--- End GridAlbums_Click

#--------------------------#
sub chPublishDate_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chPublishDate->Checked()) {
    $CONFIG{'ALBUMS_PUBLISH_DATE'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_PUBLISH_DATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chPublishDate_Click

#--------------------------#
sub chAlbumsOpenHTML_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chAlbumsOpenHTML->Checked()) {
    $CONFIG{'ALBUMS_OPEN_HTML'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_OPEN_HTML'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAlbumsOpenHTML_Click

#--------------------------#
sub chAlbumsOpenDir_Click
#--------------------------#
{
  # Save the choice
  if ($winAlbums->chAlbumsOpenDir->Checked()) {
    $CONFIG{'ALBUMS_OPEN_DIR'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'ALBUMS_OPEN_DIR'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAlbumsOpenDir_Click

#--------------------------#
sub isDumpAlbumsReady
#--------------------------#
{
  # Local variables
  my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
  
  # Valid directory for save ?
  if (!$saveDir or !(-d $saveDir)) { $winAlbums->btnAlbumsOk->Disable(); return(0); }
  
  # Albums name loaded and at least one checked ?
  my $albumChecked = 0;
  for (my $i = 1; $i < $winAlbums->GridAlbums->GetRows(); $i++) {
    my $selStatus = $winAlbums->GridAlbums->GetCellCheck($i, 0);
    if ($selStatus == 1) {
      $albumChecked = 1;
      last;
    }
  }
  if (!$albumChecked) { $winAlbums->btnAlbumsOk->Disable(); return(0); }
  
  $winAlbums->btnAlbumsOk->Enable();

}  #--- End isDumpAlbumsReady

#--------------------------#
sub btnAlbumsOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winAlbums->AbsLeft();
      my $winTop  = $winAlbums->AbsTop();
      $CONFIG{'WINALBUMS_LEFT'} = $winLeft;
      $CONFIG{'WINALBUMS_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    my $saveDir = $winAlbums->tfDirSaveAlbums->Text();
    my $mainAlbumTitle	= $winAlbums->tfAlbumTitle->Text();
    $mainAlbumTitle			=~ s/[\<\>\:\"\/\\\|\?\*]/_/g;
    my %listAlbums; 		# Album names and urls
    my %listPics; 			# Album, File path, Publication date, Urls, and index (position of the picture in the album)
    my $nbrAlbums				= 0;
    my $posPb1          = 0;
    my $nbrRetries      = 0;
    my $tabCurrentTitle;
    
    if (-d $saveDir and $mainAlbumTitle) {
      # Start the thread
      $THR = threads->create(\&dumpAlbums, $saveDir, $mainAlbumTitle, \%listAlbums, \%listPics,
                             $nbrAlbums, $tabCurrentTitle, $posPb1, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err4'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnAlbumsOk_Click

#--------------------------#
sub dumpAlbums
#--------------------------#
{
  # Local variables
  my ($saveDir, $mainAlbumTitle, $refListAlbums, $refListPics, $nbrAlbums, $tabCurrentTitle, $posPb1, $nbrRetries) = @_;
  my $firstExec = 0;
  my $FG_size   = $winAlbums->cbPicturesSize->GetCurSel(); # Possible values are: 0 = small size only, 1 = medium size, 2 = Full size
  
  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpAlbumC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $posPb1 = $winPb->pbWinPb1->GetPos();
    $winPb->pbWinPb2->SetPos(0);
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpAlbums, $saveDir, $mainAlbumTitle, $refListAlbums, $refListPics,
                             $nbrAlbums, $tabCurrentTitle, $posPb1, $nbrRetries);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
			Win32::GUI::MessageBox($winPb, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
			$winPb->lblPbCurr1->Text('');
			$winPb->lblCount1->Text('');
			$winPb->lblPbCurr2->Text('');
			$winPb->lblCount2->Text('');
			$winPb->pbWinPb1->SetPos(0);
			$winPb->pbWinPb2->SetPos(0);
			&winPb_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };
  
  # First execution, must gather album names and urls
  if (!$posPb1 and !$nbrAlbums) {
    $firstExec = 1;
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpAlbumP'}.'...');
    for (my $i = 1; $i < $winAlbums->GridAlbums->GetRows(); $i++) {
      my $selStatus = $winAlbums->GridAlbums->GetCellCheck($i, 0);
      if ($selStatus == 1) {
        my $albumName = decode($CONFIG{'CHARSET'}, $winAlbums->GridAlbums->GetCellText($i, 1));
        my $albumURL  = $winAlbums->GridAlbums->GetCellText($i, 2);
        $$refListAlbums{$albumName}{'url'}  = $albumURL;
        $$refListAlbums{$albumName}{'name'} = $albumName;
      }
    }
    # Number of album
    $nbrAlbums = keys %{$refListAlbums};
  }
  
  if ($nbrAlbums > 0) {
    my $count1;
    
    # First execution, turn on the progress window
    if ($firstExec == 1) {
      # Turn on progress bar
      $winPb->Center($winAlbums);
      $winPb->Show();
      $win->Disable();
      $winPb->pbWinPb1->SetRange(0, $nbrAlbums);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      $count1 = 0;
    # If on resume state, get number of albums left
    } else {
      my $nbrCurrAlbums = keys %{$refListAlbums};
      $count1 = $nbrAlbums - $nbrCurrAlbums;
    }
    
    # Parse each album
    foreach my $album (sort keys %{$refListAlbums}) {
      my $encodedName = encode($CONFIG{'CHARSET'}, $$refListAlbums{$album}{name});
      my @listVideos;
      
      $winPb->lblPbCurr1->Text("$STR{'opening'}: $encodedName");
      $winPb->lblCount1->Text("$count1/$nbrAlbums");
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      
      my $albumDir;
      if    ($winAlbums->chAlbumGroup->Checked() and $$refListAlbums{$album}{'url'} =~ /\&album_id=(\d+)/) { $albumDir = $1; }
      elsif ($$refListAlbums{$album}{'url'} =~ /\?set=([^\&]+)&/                                         ) { $albumDir = $1; }
      if (!$albumDir) { $albumDir = $count1; }
      $$refListAlbums{$album}{'dir'} = $albumDir;
      
      # Gather album page
      my $mechAlbum = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
      if (!exists($$refListAlbums{$album}{'nbrPics'}) and !exists($$refListAlbums{$album}{'nbrVideos'})) {
        if (!-d "$saveDir\\$mainAlbumTitle"                 ) { mkdir("$saveDir\\$mainAlbumTitle");                  }
        if (!-d "$saveDir\\$mainAlbumTitle\\$albumDir"      ) { mkdir("$saveDir\\$mainAlbumTitle\\$albumDir");       }
        if (!-d "$saveDir\\$mainAlbumTitle\\$albumDir\\temp") { mkdir("$saveDir\\$mainAlbumTitle\\$albumDir\\temp"); }
        $mechAlbum->get($$refListAlbums{$album}{'url'}, synchronize => 0);
        $winPb->lblPbCurr1->Text("$STR{'scrolling'}: $encodedName");
        sleep($CONFIG{'TIME_TO_WAIT'});
        if      ($winAlbums->chAlbumGroup->Checked()) { &scrollPage(\$mechAlbum, $CONFIG{'TIME_TO_WAIT'});      }
        else                                          { &scrollAlbumPage(\$mechAlbum, $CONFIG{'TIME_TO_WAIT'}); }
      }
      my $albumPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\temp\\album.html";
      my $status = $mechAlbum->save_content($albumPath, "$saveDir\\$mainAlbumTitle\\$albumDir\\temp");
      while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
      $winPb->lblPbCurr1->Text("$STR{'parsing'}: $encodedName");
      
      # Video album
      if ($$refListAlbums{$album}{'url'} =~ /set=vb/ and -T $albumPath and open(my $fhTemp, "<:encoding(UTF-8)", $albumPath)) {
        my %listVideos;
        my %videoNames;
        
        # Gather video urls and corresponding preview picture urls
        my $file_as_string = do { local $/ = <$fhTemp> };
        close($fhTemp);
        $file_as_string =~ s/[\r\n]//g;
        my $section     = (split(/function\(Bootloader\)/, $file_as_string))[0];
        $file_as_string = undef;
        my @parts       = split(/data-starred-src=/, $section);
        $section        = undef;
        shift(@parts);
        foreach my $part (@parts) {
          if ($part =~ /^"([^\"]+)" /) {
            my $picURL = $1;
            $picURL    =~ s/&amp;/&/g;
            if ($part =~ /href="([^\"]+)"/) {
              my $videoPageURL = $1;
              if ($videoPageURL =~ /\/([^\/]+)\/\?type=/) {
                my $vd = $1;
                if (!exists($videoNames{$vd})) {
                  $videoNames{$vd} = 1;
                  if ($videoPageURL !~ /^http/) { $videoPageURL = 'https://www.facebook.com'.$videoPageURL; }
                  $videoPageURL =~ s/&amp;/&/g;
                  $listVideos{$videoPageURL} = $picURL;
                }
              }
            }
          }
        }
        @parts = ();
        $$refListAlbums{$album}{'nbrVideos'} = keys %listVideos;
        
        # Gather preview picture
        if ($$refListAlbums{$album}{'nbrVideos'} > 0) {
          my $count2 = 0;
          $winPb->pbWinPb2->SetRange(0, $$refListAlbums{$album}{'nbrVideos'});
          $winPb->pbWinPb2->SetPos(0);
          $winPb->pbWinPb2->SetStep(1);
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          foreach my $videoPage (keys %listVideos) {
            my $pic;
            if ($listVideos{$videoPage} =~ /\/([^\/\?]+)(?:\?|$)/) {
              my $pic = $1;
              my $picPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$pic";
              $winPb->lblPbCurr2->Text("$STR{'downloading'}: $pic");
              # Download the picture if does not exist
              $$refListPics{$album}{$videoPage}{'ind'}          = $count2;
              $$refListPics{$album}{$videoPage}{'smallPicName'} = $pic;
              $$refListPics{$album}{$videoPage}{'picPath'}      = $picPath;
              if (!-e $picPath) {
                $mechAlbum->save_url($listVideos{$videoPage}, $picPath);
              }
              $count2++;
              $winPb->pbWinPb2->StepIt();
              $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
            }
          }
        
          # Gather videos
          $count2 = 0;
          $winPb->pbWinPb2->SetPos(0);
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          foreach my $videoPage (keys %listVideos) {
            if ($videoPage =~ /vb\.[^\/]+\/([^\/]+)/) {
              # Gather page with the video
              $winPb->lblPbCurr2->Text("$STR{'opening'}: $videoPage");
              my $videoName = $1;
              my $videoPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$videoName.mp4";
              my $mechVideo;
              if (!-e $videoPath or $winAlbums->chPublishDate->Checked) {
                # Open the video page
                if ($tabCurrentTitle) {
                  $mechVideo = WWW::Mechanize::Firefox->new(tab => qr{$tabCurrentTitle}, create => 1, autodie => 0);
                } else { $mechVideo = WWW::Mechanize::Firefox->new(create => 1, autodie => 0); }
                $mechVideo->get($videoPage, synchronize => 0);
                sleep($CONFIG{'TIME_TO_WAIT'});
                $tabCurrentTitle = $mechVideo->title;
                
                # Save the page content
                my $pagePath = "$saveDir\\$mainAlbumTitle\\$albumDir\\temp\\page.html";
                my $status   = $mechVideo->save_content($pagePath);
                while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
                
                # Load content from file
                if (-T $pagePath and open(my $fhTemp, "<:encoding(UTF-8)", $pagePath)) {
                  my $file_as_string = do { local $/ = <$fhTemp> };
                  $file_as_string    =~ s/[\r\n]//g;
                  close($fhTemp);
                  my @sections       = (split(/<video/, $file_as_string));
                  $file_as_string    = undef;
                  if ($sections[1] =~ /src="([^\"]+)/) {
										my $videoURL = $1;
										# Get the publication date
										if ($winAlbums->chPublishDate->Checked and
												($sections[0] =~ /data-utime="([^\"]+)"[^\>]+class="_5ptz"/ or
												 ($sections[0] =~ /class="_5ptz"[^\>]+data-utime="([^\"]+)/))) {
											$$refListPics{$album}{$videoPage}{'pubDate'} = $1;
										}
										# Download the video
										if ($videoURL =~ /\.mp4/) {
											$videoURL    =~ s/&amp;/&/g;
											$winPb->lblPbCurr2->Text("$STR{'downloading'}: $videoURL");
											if (!-e $videoPath) {
												$mechAlbum->save_url($videoURL, $videoPath); } # Download video
											$$refListPics{$album}{$videoPage}{'videoPath'} = $videoPath;
										}
                  }
                }
                $mechVideo = undef;
              # Already exists
              } elsif (-e $videoPath) { $$refListPics{$album}{$videoPage}{'videoPath'} = $videoPath; }
            }
            
            # Update progress
            $count2++;
            $winPb->pbWinPb2->StepIt();
            $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrVideos'}");
          }
        }
      # Picture album
			} else {
        
        # Facebook Group profile
        if    ($winAlbums->chAlbumGroup->Checked()) {
          # Load content from file
          if (-T $albumPath and open(my $fhTemp, "<:encoding(UTF-8)", $albumPath)) {
            my $file_as_string = do { local $/ = <$fhTemp> };
            $file_as_string    =~ s/[\r\n]//g;
            close($fhTemp);
            my $section     = (split(/function\(Bootloader\)/, $file_as_string))[0];
            my @parts       = split(/_2eea/, $file_as_string);
            $file_as_string = undef;
            shift(@parts);
            my $i = 0;
            foreach (@parts) {
              my $url;
              my $fname;
              if (/href=\"([^\"]+)/) { $url   = $1; }
              if (/src=\"([^\"]+)/ ) { $fname = $1; }
              if ($url and $fname) {
                $$refListPics{$album}{$url}{'ind'}          = $i++;
                $$refListPics{$album}{$url}{'smallPicName'} = $fname;
                rcopy("$saveDir\\$mainAlbumTitle\\$albumDir\\temp\\$fname", "$saveDir\\$mainAlbumTitle\\$albumDir\\$fname"); # Copy image
              }
            }
          }
        }
        
        # Normal user profile
        else {
          # Load content from file
          if (-T $albumPath and open(my $fhTemp, "<:encoding(UTF-8)", $albumPath)) {
            my $file_as_string = do { local $/ = <$fhTemp> };
            $file_as_string    =~ s/[\r\n]//g;
            close($fhTemp);
            my $section1       = (split(/function\(Bootloader\)/, $file_as_string))[0];
            $file_as_string    = undef;
            my $section2       = (split(/fbTimelineStarGridSeparator/, $section1))[0];
            $section1          = undef;
            my @parts          = split(/data-starred-src=/, $section2);
            $section2          = undef;
            shift(@parts);
            my $i = 0;
            foreach my $part (@parts) {
              if ($part =~ /^"([^\"]+)"/) {
                my $picURL  = $1;
                $picURL     =~ s/&amp;/&/g;
                if ($part =~ /ajaxify="([^\"]+)"/) {
                  my $picPage = $1;
                  $picPage    =~ s/&amp;/&/g;
                  $$refListPics{$album}{$picURL}{'ind'} = $i++;
                  if ($picPage) { $$refListPics{$album}{$picURL}{'picPage'} = $picPage; }
                  else          { $$refListPics{$album}{$picURL}{'picPage'} = 0; }
                }
                # The small picture
                if (!$FG_size and $part =~ /data-non-starred-src="([^\"]+)"/) {
                  my $smallPicUrl = $1;
                  $smallPicUrl    =~ s/&amp;/&/g;
                  $$refListPics{$album}{$picURL}{'smallPicUrl'} = $smallPicUrl;
                }
              }
            }
          }
        }
        
        # Gather pictures
        $$refListAlbums{$album}{'nbrPics'} = (keys %{$$refListPics{$album}});
        if ($$refListAlbums{$album}{'nbrPics'} > 0) {
          $winPb->pbWinPb2->SetRange(0, $$refListAlbums{$album}{'nbrPics'});
          $winPb->pbWinPb2->SetPos(0);
          $winPb->pbWinPb2->SetStep(1);
          my $count2 = 0;
          $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrPics'}");
          foreach (sort {$$refListPics{$album}{$a}{'ind'} <=> $$refListPics{$album}{$b}{'ind'}} keys %{$$refListPics{$album}}) {
            my $picURL = $_;
            my $picOk  = 0;
            if ($$refListPics{$album}{$picURL}{'picPath'} and -e $$refListPics{$album}{$picURL}{'picPath'}) {
              # If picture exists, verify integrity
              my $info = image_info($$refListPics{$album}{$picURL}{'picPath'});
              if (!$info->{error}) { $picOk = 1; }
            }
            
            # Facebook group - Pics
            if (!$picOk and $winAlbums->chAlbumGroup->Checked()) {
              my $picName = $$refListPics{$album}{$picURL}{'smallPicName'};
              $winPb->lblPbCurr2->Text("$STR{'downloading'}: $picName");
              my $bigSizePicUrl;
              my $mediumSizePicUrl;
              my $publishDate;
              
              # If we must gather the publication date
              if ($winAlbums->chPublishDate->Checked or $FG_size) {
                # Open the picture page
                my $mechPic;
                if ($tabCurrentTitle) {
                  $mechPic = WWW::Mechanize::Firefox->new(tab => qr{$tabCurrentTitle}, create => 1, autodie => 0);
                } else { $mechPic = WWW::Mechanize::Firefox->new(create => 1, autodie => 0); }
                $mechPic->get($picURL, synchronize => 0);
                sleep($CONFIG{'TIME_TO_WAIT'}*5);
                $tabCurrentTitle = $mechPic->title;
                
                # Save the page content
                my $pagePath = "$saveDir\\$mainAlbumTitle\\$albumDir\\temp\\page.html";
                my $status   = $mechPic->save_content($pagePath);
                while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
                
                # Load content from file
                if (-T $pagePath and open(my $fhTemp, "<:encoding(UTF-8)", $pagePath)) {
                  my $file_as_string = do { local $/ = <$fhTemp> };
                  $file_as_string    =~ s/[\r\n]//g;
                  close($fhTemp);
                  my $section        = (split(/function\(Bootloader\)/, $file_as_string))[0];
                  my @parts          = (split(/_3x-2/, $section));
                  if ($winAlbums->chPublishDate->Checked and
                      ($parts[0] =~ /data-utime="([^\"]+)"[^\>]+class="_5ptz"/ or
                       ($parts[0] =~ /class="_5ptz"[^\>]+data-utime="([^\"]+)/))) { $$refListPics{$album}{$picURL}{'pubDate'} = $1; }
                  # Gather the medium size picture Url
                  if ($FG_size == 1 and $parts[1] =~ /src="([^\"]+$picName[^\"]+)/) {
                    $mediumSizePicUrl                              = $1;
                    $mediumSizePicUrl                              =~ s/&amp;/&/g;
                    $$refListPics{$album}{$picURL}{'mediumPicURL'} = $mediumSizePicUrl;
                  }
                  # Gather the big size picture Url
                  elsif ($FG_size == 2) {
                    if ($file_as_string =~ /_2-sx/) {
                      my $part        = (split(/_2-sx/, $file_as_string))[1];
                      $file_as_string = undef;
                      if ($part =~ /src="([^\"]+)/) {
                        $bigSizePicUrl = $1;
                        if ($bigSizePicUrl !~ /spacer/) {
                          $bigSizePicUrl                              =~ s/&amp;/&/g;
                          $$refListPics{$album}{$picURL}{'bigPicURL'} = $bigSizePicUrl;
                        } else { $bigSizePicUrl = undef; }
                      }
                    }
                    # Gather big size picture Url was not possible, try medium size instead
                    if (!$bigSizePicUrl and $parts[1] =~ /src="([^\"]+$picName[^\"]+)/) {
                      $mediumSizePicUrl                           = $1;
                      $mediumSizePicUrl                           =~ s/&amp;/&/g;
                      $$refListPics{$album}{$picURL}{'bigPicURL'} = $mediumSizePicUrl;
                    }
                  }
                }
              
                # Download the picture (medium or big size)
                if (($bigSizePicUrl and $bigSizePicUrl =~ /[^\"]+\/([^\?]+)/) or ($mediumSizePicUrl and $mediumSizePicUrl =~ /[^\"]+\/([^\?]+)/)) {
                  my $picName = $1;
                  my $picFileUrl;
                  if ($bigSizePicUrl) { $picFileUrl = $bigSizePicUrl;    }
                  else                { $picFileUrl = $mediumSizePicUrl; }
                  my $picPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$picName";
                  $picFileUrl =~ s/&amp;/&/g;
                  $mechPic->save_url($picFileUrl, $picPath);
                  $$refListPics{$album}{$picURL}{'picPath'} = $picPath;
                  $picPath                                  =~ s/\Q$saveDir\E\\//;
                  $$refListPics{$album}{$picURL}{'relPath'} = ".\\$picPath";
                  undef $mechPic;
                }
              # Small size only
              } else {
                $$refListPics{$album}{$picURL}{'picPath'} = "$saveDir\\$mainAlbumTitle\\$albumDir\\" . $$refListPics{$album}{$picURL}{'smallPicName'};
                $$refListPics{$album}{$picURL}{'relPath'} = $picURL;
              }
            }
            # Normal profile album
            elsif (!$picOk and $picURL =~ /\/([^\/\?]+)(?:\?|$)/) {
              my $picName = $1;
              $picName    = encode($CONFIG{'CHARSET'}, $picName);
              my $picPath = "$saveDir\\$mainAlbumTitle\\$albumDir\\$picName";
              $winPb->lblPbCurr2->Text("$STR{'downloading'}: $picName");
              my $picOk = 0;
              
              # Download the small picture ?
              if (!$FG_size and exists($$refListPics{$album}{$picURL}{'smallPicUrl'}) and $$refListPics{$album}{$picURL}{'smallPicUrl'} =~ /\/([^\/\?]+)(?:\?|$)/) {
                my $picName = $1;
                $picPath  = "$saveDir\\$mainAlbumTitle\\$albumDir\\$picName";
                if (!-e $picPath) { $mechAlbum->save_url($$refListPics{$album}{$picURL}{'smallPicUrl'}, $picPath); }
                $$refListPics{$album}{$picURL}{'smallPicName'} = $picName;
                $$refListPics{$album}{$picURL}{'picPath'}      = $picPath;
                $$refListPics{$album}{$picURL}{'relPath'}      = $$refListPics{$album}{$picURL}{'picPage'};
              }
              
              # Download the medium picture ?
              if ($FG_size == 1) {
                if (!-e $picPath) { $mechAlbum->save_url($picURL, $picPath); }
                $$refListPics{$album}{$picURL}{'smallPicName'} = $picName;
                $$refListPics{$album}{$picURL}{'picPath'}      = $picPath;
                $picPath                                       =~ s/\Q$saveDir\E\\//;
                $$refListPics{$album}{$picURL}{'relPath'}      = ".\\$picPath";
              }
              
              # Publication date and/or big size picture
              if ($winAlbums->chPublishDate->Checked or $FG_size == 2) {
                my $mechPic;
                my $publishDate;
                if ($$refListPics{$album}{$picURL}{'picPage'}) {
                  if ($tabCurrentTitle) {
                    $mechPic = WWW::Mechanize::Firefox->new(tab => qr{$tabCurrentTitle}, create => 1, autodie => 0);
                  } else { $mechPic = WWW::Mechanize::Firefox->new(create => 1, autodie => 0); }
                  $mechPic->get($$refListPics{$album}{$picURL}{'picPage'}, synchronize => 0);
                  sleep($CONFIG{'TIME_TO_WAIT'}*5);
                  my $currentTitle = $mechPic->title;
                  if ($currentTitle =~ /([^\-]+ \- )/) { $tabCurrentTitle = $1; }
                  my $pagePath = "$saveDir\\$mainAlbumTitle\\$albumDir\\temp\\page.html";
                  my $status   = $mechPic->save_content($pagePath);
                  while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
                  if (-T $pagePath and open(my $fhTemp, "<:encoding(UTF-8)", $pagePath)) {
                    my $file_as_string = do { local $/ = <$fhTemp> };
                    $file_as_string    =~ s/[\r\n]//g;
                    close($fhTemp);
                    if ($winAlbums->chPublishDate->Checked and
                        ($file_as_string =~ /data-utime="([^\"]+)"[^\>]+class="_5ptz"/ or
                         ($file_as_string =~ /class="_5ptz"[^\>]+data-utime="([^\"]+)/))) {
                      $$refListPics{$album}{$picURL}{'pubDate'} = $1;
                    }
                    if ($FG_size == 2) {
                      my $part        = (split(/_2-sx/, $file_as_string))[1];
                      $file_as_string = undef;
                      my $bigSizePicUrl;
                      if ($part =~ /src="([^\"]+)/) {
                        $bigSizePicUrl = $1;
                        if ($bigSizePicUrl !~ /spacer/) {
                          $bigSizePicUrl    =~ s/&amp;/&/g;
                          if ($bigSizePicUrl =~ /\/([^\/\?]+)(?:\?|$)/) {
                            my $picName = $1;
                            $picPath    = "$saveDir\\$mainAlbumTitle\\$albumDir\\$picName";
                            if (!-e $picPath) { $mechAlbum->save_url($bigSizePicUrl, $picPath); }
                            $$refListPics{$album}{$picURL}{'smallPicName'} = $picName;
                            $$refListPics{$album}{$picURL}{'picPath'}      = $picPath;
                            $picPath                                       =~ s/\Q$saveDir\E\\//;
                            $$refListPics{$album}{$picURL}{'relPath'}      = ".\\$picPath";
                          }
                        } else { $bigSizePicUrl = undef; }
                      }
                      # Download big size picture was not possible, try medium size instead
                      if (!$bigSizePicUrl) {
                        if (!-e $picPath) { $mechAlbum->save_url($picURL, $picPath); }
                        $$refListPics{$album}{$picURL}{'smallPicName'} = $picName;
                        $$refListPics{$album}{$picURL}{'picPath'}      = $picPath;
                        $picPath                                       =~ s/\Q$saveDir\E\\//;
                        $$refListPics{$album}{$picURL}{'relPath'}      = ".\\$picPath";
                      }
                    }
                  }
                  undef $mechPic;
                }
              }
            }
            
            # Update progress
            $count2++;
            $winPb->pbWinPb2->StepIt();
            $winPb->lblCount2->Text("$count2/$$refListAlbums{$album}{'nbrPics'}");
          }
        }
      }
      
      $count1++;
      $winPb->pbWinPb1->StepIt();
      $winPb->lblCount1->Text("$count1/$nbrAlbums");
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      
      # Delete temporary files
      if (-d "$saveDir\\$mainAlbumTitle\\$albumDir\\temp" and $winConfig->chDelTempFiles->Checked()) {
        remove_tree("$saveDir\\$mainAlbumTitle\\$albumDir\\temp");
      }
    }
    
    # Create the HTML Album page
    my $htmlAlbumPage = "$saveDir\\$mainAlbumTitle.html";
    $mainAlbumTitle = encode('utf8', $mainAlbumTitle);
    open(HTML, ">:encoding(UTF-8)", $htmlAlbumPage);
    print HTML "<!DOCTYPE html>\n";
    print HTML "<html>\n<head>\n<title>$mainAlbumTitle</title>\n";
    print HTML "<meta charset=\"UTF-8\">\n";
		print HTML "<style>\n";
		print HTML "table, th, td {\n";
		print HTML "  border: 1px solid black;\n";
		print HTML "  border-collapse: collapse;\n";
		print HTML "}\n";
		print HTML "th, td {\n";
		print HTML "  padding: 5px;\n";
		print HTML "}\n";
		print HTML "</style>\n";
    print HTML "</head>\n";
    print HTML "<body>\n";
		print HTML "<h1 style=\"color:#003300;font-size: 18pt;font-variant: small-caps;font-weight: bold;\;text-align: center;\">";
    print HTML "$mainAlbumTitle</h1>\n";
    print HTML "<table style=\"margin: auto;\">\n";
    # For each album
    foreach my $album (keys %{$refListPics}) {
      my $albumDir = ".\\$mainAlbumTitle\\$$refListAlbums{$album}{'dir'}";
      print HTML "<tr><th colspan=4 style=\"height: 50px; color:#003300; background-color:#EEEEEE; font-size: 14pt; font-variant: small-caps; font-weight: bold;\">$album</th></tr>";
      my $count = 0;
      foreach (sort {$$refListPics{$album}{$a}{'ind'} <=> $$refListPics{$album}{$b}{'ind'}} keys %{$$refListPics{$album}}) {
        my $pic = $_;
        my $fileName = $$refListPics{$album}{$pic}{'smallPicName'};
        my $filePath = $$refListPics{$album}{$pic}{'picPath'};
        if (-e $filePath) { $filePath =~ s/\Q$saveDir\E\\//;    }
        else              { $filePath = "$albumDir\\$fileName"; }
        if (!$count) { print HTML "<tr>\n"; }  # new row for each group of 4 pics
        print HTML "<td style=\"width: 25%; font-size: 11pt;text-align: center;\">\n";
        # Video
        if ($albumDir =~ /\\vb\./ and exists($$refListPics{$album}{$pic}{'videoPath'})) {
          my $videoFileName = (split(/\\/, $$refListPics{$album}{$pic}{'videoPath'}))[-1];
          my $videoPath     = "$albumDir\\$videoFileName";
          print HTML "<a href=\"$videoPath\">\n";
        # Picture
        } else { print HTML "<a href=\"$$refListPics{$album}{$pic}{'relPath'}\">\n"; }
        print HTML "<img src=\"$albumDir\\$fileName\" alt=\"$fileName\" style=\"max-width:200px;\">\n";
        print HTML "</a><br><br>\n";
        if ($winAlbums->chPublishDate->Checked) {
          if (exists($$refListPics{$album}{$pic}{'pubDate'})) {
            my $dateStr;
            if ($$refListPics{$album}{$pic}{'pubDate'}) { $dateStr = &formatDate($$refListPics{$album}{$pic}{'pubDate'}); }
            else                                        { $dateStr = $STR{'errorDate'};                                   }
            print HTML "Date: <strong style=\"color:#339900;\">$dateStr</strong>\n";
          }
        }
        print HTML "</td>\n";
        $count++;
        if ($count == 4) { print HTML "</tr>\n"; $count = 0; } # End row
      }
      # Complete row (last row is not 4 pics)
      if ($count != 0) {
        while ($count != 4) {
          print HTML "<td>&nbsp;</td>\n";
          $count++;
        }
      }
    }
    print HTML "</table>\n</body>\n</html>\n";
    close(HTML);
    
    # Open the page
    if ($winAlbums->chAlbumsOpenHTML->Checked()) { $win->ShellExecute('open', $htmlAlbumPage,'','',1); }
    
    # Open the directory
    if ($winAlbums->chAlbumsOpenDir->Checked() ) {
      Win32::Process::Create(my $ProcessObj                 ,
                             "$ENV{'WINDIR'}\\explorer.exe" ,
                             "explorer $saveDir"             ,
                             0                              ,
                             NORMAL_PRIORITY_CLASS          ,
                             ".");
    }

    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
  }

  $win->Tray->Change(-tip => $STR{'dumpAlbumF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpAlbumF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);


}  #--- End dumpAlbums
  
#--------------------------#
sub winPb_Terminate
#--------------------------#
{
  $winPb->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winPb_Terminate

#--------------------------#
sub winPb2_Terminate
#--------------------------#
{
  $winPb2->Hide();
  $win->Enable();
  $win->SetForegroundWindow();
  return(0);

}  #--- End winPb2_Terminate

#--------------------------#
sub winAlbums_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winAlbums->AbsLeft();
    my $winTop  = $winAlbums->AbsTop();
    $CONFIG{'WINALBUMS_LEFT'} = $winLeft;
    $CONFIG{'WINALBUMS_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winAlbums_Terminate

#--------------------------#
sub winFriends
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winFriends->GridFriends->DeleteNonFixedRows();
    $winFriends->tfFriendName->Text('');
    
    # Start the thread
    $THR = threads->create(\&winFriendsThr);
    
    usleep(500000);
    $winFriends->GridFriends->AutoSize();
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINFRIENDS_LEFT'} and $CONFIG{'WINFRIENDS_TOP'}) {
      $winFriends->Left($CONFIG{'WINFRIENDS_LEFT'});
      $winFriends->Top($CONFIG{'WINFRIENDS_TOP'});
    } else { $winFriends->Center(); }
    $winFriends->DoModal();
  }

}  #--- End winFriends

#--------------------------#
sub btnFriendsRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winFriends->GridFriends->DeleteNonFixedRows();
    $winFriends->tfFriendName->Text('');
    
    # Start the thread
    $THR = threads->create(\&winFriendsThr);
  }
  
}  #--- End btnFriendsRefresh_Click

#--------------------------#
sub winFriendsThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winFriends->tfDirSaveFriends->Text();
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winFriendsThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winFriends, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  $winFriends->GridFriends->DeleteNonFixedRows();
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winFriends->btnFriendsOk->Disable();
      Win32::GUI::MessageBox($winFriends, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    $winFriends->btnFriendsOk->Disable();
    $winFriends->lblInProgress->Text($STR{'wait'}.'...');
    $winFriends->ChangeCursor($HOURGLASS);
    my $currURL = $mech->uri();
    if ($currURL =~ /#$/) { chop($currURL); }
    my $currTitle;
    if ($currURL !~ /\/friends\/?$/ and $currURL !~ /\&sk=friends/) {
      # Trying to get the good page
      if ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) {
        my $profilID = $1;
        my $goodURL = "https://www.facebook.com/profile.php?id=$profilID&sk=friends";
        ($currURL, $currTitle) = &loadPage(\$mech, $goodURL);
      } elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/) {
        my $goodURL = "https://www.facebook.com/$1/friends";
        ($currURL, $currTitle) = &loadPage(\$mech, $goodURL);
      }
      
      # Re evaluate current page
      if (($currURL !~ /\/friends\/?$/ and $currURL !~ /\&sk=friends/) or $currTitle =~ /Page Not Found/) {
        $winFriends->btnFriendsOk->Disable();
        Win32::GUI::MessageBox($winFriends, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
        $winFriends->ChangeCursor($ARROW);
        $winFriends->lblInProgress->Text('');
        threads->exit();
      } else {
        if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
        elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
        $currTitle =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
        $winFriends->tfFriendName->Text("$currTitle - $STR{'friends'}");
      }
    # You are in the right page
    } else {
      if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
      elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
      $currTitle =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
      $winFriends->tfFriendName->Text("$currTitle - $STR{'friends'}");
    }
    
    # List available categories
    if ($winFriends->tfFriendName->Text()) {
      my %categories;
      my $header = $mech->selector('div._3dc.lfloat._ohe._5brz', one => 1)->{innerHTML};
      my @div    = split(/\>/, $header);
      foreach (@div) {
        if (/href=\"([^\"]+)\"/) {
          my $url  = $1;
          $url =~ s/&amp;/&/g;
          my $cat;
          if (/name=\"([^\"]+)\"/) { $cat = $1; }
          if ($cat) {
            $categories{$cat}{name} = $cat;
            $categories{$cat}{url}  = $url;
            if (/aria-controls=\"([^\"]+)\"/) {
              my $catId = $1;
              $categories{$cat}{catId} = $catId;
            }
          }
        }
      }
      
      foreach my $cat (sort keys %categories) {
        if ($categories{$cat} and my $i = $winFriends->GridFriends->InsertRow($cat, -1)) {
          $winFriends->GridFriends->SetCellText($i, 0, ''        );
          $winFriends->GridFriends->SetCellType($i, 0, GVIT_CHECK);
          $winFriends->GridFriends->SetCellCheck($i, 0, 1);
          $categories{$cat}{name} = encode($CONFIG{'CHARSET'}, $categories{$cat}{name});
          $winFriends->GridFriends->SetCellText($i, 1, $categories{$cat}{name});
          $winFriends->GridFriends->SetCellText($i, 2, $categories{$cat}{catId});
          $winFriends->GridFriends->SetCellText($i, 3, $categories{$cat}{url});
          $winFriends->GridFriends->AutoSize();
          $winFriends->GridFriends->ExpandLastColumn();
          $winFriends->GridFriends->Refresh();
        }
      }
    }
  } else { Win32::GUI::MessageBox($winFriends, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }

  $winFriends->ChangeCursor($ARROW);
  $winFriends->lblInProgress->Text('');
  
  # Ready ?
  &isDumpFriendsReady();

}  #--- End winFriendsThr

#--------------------------#
sub tfFriendName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winFriends->tfDirSaveFriends->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'DIR_SAVE_FRIENDS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpFriendsReady();

}  #--- End tfFriendName_Change

#--------------------------#
sub cbFriendsFormat_Change
#--------------------------#
{
  # No profile icon for txt format
  if ($winFriends->cbFriendsFormat->GetCurSel() == 2) {
    $winFriends->chFriendsProfileIcons->Disable();
  } else { $winFriends->chFriendsProfileIcons->Enable(); }
  
}  #--- End cbFriendsFormat_Change

#--------------------------#
sub tfDirSaveFriends_Change
#--------------------------#
{
  # Local variables
  my $friendName = $winFriends->tfFriendName->Text();
  my $saveDir    = $winFriends->tfDirSaveFriends->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'DIR_SAVE_FRIENDS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpFriendsReady();

}  #--- End tfDirSaveFriends_Change

#--------------------------#
sub btnDirSaveFriends_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winFriends->tfDirSaveFriends->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winFriends    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winFriends    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winFriends->tfDirSaveFriends->Text($dir);
  }
  
}  #--- End btnDirSaveFriends_Click

#--------------------------#
sub btnBrowseDirSaveFriends_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winFriends->tfDirSaveFriends->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveFriends_Click

#--------------------------#
sub chSaveFriendsDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winFriends->tfDirSaveFriends->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_FRIENDS'} = 1;
    $CONFIG{'DIR_SAVE_FRIENDS'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winFriends->chSaveFriendsDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_FRIENDS'} = 0;
    delete($CONFIG{'DIR_SAVE_FRIENDS'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveFriendsDir_Click

#--------------------------#
sub chFriendsProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winFriends->chFriendsProfileIcons->Checked()) {
    $CONFIG{'FRIENDS_INCLUDE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'FRIENDS_INCLUDE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFriendsProfileIcons_Click

#--------------------------#
sub chFriendsOpenOutput_Click
#--------------------------#
{
  # Save the choice
  if ($winFriends->chFriendsOpenOutput->Checked()) {
    $CONFIG{'FRIENDS_OPEN_OUTPUT'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'FRIENDS_OPEN_OUTPUT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chFriendsOpenOutput_Click

#--------------------------#
sub GridFriends_Click
#--------------------------#
{
  # Local variables
  my ($row, $column) = @_;
  
  # Select
  if (!$column) {
    my $selStatus = $winFriends->GridFriends->GetCellCheck($row, $column);
    if (!$row) {
      # Check all
      if (!$selStatus) { for (my $i = 0; $i < $winFriends->GridFriends->GetRows(); $i++) { $winFriends->GridFriends->SetCellCheck($i, 0, 1); } }
      # Uncheck all
      else             { for (my $i = 0; $i < $winFriends->GridFriends->GetRows(); $i++) { $winFriends->GridFriends->SetCellCheck($i, 0, 0); } }
    } else {
      # Check
      if (!$selStatus) { $winFriends->GridFriends->SetCellCheck($row, $column, 1); }
      # Uncheck
      else             { $winFriends->GridFriends->SetCellCheck($row, $column, 0); }
    }
  }
  
  return(1);

}  #--- End GridFriends_Click

#--------------------------#
sub isDumpFriendsReady
#--------------------------#
{
  # Local variables
  my $saveDir    = $winFriends->tfDirSaveFriends->Text();
  my $friendName = $winFriends->tfFriendName->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$friendName) { $winFriends->btnFriendsOk->Disable(); return(0); }
  
  # Friends category loaded and at least one checked ?
  my $friendsChecked = 0;
  for (my $i = 1; $i < $winFriends->GridFriends->GetRows(); $i++) {
    my $selStatus = $winFriends->GridFriends->GetCellCheck($i, 0);
    if ($selStatus == 1) {
      $friendsChecked = 1;
      last;
    }
  }
  if (!$friendsChecked) { $winFriends->btnFriendsOk->Disable(); return(0); }

  $winFriends->btnFriendsOk->Enable();

}  #--- End isDumpFriendsReady

#--------------------------#
sub btnFriendsOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winFriends->AbsLeft();
      my $winTop  = $winFriends->AbsTop();
      $CONFIG{'WINFRIENDS_LEFT'} = $winLeft;
      $CONFIG{'WINFRIENDS_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $friendName = $winFriends->tfFriendName->Text();
    $friendName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir    = $winFriends->tfDirSaveFriends->Text();
    my %listCatFriends;	# Friend categories and urls
    my $nbrCatFriends   = 0;
    my $posPb1          = 0;
    my $parsingDone     = 0;
    my $nbrFriendsDone  = 0;
    my $nbrRetries      = 0;

    if ($friendName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpFriends, $friendName, $saveDir, \%listCatFriends, $nbrCatFriends,
                             $nbrFriendsDone, $posPb1, $parsingDone, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnFriendsOk_Click

#--------------------------#
sub dumpFriends
#--------------------------#
{
  # Local variables
  my ($friendName, $saveDir, $refListCatFriends, $nbrCatFriends, $nbrFriendsDone, $posPb1, $parsingDone, $nbrRetries) = @_;
  my $includeIcons = $winFriends->chFriendsProfileIcons->Checked();
  my $format       = $winFriends->cbFriendsFormat->GetCurSel(); # report format
  my $firstExec    = 0;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpFriendsC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    $posPb1 = $winPb->pbWinPb1->GetPos();
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) {
      $nbrRetries++;
      # Progress window
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
    }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpFriends, $friendName, $saveDir, $refListCatFriends, $nbrCatFriends,
                             $nbrFriendsDone, $posPb1, $parsingDone, $nbrRetries);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
			Win32::GUI::MessageBox($winPb, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };
  
  # First execution, must gather friends category and url
  if (!$posPb1 and !$nbrCatFriends) {
    $firstExec = 1;
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpFriendsP'}.'...');
    for (my $i = 1; $i < $winFriends->GridFriends->GetRows(); $i++) {
      my $selStatus = $winFriends->GridFriends->GetCellCheck($i, 0);
      if ($selStatus == 1) {
        my $catName = decode($CONFIG{'CHARSET'}, $winFriends->GridFriends->GetCellText($i, 1));
        my $catid   = $winFriends->GridFriends->GetCellText($i, 2);
        my $catURL  = $winFriends->GridFriends->GetCellText($i, 3);
        $$refListCatFriends{$catName}{'id'}   = $catid;
        $$refListCatFriends{$catName}{'url'}  = $catURL;
        $$refListCatFriends{$catName}{'name'} = $catName;
      }
    }
    # Number of categories
    $nbrCatFriends = keys %{$refListCatFriends};
  } # else, resume after a crash

  if ($nbrCatFriends > 0) {
    my $count1;
    # First execution, turn on the progress window
    if ($firstExec == 1) {
      # Turn on progress bar
      $winPb->Center($winFriends);
      $winPb->Show();
      $win->Disable();
      $winPb->pbWinPb1->SetRange(0, $nbrCatFriends);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      $winPb->lblPbCurr1->Text('');
      $winPb->lblCount1->Text('');
      $count1 = 0;
    # If on resume state, get number of friends cat left
    } else {
      my $nbrCurrCatFriends = keys %{$refListCatFriends};
      $count1 = $nbrCatFriends - $nbrCurrCatFriends;
    }
    
    # Parse each friend category page
    if (!$parsingDone) {
      # Make folders
      if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
      if (!-d "$saveDir\\images_$friendName" and $includeIcons) { mkdir("$saveDir\\images_$friendName"); }
      
      # Connect to current tab in Firefox
      my $mechFriends = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
      
      foreach my $cat (sort keys %{$refListCatFriends}) {
        my $encodedName = encode($CONFIG{'CHARSET'}, $$refListCatFriends{$cat}{'name'});
        my $htmlPage;
        my @friends;
        my $nbrFriends;
        
        # Check status for the current category ($$refListCatFriends{$cat}{'status'})
        # 1 : Opening
        # 2 : Scrolling done
        # 3 : Downloading done
        # 4 : Parsing done
        
        # Opening the Friends Category Tab
        if (!exists($$refListCatFriends{$cat}{'status'})) {
          $winPb->lblPbCurr1->Text("$STR{'opening'}: $encodedName");
          $winPb->lblCount1->Text("$count1/$nbrCatFriends");
          $winPb->lblPbCurr2->Text('');
          $winPb->lblCount2->Text('');
          $winPb->pbWinPb2->SetPos(0);
          &selectCatFriendPage(\$mechFriends, $cat);
          $$refListCatFriends{$cat}{'status'} = 1; # Opening done
        }
        
        # Scrolling the Friends Category Tab
        if ($$refListCatFriends{$cat}{'status'} < 2) {
          $winPb->lblPbCurr1->Text("$STR{'scrolling'}: $encodedName");
          sleep($CONFIG{'TIME_TO_WAIT'});
          &scrollFriendPage(\$mechFriends, $CONFIG{'TIME_TO_WAIT'});
          $$refListCatFriends{$cat}{'status'} = 2; # Scrolling done
        }
        
        # Downloading the Friends Category Tab
        if ($$refListCatFriends{$cat}{'status'} < 3) {
          $winPb->lblPbCurr1->Text("$STR{'saving'}: $encodedName");
          $htmlPage = "$saveDir\\temp\\page.html";
          my $status;
          if ($includeIcons) { $status = $mechFriends->save_content($htmlPage, "$saveDir\\temp"); }
          else               { $status = $mechFriends->save_content($htmlPage);                   }
          while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { usleep(100000); }
          $$refListCatFriends{$cat}{'status'} = 3; # Downloading done
        }
        
        # Parsing the Friends Category Tab
        my $nbrFriendsDone = keys %{$$refListCatFriends{$cat}{'profilOrder'}};
        if ($$refListCatFriends{$cat}{'status'} < 4) {
          $winPb->lblPbCurr1->Text("$STR{'parsing'}: $encodedName");

          # Parse by section and groups
          # Load content from file
          if (-T $htmlPage) {
            if (open(my $fhTemp, "<:encoding(UTF-8)", $htmlPage)) {
              my $file_as_string = do { local $/ = <$fhTemp> };
              $file_as_string    =~ s/[\r\n]//g;
              my @partsID        = split(/\:/, $$refListCatFriends{$cat}{'id'});
              my $id             = pop(@partsID);
              my $separator      = join(':', @partsID);
              my @sections       = split(/id=\"$separator/, $file_as_string);
              my $section;
              foreach (@sections) { if (/^\:$id\"/) { $section = $_; } }
              $file_as_string    = undef;
              @friends           = split(/_698/, $section);
              shift(@friends);
              $nbrFriends        = scalar(@friends);
              if (!$nbrFriends) {
                @friends = split(/fbProfileBrowserListItem/, $section); # Followers category
                shift(@friends);
                $nbrFriends = scalar(@friends);
              }
              close($fhTemp);
            }
          }
          
          # Progress bar
          $winPb->pbWinPb2->SetRange(0, $nbrFriends);
          $winPb->pbWinPb2->SetPos($nbrFriendsDone);
          $winPb->pbWinPb2->SetStep(1);
          $winPb->lblCount2->Text("$nbrFriendsDone/$nbrFriends");
          
          # Parse friends details
          my $k = 0;
          foreach my $friend (@friends) {
            if ($k >= $nbrFriendsDone) {
              my $url;
              my $id;
              my $img;
              # Url and Img
              if ($friend =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard\/user.php\?id=([^\&\"]+)(?:&|")[^\>]*>/) {
                $url = $1;
                $id  = $2;
              }
              # Img
              if ($friend =~ /<img class="_s0 _r[wv] img" src="([^\"]+)" alt=""><\/a>/) {
                $img = $1;
              }
              
              # Minimum details required
              if ($url and $id and $img) {
                $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $id...");
                if ($includeIcons and ($img =~ /\/([^\/\?]+)\?/ or $img =~ /(\w+\.jpg)/)) { # Include profile icons
                  my $imgFilename = $1; # Replace image name by profil id
                  rcopy("$saveDir\\temp\\$imgFilename", "$saveDir\\images_$friendName\\$id\.jpg"); # Copy image
                  $$refListCatFriends{$cat}{'profilImg'}{$id} = "images_$friendName\\$id\.jpg";
                } elsif ($format == 1) { $$refListCatFriends{$cat}{'profilImageUrl'}{$id} = $img; } # HTML Report
                $$refListCatFriends{$cat}{'profilUrl'}{$id} = $url;
                $$refListCatFriends{$cat}{'profilOrder'}{$nbrFriendsDone} = $id;
                
                # Gather profil name
                my $url2 = quotemeta($url);
                if ($friend =~ /<(?:div|span) class="fsl fwb fcb"><a href="$url2[^\>]+>([^\<]+)</) {
                  $$refListCatFriends{$cat}{'profilName'}{$id} = $1;
                }
                
                # Gather details (if available)
                if ($friend =~ /<span class="_50hf fsm fwn">(.+)<\/span><\/li>/) {
                  my $details = $1;
                  $details =~ s/<[^\>]+>//g;
                  $details = decode_entities($details);
                  $$refListCatFriends{$cat}{'profilDetails'}{$id} = $details;
                }
              }
              $winPb->pbWinPb2->StepIt();
              $nbrFriendsDone++;
              $winPb->lblCount2->Text("$k/$nbrFriends");
            }
            $k++;
          }
          $$refListCatFriends{$cat}{'status'} = 4; # Parsing done
          $winPb->pbWinPb1->StepIt();
          $winPb->lblCount1->Text("$count1/$nbrCatFriends");
        }
        $count1++;
        $nbrFriendsDone = 0;
        if ($count1 == $nbrCatFriends) { $parsingDone = 1; }
      }
    }
    
    # Parsing done, create the report
    $count1 = 0;
    $winPb->lblPbCurr1->Text($STR{'createOutput'}.'...');
    $winPb->lblCount1->Text('');
    if ($nbrCatFriends) {
      # Progress 1
      $winPb->lblCount1->Text("$count1/$nbrCatFriends");
      $winPb->pbWinPb1->SetRange(0, $nbrCatFriends);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);

      # Create and open the XLSX file
      my $filename;
      if (!$format) {
        $filename = "$saveDir\\$friendName\.xlsx";
				my $excel;
				my $count = 1;
				while (!($excel = Excel::Writer::XLSX->new($filename))) { # If file is already open, must be renamed
					$filename = "$saveDir\\$friendName [".$count++."]\.xlsx";
					if ($count == 10) { last; } # Stop after 10 attempts
				}
				
        # One sheet per category
        foreach my $cat (sort keys %{$refListCatFriends}) {
          &createExcelSheetWithDetails(\$excel, $$refListCatFriends{$cat}{'name'}, $$refListCatFriends{$cat}, $includeIcons, $saveDir);
          $count1++;
          $winPb->lblCount1->Text("$count1/$nbrCatFriends");
          $winPb->pbWinPb1->StepIt();
        }
        $excel->close();
        
      # HTML
      } elsif ($format == 1) {
        $filename = &createHTMLFriends($friendName, $refListCatFriends, $nbrCatFriends, $includeIcons, $saveDir);

      # TXT
      } else {
        $filename = "$saveDir\\$friendName.txt";
        &createTXTFriends($friendName, $filename, $refListCatFriends, $nbrCatFriends, $includeIcons, $saveDir);
      }
      
      # Open the file
      if ($winFriends->chFriendsOpenOutput->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
    }
    
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    
    # Delete temporary files
    if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }
  }

  $win->Tray->Change(-tip => $STR{'dumpFriendsF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'               ,
                        -balloon_title => 'ExtractFace'        ,
                        -balloon_tip   => $STR{'dumpFriendsF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpFriends

#--------------------------#
sub createExcelSheetWithDetails
#--------------------------#
{
  # Local variables
  my ($refExcel, $sheetName, $refData, $includeIcons, $saveDir) = @_;
  my $encodedName = encode($CONFIG{'CHARSET'}, $sheetName);
  
  $winPb->lblPbCurr1->Text("$STR{'createSheet'}: $encodedName");
  # Progress 2
  my $nbrItems = scalar(keys %{$$refData{'profilOrder'}});
  $winPb->lblPbCurr2->Text('');
  $winPb->pbWinPb2->SetRange(0, $nbrItems);
  $winPb->pbWinPb2->SetPos(0);
  $winPb->pbWinPb2->SetStep(1);
	$winPb->lblCount2->Text("0/$nbrItems");
  my $count2 = 0;
  
  my $sheet  = $$refExcel->add_worksheet($sheetName); # Add a sheet
  # Formats 
  my $format = $$refExcel->add_format();
  $format->set_bold();
  $format->set_align( 'center' );
  $format->set_align( 'vcenter' );
  my $format2 = $$refExcel->add_format();
  $format2->set_align( 'center' );
  $format2->set_align( 'vcenter' );
  my $format3 = $$refExcel->add_format();
  $format3->set_align( 'top' );
  my $j = 0; # Column no
  # Headers
  if ($includeIcons) { $sheet->write( 0, $j, $STR{'image'}     , $format ); $j++; }
  $sheet->write( 0, $j, $STR{'profilID'}  , $format ); $j++;
  $sheet->write( 0, $j, $STR{'url'}       , $format ); $j++;
  $sheet->write( 0, $j, $STR{'name'}      , $format ); $j++;
  $sheet->write( 0, $j, $STR{'details'}   , $format ); $j++;
  if ($includeIcons) { $sheet->write( 0, $j, $STR{'imgPath'}   , $format ); $j++; }
  $sheet->write( 0, $j, $STR{'originURL'} , $format );
  # Create content
  my $i = 1; # Row no
  my $maxWidthCol1 = 5;
  my $maxWidthCol2 = 0;
  my $maxWidthCol3 = 0;
  my $maxWidthCol4 = 0;
  my $maxWidthCol5 = 0;
  my $maxWidthCol6 = 0;
  my $maxWidthCol7 = length($$refData{'url'});
  foreach my $no (sort {$a <=> $b} keys %{$$refData{'profilOrder'}}) {
    $j = 0;
    my $id = $$refData{'profilOrder'}{$no};
    $winPb->lblPbCurr2->Text("$STR{'writing'}: $id");
    # Image column
    if ($includeIcons) {
      my $imgPath = "$saveDir\\$$refData{'profilImg'}{$id}";
      my $info = image_info($imgPath);
      if (!$info->{error}) { # Insert only if image is not corrupted
        $sheet->insert_image($i, $j, $imgPath); # Ignore if not a valid image
        if ($info->{height}) {
          my $colHeight = $info->{height} / 1.33;
          $sheet->set_row($i, $colHeight);
        }
        else { $sheet->set_row($i, 30); }
        if ($info->{width}) {
          my $colWidth = $info->{width} / 7.2;
          if ($colWidth > $maxWidthCol1) { $maxWidthCol1 = $colWidth; }
        }
      }
      $j++;
    }
    # Profil ID column
    $sheet->write_string($i, $j, $id);
    $sheet->set_column($j, 6, undef, $format3);
    if (length($id) > $maxWidthCol2) { $maxWidthCol2 = length($id); }
    $j++;
    # URL column
    $sheet->write($i, $j, $$refData{'profilUrl'}{$id});
    if (length($$refData{'profilUrl'}{$id}) > $maxWidthCol3) {
      $maxWidthCol3 = length($$refData{'profilUrl'}{$id});
    }
    $j++;
    # Name column
    if ($$refData{'profilName'}{$id}) {
      $sheet->write($i, $j, $$refData{'profilName'}{$id});
      if (length($$refData{'profilName'}{$id}) > $maxWidthCol4) {
        $maxWidthCol4 = length($$refData{'profilName'}{$id});
      }
    }
    $j++;
    # Profil Details column
    if ($$refData{'profilDetails'}{$id}) {
      $sheet->write($i, $j, $$refData{'profilDetails'}{$id});
      if (length($$refData{'profilDetails'}{$id}) > $maxWidthCol5) {
        $maxWidthCol5 = length($$refData{'profilDetails'}{$id});
      }
    }
    $j++;
    # Image Path column
    if ($includeIcons) {
      $sheet->write($i, $j, $$refData{'profilImg'}{$id});
      if (length($$refData{'profilImg'}{$id}) > $maxWidthCol6) {
        $maxWidthCol6 = length($$refData{'profilImg'}{$id});
      }
      $j++;
    }
    # Original URL column
    $sheet->write($i, $j, $$refData{'url'});
    
    # Ajust column sizes
    $j = 0;
    if ($includeIcons) { $sheet->set_column(0, 0, $maxWidthCol1, $format2); $j++; }
    $sheet->set_column($j, $j, $maxWidthCol2); $j++;
    $sheet->set_column($j, $j, $maxWidthCol3); $j++;
    $sheet->set_column($j, $j, $maxWidthCol4); $j++;
    $sheet->set_column($j, $j, $maxWidthCol5); $j++;
    if ($includeIcons) { $sheet->set_column($j, $j, $maxWidthCol6); $j++; }
    $sheet->set_column($j, $j, $maxWidthCol7);
    $i++;
		
		$winPb->pbWinPb2->StepIt();
		$count2++;
		$winPb->lblCount2->Text("$count2/$nbrItems");
  }

}  #--- End createExcelSheetWithDetails

#--------------------------#
sub createHTMLFriends
#--------------------------#
{
  # Local variables
  my ($friendName, $refListCatFriends, $nbrCatFriends, $includeIcons, $saveDir) = @_;
  my $firstPage; # First page is the main page
  my $first = 0;
  my $count = 0;
  
  # List of pages
  my %listPages;
  foreach my $cat (sort keys %{$refListCatFriends}) {
    my $name = $$refListCatFriends{$cat}{'name'};
    my $url  = (split(/\//, $$refListCatFriends{$cat}{'url'}))[-1];
    if ($url =~ /([^\?]+)/) {
      my $page = $1;
      if ($page =~ /\%3A(\d+)$/) { $listPages{$name} = "$friendName - $1\.html";    }
      else                       { $listPages{$name} = "$friendName - $page\.html"; }
    }
  }
  
  # Create one page per category
  foreach my $cat (sort keys %{$refListCatFriends}) {
    my $encodedName = encode($CONFIG{'CHARSET'}, $cat);
    $winPb->lblPbCurr1->Text("$STR{'createPage'}: $encodedName");
    my $filename = "$saveDir\\$listPages{$$refListCatFriends{$cat}{'name'}}";
    if ($first == 0) { $firstPage = $filename; $first = 1; } # Keep the filename of the first page
    open(HTML, ">:encoding(UTF-8)", $filename);
    print HTML "<!DOCTYPE html>\n";
    print HTML "<html>\n<head>\n<title>$$refListCatFriends{$cat}{'name'}</title>\n";
    print HTML "<meta charset=\"UTF-8\">\n";
		print HTML "<style>\n";
		print HTML "table, th, td {\n";
		print HTML "  border: 1px solid black;\n";
		print HTML "  border-collapse: collapse;\n";
		print HTML "}\n";
		print HTML "th, td {\n";
		print HTML "  padding: 5px;\n";
		print HTML "}\n";
		print HTML "</style>\n";
    print HTML "</head>\n";
    print HTML "<body>\n";
		print HTML "<h1 style=\"color:#003300;font-size: 18pt;font-variant: small-caps;font-weight: bold;\;text-align: center;\">";
    print HTML "$$refListCatFriends{$cat}{'name'}</h1>\n";
    print HTML "<table style=\"margin: auto;\">\n";
    print HTML "<tr><th colspan=4 style=\"height: 50px; color:#003300; background-color:#EEEEEE; font-size: 14pt; font-variant: small-caps; font-weight: bold;\">\n";
    my $header;
    foreach my $catListPages (sort keys %listPages) {
      if ($catListPages eq $cat) { $header .= "$catListPages - "; }
      else                       { $header .= "<a href=\"./$listPages{$catListPages}\">$catListPages</a> - "; }
    }
    chop($header); chop($header); chop($header);
    print HTML "$header</th></tr>\n";
    print HTML "<tr><td colspan=4 style=\"text-align: center;\">Origin url: <a href=\"$$refListCatFriends{$cat}{'url'}\">$$refListCatFriends{$cat}{'url'}</a></td></tr>\n";
    my $col = 0; # 2 columns per friend, first is profile icon, second is details
    foreach my $no (sort {$a <=> $b} keys %{$$refListCatFriends{$cat}{'profilOrder'}}) {
      if ($col == 0) { print HTML "<tr>"; }
      if (my $id = $$refListCatFriends{$cat}{'profilOrder'}{$no}) {
        if ($$refListCatFriends{$cat}{'profilImg'}{$id}) { print HTML "<td><img src=\"$$refListCatFriends{$cat}{'profilImg'}{$id}\" alt=\"\"></td>";      }
        else                                             { print HTML "<td><img src=\"$$refListCatFriends{$cat}{'profilImageUrl'}{$id}\" alt=\"\"></td>"; }
        $col++;
        print HTML "<td><strong>Name</strong>: $$refListCatFriends{$cat}{'profilName'}{$id}<br>";
        print HTML "<strong>Profile ID</strong>: $id</strong><br>";
        print HTML "<strong>Profile url</strong>: <a href=\"$$refListCatFriends{$cat}{'profilUrl'}{$id}\" target=\"_blank\">$$refListCatFriends{$cat}{'profilUrl'}{$id}</a><br>";
        print HTML "<strong>Details</strong>: $$refListCatFriends{$cat}{'profilDetails'}{$id}</td>";
        $col++;
      } else { print HTML "<td></td><td></td>"; $col += 2; }
      if ($col == 4) { print HTML "</tr>\n"; $col = 0; }
    }
    print HTML "</body>\n</html>";
    close(HTML);
    
    $count++;
    $winPb->lblCount1->Text("$count/$nbrCatFriends");
    $winPb->pbWinPb1->StepIt();
  }
  
  return($firstPage);  
  
}  #--- End createHTMLFriends

#--------------------------#
sub createTXTFriends
#--------------------------#
{
  # Local variables
  my ($friendName, $filename, $refListCatFriends, $nbrCatFriends, $includeIcons, $saveDir) = @_;
  my $count = 0;
  
  $winPb->lblPbCurr1->Text("$STR{'createTXT'}");
  open(my $txt, ">:encoding(UTF-8)", $filename);
  print $txt "CAT NAME\tCAT URL\tPROFILE ID\tURL\tNAME\tDETAILS\n"; # Header
  foreach my $cat (sort keys %{$refListCatFriends}) {
    foreach my $no (sort {$a <=> $b} keys %{$$refListCatFriends{$cat}{'profilOrder'}}) {
      my $id = $$refListCatFriends{$cat}{'profilOrder'}{$no};
      print $txt "$cat\t$$refListCatFriends{$cat}{'url'}\t$id\t$$refListCatFriends{$cat}{'profilUrl'}{$id}".
                 "\t$$refListCatFriends{$cat}{'profilName'}{$id}$$refListCatFriends{$cat}{'profilDetails'}{$id}\n";
    }
    
    $count++;
    $winPb->lblCount1->Text("$count/$nbrCatFriends");
    $winPb->pbWinPb1->StepIt();
  }
  close($txt);
  
}  #--- End createTXTFriends

#--------------------------#
sub winFriends_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winFriends->AbsLeft();
    my $winTop  = $winFriends->AbsTop();
    $CONFIG{'WINFRIENDS_LEFT'} = $winLeft;
    $CONFIG{'WINFRIENDS_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winFriends_Terminate

#--------------------------#
sub winEvent
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Reset window
    $winEvent->tfEventName->Text('');
    $winEvent->tfEventID->Text('');
    $winEvent->tfAuthorID->Text('');
    $winEvent->tfDataURL->Text('');
    $winEvent->chGoing->Text('Going');
    $winEvent->chMaybe->Text('Maybe');
    $winEvent->chInvited->Text('Invited');
    $winEvent->chDeclined->Text('Declined');
    $winEvent->chGoing->Checked(1);
    $winEvent->chMaybe->Checked(1);
    $winEvent->chInvited->Checked(1);
    $winEvent->chDeclined->Checked(1);
    
    # Start the thread
    $THR = threads->create(\&winEventThr);
    
    usleep(500000);
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINEVENT_LEFT'} and $CONFIG{'WINEVENT_TOP'}) {
      $winEvent->Left($CONFIG{'WINEVENT_LEFT'});
      $winEvent->Top($CONFIG{'WINEVENT_TOP'});
    } else { $winEvent->Center(); }
    $winEvent->DoModal();
  }

}  #--- End winEvent

#--------------------------#
sub btnEventRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Reset window
    $winEvent->tfEventName->Text('');
    $winEvent->tfEventID->Text('');
    $winEvent->tfAuthorID->Text('');
    $winEvent->tfDataURL->Text('');
    $winEvent->chGoing->Text('Going');
    $winEvent->chMaybe->Text('Maybe');
    $winEvent->chInvited->Text('Invited');
    $winEvent->chDeclined->Text('Declined');
    $winEvent->chGoing->Checked(1);
    $winEvent->chMaybe->Checked(1);
    $winEvent->chInvited->Checked(1);
    $winEvent->chDeclined->Checked(1);
    # Start the thread
    $THR = threads->create(\&winEventThr);
  }
  
}  #--- End btnEventRefresh_Click

#--------------------------#
sub winEventThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();
  my $tempDir = "$USERDIR\\temp";
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winEventThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winEvent, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winEvent->btnEventOk->Disable();
      Win32::GUI::MessageBox($winEvent, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    my $currURL = $mech->uri();
    my $idEvent;
    if ($currURL =~ /https:\/\/www.facebook.com\/events\/(\d+)\/?/) { $idEvent = $1; }
    else {
      $winEvent->btnEventOk->Disable();
      Win32::GUI::MessageBox($winEvent, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    }

    $winEvent->ChangeCursor($HOURGLASS);
    $winEvent->lblInProgress->Text($STR{'gatherEvent'}.'...');
    
    # Gather event details
    my $eventDetailsURL = "https://www.facebook.com/events/ajax/guest_list/?acontext[ref]=51&acontext[source]=1&acontext[action_history]=[{%22surface%22%3A%22permalink%22%2C%22mechanism%22%3A%22surface%22%2C%22extra_data%22%3A[]}]&event_id=$idEvent&initial_tab=going&__pc=EXP1%3ADEFAULT&__asyncDialog=6&__a=1";
    if (!-d "$tempDir") { mkdir("$tempDir"); }
    my $localDataFile = "$tempDir\\data.txt";
    my $mechData = WWW::Mechanize::Firefox->new(create => 1, autodie => 0, );
    $mechData->get($eventDetailsURL, synchronize => 0);
    sleep($CONFIG{'TIME_TO_WAIT'});
    my $status = $mechData->save_content($localDataFile, $tempDir);
    while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }

    # Parse html page
    open(my $tmp, $localDataFile);
    my $file_as_string = do { local $/ = <$tmp> };
    $file_as_string =~ s/[\r\n]//g;
    # Event ID
    if ($file_as_string =~ /"eventID":"([^\"]+)"/ ) {
      $winEvent->tfEventID->Text($1);
      $winEvent->tfEventName->Text($1);
    }
    # Author ID
    if ($file_as_string =~ /"authorID":"([^\"]+)"/) { $winEvent->tfAuthorID->Text($1); }
    # URL of content
    if ($file_as_string =~ /"prefetchURI":"([^\"]+)"/) {
      my $dataURL = $1;
      $dataURL =~ s#\\\/#\/#g;
      $dataURL =~ s/&amp;/&/g;
      $dataURL =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $dataURL = "https://www.facebook.com" . $dataURL . "&__pc=EXP1%3ADEFAULT&__a=1&__req=a";
      $winEvent->tfDataURL->Text($dataURL);
    }
    # Guest list name
    my %glText;
    if ($file_as_string =~ /"typeaheadSubtitles":{([^\}]+)}/) {
      my $data = $1;
      my @lists = split(/,/, $data);
      foreach (@lists) {
        my ($lname, $ltext) = split(/:/, $_);
        $lname =~ s/"//g;
        $ltext =~ s/"//g;
        $glText{$lname} = $ltext;
      }
    }
    # Guest list members count
    my %glCount;
    if ($file_as_string =~ /"adminRSVPNuxCount":0,"counts":{([^\}]+)}/) {
      my $data = $1;
      my @lists = split(/,/, $data);
      foreach (@lists) {
        my ($lname, $lcount) = split(/:/, $_);
        $lname =~ s/"//g;
        $glCount{$lname} = $lcount;
      }
    }
    close($tmp);
    # Adjust Guest list checkbox text
    if ($glCount{'going'}    and $glText{'going'}   ) {
      my $encodedStr = encode($CONFIG{'CHARSET'}, "$glText{'going'} [$glCount{'going'}]");
      $encodedStr =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $winEvent->chGoing->Text($encodedStr);
    }
    if ($glCount{'maybe'}    and $glText{'maybe'}   ) {
      my $encodedStr = encode($CONFIG{'CHARSET'}, "$glText{'maybe'} [$glCount{'maybe'}]");
      $encodedStr =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $winEvent->chMaybe->Text($encodedStr);
    }
    if ($glCount{'invited'}  and $glText{'invited'} ) {
      my $encodedStr = encode($CONFIG{'CHARSET'}, "$glText{'invited'} [$glCount{'invited'}]");
      $encodedStr =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $winEvent->chInvited->Text($encodedStr);
    }
    if ($glCount{'declined'} and $glText{'declined'}) {
      my $encodedStr = encode($CONFIG{'CHARSET'}, "$glText{'declined'} [$glCount{'declined'}]");
      $encodedStr =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
      $winEvent->chDeclined->Text($encodedStr);
    }
    
    # Delete temporary files
    if ($winConfig->chDelTempFiles->Checked()) { remove_tree($tempDir); }
  } else { Win32::GUI::MessageBox($winEvent, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  $winEvent->lblInProgress->Text('');
  $winEvent->ChangeCursor($ARROW);
  
  # Ready ?
  &isDumpEventReady();

}  #--- End winEventThr

#--------------------------#
sub tfEventName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();

  # Remember the save dir
  if ($saveDir and -d $saveDir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'DIR_SAVE_EVENT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpEventReady();

}  #--- End tfEventName_Change

#--------------------------#
sub tfDirSaveEvent_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winEvent->tfDirSaveEvent->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'DIR_SAVE_EVENT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpEventReady();

}  #--- End tfDirSaveEvent_Change

#--------------------------#
sub btnDirSaveEvent_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winEvent->tfDirSaveEvent->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winEvent      ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winEvent      ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winEvent->tfDirSaveEvent->Text($dir);
  }
  
}  #--- End btnDirSaveEvent_Click

#--------------------------#
sub btnBrowseDirSaveEvent_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winEvent->tfDirSaveEvent->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveEvent_Click

#--------------------------#
sub chSaveEventDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winEvent->tfDirSaveEvent->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_EVENT'} = 1;
    $CONFIG{'DIR_SAVE_EVENT'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winEvent->chSaveEventDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_EVENT'} = 0;
    delete($CONFIG{'DIR_SAVE_EVENT'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveEventDir_Click

#--------------------------#
sub chGoing_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chGoing_Click

#--------------------------#
sub chMaybe_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chMaybe_Click

#--------------------------#
sub chInvited_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chInvited_Click

#--------------------------#
sub chDeclined_Click
#--------------------------#
{
  # Ready ?
  &isDumpEventReady();

}  #--- End chDeclined_Click

#--------------------------#
sub isDumpEventReady
#--------------------------#
{
  # Local variables
  my $eventName = $winEvent->tfEventName->Text();
  my $saveDir   = $winEvent->tfDirSaveEvent->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$eventName) {
    $winEvent->btnEventOk->Disable();
    return(0);
  }
  
  # No selected lists
  if (!$winEvent->chGoing->Checked()   and !$winEvent->chMaybe->Checked()   and
      !$winEvent->chInvited->Checked() and !$winEvent->chDeclined->Checked()) {
    $winEvent->btnEventOk->Disable();
    return(0);
  }

  $winEvent->btnEventOk->Enable();

}  #--- End isDumpEventReady

#--------------------------#
sub chEventProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winEvent->chEventProfileIcons->Checked()) {
    $CONFIG{'EVENT_PROFILE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'EVENT_PROFILE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chEventProfileIcons_Click

#--------------------------#
sub chEventOpenXLSX_Click
#--------------------------#
{
  # Save the choice
  if ($winEvent->chEventOpenXLSX->Checked()) {
    $CONFIG{'EVENT_OPEN_XLSX'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'EVENT_OPEN_XLSX'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chEventOpenXLSX_Click

#--------------------------#
sub btnEventOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winEvent->AbsLeft();
      my $winTop  = $winEvent->AbsTop();
      $CONFIG{'WINEVENT_LEFT'} = $winLeft;
      $CONFIG{'WINEVENT_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $eventName = $winEvent->tfEventName->Text();
    $eventName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir   = $winEvent->tfDirSaveEvent->Text();
    my %lists;
    my $nbrRetries = 0;
    my $count      = 0;
    my $step       = 1;

    if ($eventName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpEvent, $eventName, $saveDir, \%lists, $nbrRetries, $count, $step);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnEventOk_Click

#--------------------------#
sub dumpEvent
#--------------------------#
{
  # Local variables
  my ($eventName, $saveDir, $refLists, $nbrRetries, $count, $step) = @_;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpEventC'});
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    &winPb2_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $winPb2->lblPbCurr->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpEvent, $eventName, $saveDir, $refLists, $nbrRetries, $count, $step);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
			Win32::GUI::MessageBox($winPb2, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };

  # First execution
  if (!$count) {
    # Turn on progress bar
    $winPb2->Center($winEvent);
    $winPb2->Show();
    $win->Disable();
    
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpEventP'}.'...');
  }
  
  # Selected list
  my %selectedLists;
  if ($winEvent->chGoing->Checked()   ) { $selectedLists{'going'}    = 1; }
  if ($winEvent->chMaybe->Checked()   ) { $selectedLists{'maybe'}    = 1; }
  if ($winEvent->chInvited->Checked() ) { $selectedLists{'invited'}  = 1; }
  if ($winEvent->chDeclined->Checked()) { $selectedLists{'declined'} = 1; }
  
  # Connect to current tab
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($winPb2, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Target url
  my $currURL   = $mech->uri();
  my $targetURL = $winEvent->tfDataURL->Text();
  if ($step == 1) {
    if ($targetURL) {
      $winPb2->lblPbCurr->Text($STR{'dumpEventP'}.'...');
    
      # Download the data
      if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
      if (!-d "$saveDir\\images_$eventName") { mkdir("$saveDir\\images_$eventName"); }
      my $localDataFile = "$saveDir\\temp\\data.txt";
      if (my $mechData = WWW::Mechanize::Firefox->new(tab => qr{'www.facebook.com/events/ajax/guest_list'}, create => 1, autodie => 0, )) {
        $mechData->get($targetURL, synchronize => 1);
        my $status = $mechData->save_content($localDataFile);
        while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
      }
      
      # Parse the data
      open(my $tmp, '<:encoding(UTF-8)', $localDataFile);
      my $data = do { local $/ = <$tmp> };
      close($tmp);
      $data =~ s/[\r\n]//g;
      my @tabData = split(/},/, $data);
      undef $data;
      my $nbrLines = scalar(@tabData);
      foreach my $line (@tabData) {
        my %memberData;
        if ($line =~ /{("uniqueID":[^\}]+)}/) {
          my @fields = split(/,/, $1);
          foreach my $field (@fields) {
            my ($key, $value) = split(/:[^\\]/, $field);
            $key   =~ s/"//g;
            $value =~ s/"//g;
            $memberData{$key} = $value;
          }
          
          # Save member data
          if ($memberData{'uniqueID'} and $memberData{'tab'} and
              exists($selectedLists{$memberData{'tab'}}) and
              !exists($$refLists{$memberData{'tab'}}{'profilUrl'}{$memberData{'uniqueID'}})) {
            # Url
            if (!exists($$refLists{$memberData{'tab'}}{'url'})) { $$refLists{$memberData{'tab'}}{'url'} = $currURL; }
            # Profil order
            $$refLists{$memberData{'tab'}}{'profilOrder'}{$count} = $memberData{'uniqueID'};
            # Profil URL
            if ($memberData{'uri'}) {
              $memberData{'uri'} =~ s#\\\/#\/#g;
              $$refLists{$memberData{'tab'}}{'profilUrl'}{$memberData{'uniqueID'}} = $memberData{'uri'};
            }
            # Profil Img
            if ($memberData{'photo'}) {
              $memberData{'photo'} =~ s#\\\/#\/#g;
              $memberData{'photo'} =~ s/&amp;/&/g;
              $$refLists{$memberData{'tab'}}{'profilImg'}{$memberData{'uniqueID'}} = $memberData{'photo'};
              # Download the image
              if ($winEvent->chEventProfileIcons->Checked()) {
                if (!-e("$saveDir\\images_$eventName\\$memberData{'uniqueID'}\.jpg")) {
                  $mech->save_url($memberData{'photo'}, "$saveDir\\images_$eventName\\$memberData{'uniqueID'}\.jpg");
                }
              }
            }
            # Profil Name
            if ($memberData{'title'}) {
              my $name = $memberData{'title'};
              $name =~ s/\\u([[:xdigit:]]{4})/chr(hex $1)/eg;
              $$refLists{$memberData{'tab'}}{'profilName'}{$memberData{'uniqueID'}} = $name;
            }
            $count++;
          }
        } else { $count++; }
        $winPb2->lblCount->Text("$count/$nbrLines");
      }
      $step = 2;
    } else {
      Win32::GUI::MessageBox($winPb2, $STR{'err6'}, $STR{'err1T'}, 0x40010);
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => $STR{'dumpEventC'});
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      &winPb2_Terminate;
      threads->exit();
    }
  }
  
  # Check profile icons
  if ($winEvent->chEventProfileIcons->Checked() and $step == 2) {
    $winPb2->lblPbCurr->Text($STR{'checkIcons'}.'...');
    my $count2 = 0;
    foreach my $guestList (keys %{$refLists}) {
      foreach my $id (keys %{$$refLists{$guestList}{'profilImg'}}) {
        $count2++;
        $winPb2->lblCount->Text($count2);
        my $imgPath = "$saveDir\\images_$eventName\\$id\.jpg";
        if (!-e $imgPath and $$refLists{$guestList}{'profilImg'}{$id}) { # Profile icon doesn't exist, try to download
          $mech->save_url($$refLists{$guestList}{'profilImg'}{$id}, "$saveDir\\images_$eventName\\$id\.jpg");
        }
        # Check again
        if (-e $imgPath) { # Profile icon exists, check infos
          my $info = image_info($imgPath);
          my $dim;
          if (!$info->{error}) { $dim = dim($info); } # No error, get dim
          if (($info->{error} or !$dim) and $$refLists{$guestList}{'profilImg'}{$id}) { # Error with the image or no dim, try to download again
            unlink("$saveDir\\images_$eventName\\$id\.jpg");
            $mech->save_url($$refLists{$guestList}{'profilImg'}{$id}, "$saveDir\\images_$eventName\\$id\.jpg");
            $info = image_info($imgPath);
          }
          # No error, replace profile icon URL by profile icon path
          if (!$info->{error}) {
            $dim = dim($info);
            if ($dim) { $$refLists{$guestList}{'profilImg'}{$id} = "images_$eventName\\$id\.jpg"; }
          }
        }
      }
    }
    $step = 3;
  }
  
  # Save in a XLSX file
  $winPb2->lblPbCurr->Text($STR{'createXLSX'}.'...');
  my $nbrMembers = $count;
  if ($nbrMembers) {
		# Create and open the XLSX file
    my $filename = "$saveDir\\$eventName\.xlsx";
    my $excel;
		my $count = 1;
		while (!($excel = Excel::Writer::XLSX->new($filename))) { # If file is already open, must be renamed
			$filename = "$saveDir\\$eventName [".$count++."]\.xlsx";
			if ($count == 10) { last; } # Stop after 10 attempts
		}
    
    # A sheet for each guest list
    foreach my $guestList (sort keys %{$refLists}) {
      &createExcelSheetWithDetails(\$excel, $guestList, $$refLists{$guestList}, $winEvent->chEventProfileIcons->Checked(), $saveDir);
    }
    
    $excel->close(); # Close XLSX file
    
    # Open the file
    if ($winEvent->chEventOpenXLSX->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
  }

  # Turn off progress bar
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;
  
  # Delete temporary files
  #if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }

  $win->Tray->Change(-tip => $STR{'dumpEventF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpEventF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpEvent

#--------------------------#
sub winEvent_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winEvent->AbsLeft();
    my $winTop  = $winEvent->AbsTop();
    $CONFIG{'WINEVENT_LEFT'} = $winLeft;
    $CONFIG{'WINEVENT_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winEvent_Terminate

#--------------------------#
sub winContrib
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winContribThr);
    
    usleep(500000);
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINCONTRIB_LEFT'} and $CONFIG{'WINCONTRIB_TOP'}) {
      $winContrib->Left($CONFIG{'WINCONTRIB_LEFT'});
      $winContrib->Top($CONFIG{'WINCONTRIB_TOP'});
    } else { $winContrib->Center(); }
    $winContrib->DoModal();
  }

}  #--- End winContrib

#--------------------------#
sub winContribThr
#--------------------------#
{
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winContribThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winContrib, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winContrib->btnContribOk->Disable();
      Win32::GUI::MessageBox($winContrib, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  my $currURL  = $mech->uri();
  if ($currURL =~ /facebook.com/) {
    my $title;
		if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $title = $1; }
    elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $title = $1; }
    if ($title =~ /#$/) { chop($title); }
    $winContrib->tfContribName->Text($title);
  } else {
    $winContrib->btnContribOk->Disable();
    Win32::GUI::MessageBox($winContrib, $STR{'warn4'}, $STR{'warn2T'}, 0x40010);
  }
  
  # Ready ?
  &isDumpContribReady();

}  #--- End winContribThr

#--------------------------#
sub tfContribName_Change
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End tfContribName_Change

#--------------------------#
sub tfDirSaveContrib_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winContrib->tfDirSaveContrib->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'DIR_SAVE_CONTRIB'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpContribReady();

}  #--- End tfDirSaveContrib_Change

#--------------------------#
sub btnDirSaveContrib_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winContrib->tfDirSaveContrib->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winContrib    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winContrib    ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winContrib->tfDirSaveContrib->Text($dir);
  }
  
}  #--- End btnDirSaveContrib_Click

#--------------------------#
sub btnBrowseDirSaveContrib_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winContrib->tfDirSaveContrib->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveContrib_Click

#--------------------------#
sub chSaveContribDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winContrib->tfDirSaveContrib->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CONTRIB'} = 1;
    $CONFIG{'DIR_SAVE_CONTRIB'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winContrib->chSaveContribDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CONTRIB'} = 1;
    delete($CONFIG{'DIR_SAVE_CONTRIB'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveContribDir_Click

#--------------------------#
sub chContribProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winContrib->chContribProfileIcons->Checked()) {
    $CONFIG{'CONTRIB_PROFILE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'CONTRIB_PROFILE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chContribProfileIcons_Click

#--------------------------#
sub chContribOpenXLSX_Click
#--------------------------#
{
  # Save the choice
  if ($winContrib->chContribOpenXLSX->Checked()) {
    $CONFIG{'CONTRIB_OPEN_XLSX'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'CONTRIB_OPEN_XLSX'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chContribOpenXLSX_Click

#--------------------------#
sub chContribComments_Click
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribComments_Click

#--------------------------#
sub chContribLikes_Click
#--------------------------#
{
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribLikes_Click

#--------------------------#
sub chContribVPosts_Click
#--------------------------#
{
  if ($winContrib->chContribVPosts->Checked()) {
    $winContrib->chContribDontScrollVPosts->Enable();
  } else { $winContrib->chContribDontScrollVPosts->Disable(); }
  
  # Ready ?
  &isDumpContribReady();

}  #--- End chContribVPosts_Click

#--------------------------#
sub isDumpContribReady
#--------------------------#
{
  # Local variables
  my $contribName = $winContrib->tfContribName->Text();
  my $saveDir     = $winContrib->tfDirSaveContrib->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$contribName) { $winContrib->btnContribOk->Disable(); return(0); }
  
  # At least one type checked
  if (!$winContrib->chContribComments->Checked() and
      !$winContrib->chContribLikes->Checked()    and
      !$winContrib->chContribVPosts->Checked()) {
    $winContrib->btnContribOk->Disable();
    return(0);
  }

  $winContrib->btnContribOk->Enable();

}  #--- End isDumpContribReady

#--------------------------#
sub btnContribOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winContrib->AbsLeft();
      my $winTop  = $winContrib->AbsTop();
      $CONFIG{'WINCONTRIB_LEFT'} = $winLeft;
      $CONFIG{'WINCONTRIB_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $contribName = $winContrib->tfContribName->Text();
    $contribName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir     = $winContrib->tfDirSaveContrib->Text();
    my %comments;
    my %likePages;
    my %likes;
    my %vPosts;
    my $nbrComments   = 0;
    my $nbrLikePages  = 0;
    my $nbrLikes      = 0;
    my $nbrVPosts     = 0;
    my $nbrRetries    = 0;
    my $step          = 1;
    my $done          = 0;
    my $count         = 0;

    if ($contribName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpContrib, $contribName, $saveDir, \%comments, \%likePages,
                             \%likes, \%vPosts, $nbrComments, $nbrLikePages, $nbrLikes, $nbrVPosts,
                             $nbrRetries, $step, $done, $count);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnContribOk_Click

#--------------------------#
sub dumpContrib
#--------------------------#
{
  # Local variables
  my ($contribName, $saveDir, $refComments, $refLikePages, $refLikes, $refVPosts, $nbrComments,
      $nbrLikePages, $nbrLikes, $nbrVPosts, $nbrRetries, $step, $done, $count) = @_;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpContribC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpContrib, $contribName, $saveDir, $refComments, $refLikePages,
                             $refLikes, $refVPosts, $nbrComments, $nbrLikePages, $nbrLikes, $nbrVPosts,
                             $nbrRetries, $step, $done, $count);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
			Win32::GUI::MessageBox($winPb2, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };
  
  # Connect to current tab
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($winPb2, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  # Operations
  # $step == 1 : Save the page
  # $step == 2 : Dump Contributors - Comments
  # $step == 3 : Dump Contributors - Likes
  # $step == 4 : Dump Contributors - VPosts
  # $step == 5 : Create Excel Sheet - Comments
  # $step == 6 : Create Excel Sheet - Likes
  # $step == 7 : Create Excel Sheet - VPosts
  
  my $currURL  = $mech->uri();
  if ($currURL =~ /#$/) { chop($currURL); }
  my $nbrOperations = 1;
  if ($winContrib->chContribComments->Checked()) { $nbrOperations += 2; }
  if ($winContrib->chContribLikes->Checked()   ) { $nbrOperations += 2; }
  if ($winContrib->chContribVPosts->Checked()  ) { $nbrOperations += 2; }
  
  # Save page content
  if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
  my $localDataFile = "$saveDir\\temp\\temp.html";

  # First execution
  if ($step == 1) {
    # Turn on progress bar
    $winPb->Center($winContrib);
    $winPb->Show();
    $win->Disable();
    $winPb->lblCount1->Text("0/$nbrOperations");
    $winPb->pbWinPb1->SetRange(0, $nbrOperations);
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb1->SetStep(1);
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpContribP'}.'...');
    
    # Save current tab
    $winPb->lblPbCurr1->Text($STR{'saveTab'}.'...');
    my $status = $mech->save_content($localDataFile);
    while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
    
    # Create image folder
    if (!-d "$saveDir\\images_$contribName" and $winContrib->chContribProfileIcons->Checked()) {
      mkdir("$saveDir\\images_$contribName");
    }
    $step = 2;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  }

  # Gather Comment Contributors
  if ($winContrib->chContribComments->Checked() and $step == 2) {
    $winPb->lblPbCurr1->Text($STR{'dumpCommentsP'}.'...');
    
    # First execution
    if (!$nbrComments) {
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
    } else { $nbrComments--; } # If resume, start from last processed
    
    my @commentNodes;
    if (open(my $fhTemp, "<:encoding(UTF-8)", $localDataFile)) {
      my $file_as_string = do { local $/ = <$fhTemp> };
      $file_as_string =~ s/[\r\n]//g;
      @commentNodes = split(/UFIImageBlockImage/, $file_as_string);
      shift(@commentNodes);
      close($fhTemp);
    }
    
    #my @commentNodes = $mech->selector('a.UFIImageBlockImage');
    my $nbrCommentsToDo = scalar(@commentNodes);
    $winPb->pbWinPb2->SetRange(0, $nbrCommentsToDo);
    $winPb->pbWinPb2->SetStep(1);
    $winPb->lblCount2->Text("$nbrComments/$nbrCommentsToDo");
    my $i = 0;
    foreach my $commentNode (@commentNodes) {
      if ($i >= $nbrComments) {
        my $commentId;
        my $commentUrl;
        my $commentImg;
        my $commentName;
        if ($commentNode =~ /href="([^\&\"]+)(?:&|")[^\>]+hovercard.php\?id=([^\&\"]+)(?:&|")/) {
          $commentUrl  = $1;
          $commentUrl  =~ s/&amp;/&/g;
          $commentId   = $2;
        } elsif ($commentNode =~ /hovercard.php\?id=([^\&\"]+)(?:&|")[^\>]+href="([^\&\"]+)(?:&|")/) {
          $commentId   = $1;
          $commentUrl  = $2;
          $commentUrl  =~ s/&amp;/&/g;
        }
        if ($commentNode =~ /src="([^\"]+)"/) { $commentImg  = $1; }
        if ($commentNode =~ /alt="([^\"]+)"/) { $commentName = $1; }
        
        if ($commentUrl and $commentId and $commentImg and $commentName and $commentName ne $contribName) {
          if ($currURL =~ /$commentId/) { } # On photo page, profile owner id
          else {
            $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $commentId...");
  
            # Already exists, count
            if (exists($$refComments{$commentUrl}{'Nbr'})) {
              $$refComments{$commentUrl}{'Nbr'}++;
            # Add a new entry
            } else {
              $$refComments{$commentUrl}{'Nbr'}  = 1;
              $$refComments{$commentUrl}{'Id'}   = $commentId;
              $$refComments{$commentUrl}{'Name'} = $commentName;
              
              # Include profile icon
              if ($winContrib->chContribProfileIcons->Checked() and $commentImg) {
                my $imgUrl = $commentImg =~ s/&amp;/&/gr;
                if (!-e("$saveDir\\images_$contribName\\$commentId\.jpg")) {
                  $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$commentId\.jpg");
                # File already exists, test if corrupted, if so, download it again
                } else {
                  my $info = image_info("$saveDir\\images_$contribName\\$commentId\.jpg");
                  if ($info->{error}) {
                    $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$commentId\.jpg");
                  }
                }
                $$refComments{$commentUrl}{'ImgPath'} = "images_$contribName\\$commentId\.jpg";
              }
            }
          }
        }
        $nbrComments++;
        $winPb->pbWinPb2->StepIt();
        $winPb->lblCount2->Text("$nbrComments/$nbrCommentsToDo");
      }
      $i++;
    }
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 3;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribComments->Checked()) { $step = 3; }
  
  # Gather Likes
  if ($winContrib->chContribLikes->Checked() and $step == 3) {
    $winPb->lblPbCurr1->Text($STR{'dumpLikesP'}.'...');
   
    # First execution, gather like page urls
    if (!$nbrLikePages and !$nbrLikes) {
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
      
      # Parse the page
      if (open(my $fhTemp, "<:encoding(UTF-8)", $localDataFile)) {
        my $file_as_string = do { local $/ = <$fhTemp> };
        $file_as_string =~ s/[\r\n]//g;
        my @section = split(/fbTimelineSection fbTimelineCompactSection fbTimelineSectionTransparent/, $file_as_string);
        undef($file_as_string);
        foreach my $section (@section) {
          my @parts = split(/_ipp/, $section);
          shift(@parts);
          foreach my $part (@parts) {
            if ($part =~ /href=\"([^\"]+)\"/) {
              my $url = $1;
              if ($url =~ /ft_ent_identifier/) {
                $url =~ s/&amp;/&/g;
                if (!exists($$refLikePages{$url})) { $$refLikePages{$url} = 0; }
              }
            }
          }
          my @parts2 = split(/UFICommentLikeButton/, $section);
          shift(@parts2);
          foreach my $part (@parts2) {
            if ($part =~ /href=\"([^\"]+)\"/) {
              my $url = $1;
              if ($url =~ /likes/) {
                $url =~ s/&amp;/&/g;
                if (!exists($$refLikePages{$url})) { $$refLikePages{$url} = 0; }
              }
            }
          }
        }
        close($fhTemp);
      }
      
      # Set progress bar
      $nbrLikePages = scalar(keys %{$refLikePages});
      $winPb->pbWinPb2->SetRange(0, $nbrLikePages);
      $winPb->pbWinPb2->SetPos(0);
      $winPb->pbWinPb2->SetStep(1);
      $winPb->lblCount2->Text("0/$nbrLikePages");
    }
    
    if ($nbrLikePages > 0) {
      # Connect to Firefox (creates a new tab at first execution)
      my $mechLikePage = WWW::Mechanize::Firefox->new(tab => qr{Facebook}, create => 1, autodie => 0);
      
      foreach my $likePageUrl (sort keys %{$refLikePages}) {
        # Get the page, scroll to bottom then save the page content
        $winPb->lblPbCurr2->Text("$STR{'opening'} $likePageUrl...");
        $mechLikePage->get($likePageUrl, synchronize => 0);
        sleep($CONFIG{'TIME_TO_WAIT'});
        $winPb->lblPbCurr2->Text("$STR{'scrolling'} $likePageUrl...");
        &scrollLikePage(\$mechLikePage, $CONFIG{'TIME_TO_WAIT'});
        $winPb->lblPbCurr2->Text("$STR{'downloading'} $likePageUrl...");
        my $htmlPage = "$saveDir\\temp\\likePage.html";
        my $status;
        if ($winContrib->chContribProfileIcons->Checked()) {
          $status = $mechLikePage->save_content($htmlPage, "$saveDir\\temp");
        } else { $status = $mechLikePage->save_content($htmlPage); }
        while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { usleep(100000); }
        
        my $i = 0;
        
        # Gather each profile details
        my @likeProfiles;
        $winPb->lblPbCurr2->Text("$STR{'parsing'} $likePageUrl...");
        if (open(my $fhTemp, "<:encoding(UTF-8)", $htmlPage)) {
          my $file_as_string = do { local $/ = <$fhTemp> };
          $file_as_string =~ s/[\r\n]//g;
          @likeProfiles     = split(/_5i_q/, $file_as_string);
          shift(@likeProfiles);
          my @likeProfiles2 = split(/fbProfileBrowserListItem/, $file_as_string);
          shift(@likeProfiles2);
          push(@likeProfiles, @likeProfiles2);
          undef($file_as_string);
          close($fhTemp);
        }
        
        foreach my $likeProfile (@likeProfiles) {
          if ($i >= $$refLikePages{$likePageUrl}) {
            my $likeId;
            my $likeUrl;
            my $likeImg;
            my $likeName;
            
            # Gather url and id
            if ($likeProfile =~ /<(a[^\>]+)\>\<([^\<]+)\</) {
              my $profileTag = $1;
              my $imgTag     = $2;
              if ($profileTag =~ /href="([^\&\"]+)(?:&|")[^\>]+data-hovercard="([^\"]+)\"/) {
                $likeUrl = $1;
                my $temp = $2;
                if ($temp =~ /hovercard\/user\.php\?id=([^\&]+)&/) { $likeId = $1; }
              }
            }
            # Gather Image link
            if ($likeProfile =~ / src="([^\"]+)\"/) { $likeImg = $1; }
            # Gather name
            if ($likeProfile =~ /\<a[^\>]+\>([^\<]+)\</) { $likeName = $1; }
            
            if ($likeUrl and $likeId and $likeImg and $likeName and $likeName ne $contribName) {
              if ($currURL =~ /$likeId/) { } # On photo page, profile owner id
              else {
                # Already exists, count
                if (exists($$refLikes{$likeUrl}{'Nbr'})) {
                  $$refLikes{$likeUrl}{'Nbr'}++;
                # Add a new entry
                } else {
                  $nbrLikes++;
                  $$refLikes{$likeUrl}{'Nbr'}  = 1;
                  $$refLikes{$likeUrl}{'Id'}   = $likeId;
                  $$refLikes{$likeUrl}{'Name'} = $likeName;
                  
                  # Save the profil icon
                  if ($winContrib->chContribProfileIcons->Checked() and $likeImg =~ /\/([^\/\?]+)\?/ or $likeImg =~ /(\w+\.jpg)/) { # Include profile icons
                    my $imgFilename = $1; # Replace image name by profil id
                    if (!-e "$saveDir\\images_$contribName\\$likeId\.jpg") {
                      rcopy("$saveDir\\temp\\$imgFilename", "$saveDir\\images_$contribName\\$likeId\.jpg"); # Copy image
                    }
                    $$refLikes{$likeUrl}{'ImgPath'} = "images_$contribName\\$likeId\.jpg";
                  }
                }
              }
              $$refLikePages{$likePageUrl}++;
            }
          }
          $i++;
        }
        delete($$refLikePages{$likePageUrl});
        $winPb->pbWinPb2->StepIt();
        my $nbrLikePagesDone = $nbrLikePages - scalar(keys %{$refLikePages});
        $winPb->lblCount2->Text("$nbrLikePagesDone/$nbrLikePages");
      }
    }
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 4;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribLikes->Checked()) { $step = 4; }
  
  # Gather VPosts (Visitor Posts)
  if ($winContrib->chContribVPosts->Checked() and $step == 4) {
    $winPb->lblPbCurr1->Text($STR{'dumpVPostsP'}.'...');
    # Open the Visitor Posts popup if not already open
    my $vPostsHeader = $mech->selector('div._2h4b._50f3', any => 1);
    if (!$vPostsHeader) {
      my @vPostsUrl = $mech->selector('a._g3j');
      foreach (@vPostsUrl) {
        if ($_->{href} =~ /posts_to_page/) { $_->click(); }
      }
      sleep($CONFIG{'TIME_TO_WAIT'});
    }
    
    # First execution
    if (!$nbrVPosts) {
      if (!$winContrib->chContribDontScrollVPosts->Checked()) {
        # Display all Visitor Posts
        $winPb->lblPbCurr1->Text("$STR{'scrolling'} $STR{'chContribVPosts'}...");
        &scrollVPostsPage(\$mech, $CONFIG{'TIME_TO_WAIT'});
      }
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
      $winPb->pbWinPb2->SetPos(0);
    } else { $nbrVPosts--; } # If resume, start from last processed

    # Gather all posters    
    my @vPostsCode = $mech->selector('div._5x46');
    my $nbrVPostsToDo = scalar(@vPostsCode);
    $winPb->pbWinPb2->SetRange(0, $nbrVPostsToDo);
    $winPb->pbWinPb2->SetStep(1);
    $winPb->lblCount2->Text("$nbrVPosts/$nbrVPostsToDo");
    my $i = 0;
    foreach my $vPostCode (@vPostsCode) {
      if ($i >= $nbrVPosts) {
        my $vPostsId;
        my $vPostsUrl;
        my $vPostsImg;
        my $vPostsName;
        if ($vPostCode->{outerHTML} =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard\/user\.php\?id=([^\&\"]+)(?:&|")[^\>]+\>([^\<]+)\</) {
          $vPostsUrl  = $1;
          $vPostsId   = $2;
          $vPostsName = $3;
        }
        if ($vPostCode->{innerHTML} =~ /src="([^\"]+)"/) { $vPostsImg = $1; }
        
        if ($vPostsUrl and $vPostsId and $vPostsImg and $vPostsName and $vPostsName ne $contribName) {
          $winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $vPostsId...");

          # Already exists, count
          if (exists($$refVPosts{$vPostsUrl}{'Nbr'})) {
            $$refVPosts{$vPostsUrl}{'Nbr'}++;
          # Add a new entry
          } else {
            $$refVPosts{$vPostsUrl}{'Nbr'}  = 1;
            $$refVPosts{$vPostsUrl}{'Id'}   = $vPostsId;
            $$refVPosts{$vPostsUrl}{'Name'} = $vPostsName;
            
            # Include profile icon
            if ($winContrib->chContribProfileIcons->Checked() and $vPostsImg) {
              my $imgUrl = $vPostsImg =~ s/&amp;/&/gr;
              if (!-e("$saveDir\\images_$contribName\\$vPostsId\.jpg")) {
                $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$vPostsId\.jpg");
              # File already exists, test if corrupted, if so, download it again
              } else {
                my $info = image_info("$saveDir\\images_$contribName\\$vPostsId\.jpg");
                if ($info->{error}) {
                  $mech->save_url($imgUrl, "$saveDir\\images_$contribName\\$vPostsId\.jpg");
                }
              }
              $$refVPosts{$vPostsUrl}{'ImgPath'} = "images_$contribName\\$vPostsId\.jpg";
            }
          }
        }
        $nbrVPosts++;
        $winPb->pbWinPb2->StepIt();
        $winPb->lblCount2->Text("$nbrVPosts/$nbrVPostsToDo");
      }
      $i++;
    }
    
    # Update progress
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    $step = 5;
    $done++;
    $winPb->pbWinPb1->StepIt();
    $winPb->lblCount1->Text("$done/$nbrOperations");
  } elsif (!$winContrib->chContribVPosts->Checked()) { $step = 5; }

  
  # Create and open the XLSX file
  $winPb->lblPbCurr1->Text($STR{'createXLSX'}.'...');
  if ($nbrComments or $nbrLikes or $nbrVPosts) {
    my $filename = "$saveDir\\$contribName - $STR{'contributors'}\.xlsx";
		my $excel;
		my $count = 1;
		while (!($excel = Excel::Writer::XLSX->new($filename))) { # If file is already open, must be renamed
			$filename = "$saveDir\\$contribName - $STR{'contributors'} [".$count++."]\.xlsx";
			if ($count == 10) { last; } # Stop after 10 attempts
		}

    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb2->SetPos(0);
    
    # A sheet for each types
    # Comments
    if ($winContrib->chContribComments->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribComments'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribComments'}, $currURL, $refComments, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 5) {
        $step = 6;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribComments->Checked()) { $step = 6; }
    
    # Likes
    if ($winContrib->chContribLikes->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribLikes'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribLikes'}, $currURL, $refLikes, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 6) {
        $step = 7;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribLikes->Checked()) { $step = 7; }
    
    # VPosts
    if ($winContrib->chContribVPosts->Checked()) {
      $winPb->lblPbCurr1->Text($STR{'createSheet'}.' - '.$STR{'chContribVPosts'}.'...');
      &createExcelSheet(\$excel, $STR{'chContribVPosts'}, $currURL, $refVPosts, $winContrib->chContribProfileIcons->Checked(), $saveDir);
      if ($step == 7) {
        $step = 8;
        $done++;
        $winPb->pbWinPb1->StepIt();
        $winPb->lblCount1->Text("$done/$nbrOperations");
      }
    } elsif (!$winContrib->chContribVPosts->Checked()) { $step = 8; }
    
    $excel->close(); # Close XLSX file
    
    # Delete temporary file
    if ($winConfig->chDelTempFiles->Checked() and -d "$saveDir\\temp") { remove_tree("$saveDir\\temp"); }
    
    # Open the file
    if ($winContrib->chContribOpenXLSX->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
  }

  # Turn off progress bar
  $winPb->lblPbCurr1->Text('');
  $winPb->lblCount1->Text('');
  $winPb->lblPbCurr2->Text('');
  $winPb->lblCount2->Text('');
  $winPb->pbWinPb1->SetPos(0);
  $winPb->pbWinPb2->SetPos(0);
  &winPb_Terminate;
  
  # Delete temporary files
  if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }

  $win->Tray->Change(-tip => $STR{'dumpContribF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'             ,
                        -balloon_title => 'ExtractFace'      ,
                        -balloon_tip   => $STR{'dumpContribF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpContrib

#--------------------------#
sub createExcelSheet
#--------------------------#
{
  # Local variables
  my ($refExcel, $sheetName, $currURL, $refData, $includeIcon, $saveDir) = @_;
  
  # Create the sheet
  my $sheet = $$refExcel->add_worksheet($sheetName); # Add a sheet
  # Formats
  my $format = $$refExcel->add_format();
  $format->set_bold();
  $format->set_align( 'center' );
  $format->set_align( 'vcenter' );
  my $format2 = $$refExcel->add_format();
  $format2->set_align( 'center' );
  $format2->set_align( 'vcenter' );
  my $format3 = $$refExcel->add_format();
  $format3->set_align( 'top' );
  # Headers
  $sheet->write( 0, 0, $STR{'image'}    , $format );
  $sheet->write( 0, 1, $STR{'profilID'} , $format );
  $sheet->write( 0, 2, $STR{'url'}      , $format );
  $sheet->write( 0, 3, $STR{'name'}     , $format );
  $sheet->write( 0, 4, $STR{'imgPath2'} , $format );
  $sheet->write( 0, 5, $STR{'originURL'}, $format );
  $sheet->write( 0, 6, $STR{'count'}    , $format );
  # Create content
  my $i = 1;
  my $maxWidthCol1 = 5;
  my $maxWidthCol2 = 0;
  my $maxWidthCol3 = 0;
  my $maxWidthCol4 = 0;
  my $maxWidthCol5 = 0;
  my $maxWidthCol6 = length($currURL);
  my $maxWidthCol7 = length($STR{'count'});
  foreach my $entry (keys %{$refData}) {
    # Image column
    if ($includeIcon and -e "$saveDir\\$$refData{$entry}{'ImgPath'}") {
      my $info = image_info("$saveDir\\$$refData{$entry}{'ImgPath'}");
      if (!$info->{error}) { # Insert only if image is not corrupted
        $sheet->insert_image($i, 0, "$saveDir\\$$refData{$entry}{'ImgPath'}");
        if ($info->{height}) { # Set row height
          my $colHeight = $info->{height} / 1.33;
          $sheet->set_row($i, $colHeight);
        }
        else { $sheet->set_row($i, 30); }
        if ($info->{width}) { # Set row width
          my $colWidth = $info->{width} / 7.2;
          if ($colWidth > $maxWidthCol1) { $maxWidthCol1 = $colWidth; }
        }
      }
    }
    # Profil ID column
    $sheet->write_string($i, 1, $$refData{$entry}{'Id'});
    if (length($$refData{$entry}{'Id'}) > $maxWidthCol2) {
      $maxWidthCol2 = length($$refData{$entry}{'Id'});
    }
    # URL column
    $sheet->write($i, 2, $entry);
    if (length($entry) > $maxWidthCol3) { $maxWidthCol3 = length($entry); }
    # Name column
    if ($$refData{$entry}{'Name'}) {
      $sheet->write($i, 3, $$refData{$entry}{'Name'});
      if (length($$refData{$entry}{'Name'}) > $maxWidthCol4) {
        $maxWidthCol4 = length($$refData{$entry}{'Name'});
      }
    }
    # Image Path column
    $sheet->write($i, 4, $$refData{$entry}{'ImgPath'});
    if (length($$refData{$entry}{'ImgPath'}) > $maxWidthCol5) {
      $maxWidthCol5 = length($$refData{$entry}{'ImgPath'});
    }
    # Original URL column
    $sheet->write($i, 5, $currURL);
    # Count
    $sheet->write($i, 6, $$refData{$entry}{'Nbr'});
    $i++;
  }
  # Ajust column size
  $sheet->set_column(1, 6, undef, $format3);
  $sheet->set_column(0, 0, $maxWidthCol1, $format2);
  $sheet->set_column(1, 1, $maxWidthCol2);
  $sheet->set_column(2, 2, $maxWidthCol3);
  $sheet->set_column(3, 3, $maxWidthCol4);
  $sheet->set_column(4, 4, $maxWidthCol5);
  $sheet->set_column(5, 5, $maxWidthCol6);
  $sheet->set_column(6, 6, $maxWidthCol7);

}  #--- End createExcelSheet

#--------------------------#
sub winContrib_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winContrib->AbsLeft();
    my $winTop  = $winContrib->AbsTop();
    $CONFIG{'WINCONTRIB_LEFT'} = $winLeft;
    $CONFIG{'WINCONTRIB_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winContrib_Terminate

#--------------------------#
sub winGroupMembers
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winGroupMembers->tfGroupMembersName->Text('');
    
    # Start the thread
    $THR = threads->create(\&winGroupMembersThr);
    
    usleep(500000);
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINGROUP_MEMBERS_LEFT'} and $CONFIG{'WINGROUP_MEMBERS_TOP'}) {
      $winGroupMembers->Left($CONFIG{'WINGROUP_MEMBERS_LEFT'});
      $winGroupMembers->Top($CONFIG{'WINGROUP_MEMBERS_TOP'});
    } else { $winGroupMembers->Center(); }
    $winGroupMembers->DoModal();
  }

}  #--- End winGroupMembers

#--------------------------#
sub btnGroupMembersRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winGroupMembers->tfGroupMembersName->Text('');
    $THR = threads->create(\&winGroupMembersThr);
  }
  
}  #--- End btnGroupMembersRefresh_Click

#--------------------------#
sub winGroupMembersThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winGroupMembersThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winGroupMembers, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winGroupMembers->btnGroupMembersOk->Disable();
      Win32::GUI::MessageBox($winGroupMembers, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    # Valid current page
    my $currURL = $mech->uri();
    my $idGroup;
		# Get the right page
		if ($currURL =~ /https:\/\/www.facebook.com\/groups\/(\d+)$/) {
			$mech->get("https://www.facebook.com/browse/group_members/?gid=$1&edge=groups%3Amembers", synchronize => 0);
			sleep($CONFIG{'TIME_TO_WAIT'});
			$currURL = $mech->uri();
		}
		# Right page, get the values
    if ($currURL =~ /https:\/\/www.facebook.com\/browse\/group_members\/\?gid=(\d+)/) {
			$winGroupMembers->tfGroupMembersName->Text($1);
			$winGroupMembers->lvGroupMembersListSel->DeleteAllItems();
			my @listFromCombo = $mech->selector('a._54nc span._54nh');
			if (!scalar(@listFromCombo) and my $currList = $mech->selector('div.uiPopover span._55pe', any => 1)) {
				$currList->click;
				@listFromCombo = $mech->selector('a._54nc span._54nh');
			}
			foreach my $list (@listFromCombo) {
				$winGroupMembers->lvGroupMembersListSel->InsertItem(-text => $list->{innerHTML});
			}
		# Wrong page
		} else {
      $winGroupMembers->btnGroupMembersOk->Disable();
      Win32::GUI::MessageBox($winGroupMembers, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    }
  } else { Win32::GUI::MessageBox($winGroupMembers, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }

  $winGroupMembers->ChangeCursor($ARROW);
  
  # Ready ?
  &isDumpGroupMembersReady();

}  #--- End winGroupMembersThr

#--------------------------#
sub tfGroupMembersName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winGroupMembers->chSaveGroupMembersDir->Checked()) {
    $CONFIG{'DIR_SAVE_GROUP_MEMBERS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpGroupMembersReady();

}  #--- End tfGroupMembersName_Change

#--------------------------#
sub cbGroupMembersFormat_Change
#--------------------------#
{
  # No profile icon for txt format
  if ($winGroupMembers->cbGroupMembersFormat->GetCurSel() == 2) {
    $winGroupMembers->chGroupMembersProfileIcons->Disable();
  } else { $winGroupMembers->chGroupMembersProfileIcons->Enable(); }
  
}  #--- End cbGroupMembersFormat_Change

#--------------------------#
sub tfDirSaveGroupMembers_Change
#--------------------------#
{
  # Local variables
  my $GroupMembersName = $winGroupMembers->tfGroupMembersName->Text();
  my $saveDir          = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winGroupMembers->chSaveGroupMembersDir->Checked()) {
    $CONFIG{'DIR_SAVE_GROUP_MEMBERS'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpGroupMembersReady();

}  #--- End tfDirSaveGroupMembers_Change

#--------------------------#
sub btnDirSaveGroupMembers_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winGroupMembers->tfDirSaveGroupMembers->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winGroupMembers	,
                                        -title      => $STR{'selDir'} 	,
                                        -folderonly => 1              	,
                                        -directory  => $lastDir       	,
                                        -newui      => 1              	, );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winGroupMembers	,
                                        -title      => $STR{'selDir'} 	,
                                        -folderonly => 1              	,
                                        -newui      => 1              	, );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winGroupMembers->tfDirSaveGroupMembers->Text($dir);
  }
  
}  #--- End btnDirSaveGroupMembers_Click

#--------------------------#
sub btnBrowseDirSaveGroupMembers_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveGroupMembers_Click

#--------------------------#
sub chSaveGroupMembersDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winGroupMembers->chSaveGroupMembersDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_GROUP_MEMBERS'} = 1;
    $CONFIG{'DIR_SAVE_GROUP_MEMBERS'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winGroupMembers->chSaveGroupMembersDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_GROUP_MEMBERS'} = 0;
    delete($CONFIG{'DIR_SAVE_GROUP_MEMBERS'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveGroupMembersDir_Click

#--------------------------#
sub chGroupMembersProfileIcons_Click
#--------------------------#
{
  # Save the choice
  if ($winGroupMembers->chGroupMembersProfileIcons->Checked()) {
    $CONFIG{'GROUP_MEMBERS_INCLUDE_ICONS'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'GROUP_MEMBERS_INCLUDE_ICONS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chGroupMembersProfileIcons_Click

#--------------------------#
sub chGroupMembersOpenOutput_Click
#--------------------------#
{
  # Save the choice
  if ($winGroupMembers->chGroupMembersOpenOutput->Checked()) {
    $CONFIG{'GROUP_MEMBERS_OPEN_OUTPUT'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'GROUP_MEMBERS_OPEN_OUTPUT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chGroupMembersOpenOutput_Click

#--------------------------#
sub lvGroupMembersListSel_ItemCheck
#--------------------------#
{
  &isDumpGroupMembersReady();
	
}  #--- End lvGroupMembersListSel_ItemCheck

#--------------------------#
sub isDumpGroupMembersReady
#--------------------------#
{
  # Local variables
  my $GroupMembersName = $winGroupMembers->tfGroupMembersName->Text();
  my $saveDir          = $winGroupMembers->tfDirSaveGroupMembers->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$GroupMembersName) {
    $winGroupMembers->btnGroupMembersOk->Disable();
    return(0);
  }
  
  # No selected lists
	my $nbrSel = 0;
  for (my $i = 0; $i < $winGroupMembers->lvGroupMembersListSel->GetItemCount(); $i++) {
		if ($winGroupMembers->lvGroupMembersListSel->GetCheckState($i)) { $nbrSel++; }
	}
	if (!$nbrSel) {
    $winGroupMembers->btnGroupMembersOk->Disable();
    return(0);
  }

  $winGroupMembers->btnGroupMembersOk->Enable();

}  #--- End isDumpGroupMembersReady

#--------------------------#
sub btnGroupMembersOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winGroupMembers->AbsLeft();
      my $winTop  = $winGroupMembers->AbsTop();
      $CONFIG{'WINGROUP_MEMBERS_LEFT'} = $winLeft;
      $CONFIG{'WINGROUP_MEMBERS_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $groupMembersName  	= $winGroupMembers->tfGroupMembersName->Text();
    $groupMembersName     	=~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir           	= $winGroupMembers->tfDirSaveGroupMembers->Text();
    my %listGroupMembers; 	# Actually, two type : Admins and Other members
    my $nbrLists            = 0;
    my $posPb1            	= 0;
    my $parsingDone       	= 0;
    my $nbrGroupMembersDone = 0;
    my $nbrRetries          = 0;

    if ($groupMembersName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpGroupMembers, $groupMembersName, $saveDir, \%listGroupMembers, $nbrLists, 
                             $nbrGroupMembersDone, $posPb1, $parsingDone, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnGroupMembersOk_Click

#--------------------------#
sub dumpGroupMembers
#--------------------------#
{
  # Local variables
  my ($groupMembersName, $saveDir, $refListGroupMembers, $nbrLists, $nbrGroupMembersDone, $posPb1, $parsingDone, $nbrRetries) = @_;
  my $includeIcons = $winGroupMembers->chGroupMembersProfileIcons->Checked();
  my $format       = $winGroupMembers->cbGroupMembersFormat->GetCurSel(); # report format
  my $firstExec    = 0;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpGroupMembersC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    $posPb1 = $winPb->pbWinPb1->GetPos();
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) {
      $nbrRetries++;
      # Progress window
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
    }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpGroupMembers, $groupMembersName, $saveDir, $refListGroupMembers, $nbrLists, 
                             $nbrGroupMembersDone, $posPb1, $parsingDone, $nbrRetries);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
      Win32::GUI::MessageBox($winPb, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };
	
	# Connect to current tab in Firefox
	my $mech = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
	my $currShownList;
	if (my $currList = $mech->selector('div.uiPopover span._55pe', any => 1)) {
		$currShownList = $currList->{innerHTML};
	}
	
  # First execution, must gather Group Members Lists
  if (!$posPb1 and !$nbrLists) {
    $firstExec = 1;
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpGroupMembersP'}.'...');
		my $count = 0;
		for (my $i = 0; $i < $winGroupMembers->lvGroupMembersListSel->GetItemCount(); $i++) {
			if ($winGroupMembers->lvGroupMembersListSel->GetCheckState($i)) {
				$$refListGroupMembers{$count}{'name'} = $winGroupMembers->lvGroupMembersListSel->GetItemText($i);
				$$refListGroupMembers{$count}{'url'}  = $mech->uri();
				$count++;
			}
		}
    $nbrLists = keys %{$refListGroupMembers};
  } # else, resume after a crash

  if ($nbrLists > 0) {
    my $count1;
    # First execution, turn on the progress window
    if ($firstExec == 1) {
      # Turn on progress bar
      $winPb->Center($winFriends);
      $winPb->Show();
      $win->Disable();
      $winPb->pbWinPb1->SetRange(0, $nbrLists);
      $winPb->pbWinPb1->SetPos(0);
      $winPb->pbWinPb1->SetStep(1);
      $winPb->lblPbCurr1->Text('');
      $winPb->lblCount1->Text('');
      $count1 = 0;
			# Make folders
			if (!-d "$saveDir\\temp") { mkdir("$saveDir\\temp"); }
			if (!-d "$saveDir\\images_$groupMembersName" and $includeIcons) { mkdir("$saveDir\\images_$groupMembersName"); }
    # If on resume state, get number of friends cat left
    } else {
      my $nbrCurrNbrLists = keys %{$refListGroupMembers};
      $count1 = $nbrLists - $nbrCurrNbrLists;
    }
	
		# Parse each Group Members list
		if (!$parsingDone) {
			my $count1 = 0;
			foreach my $list (sort keys %{$refListGroupMembers}) {
				my $encodedName = encode($CONFIG{'CHARSET'}, $$refListGroupMembers{$list}{'name'});
				my $htmlPage;
				my @members;
				my $nbrMembers;
				
				# Check status for the current list
				# 1 : Opening
				# 2 : Scrolling done
				# 3 : Downloading done
				# 4 : Parsing done
				
				# Show the list
				if (!exists($$refListGroupMembers{$list}{'status'})) {
					$winPb->lblPbCurr1->Text("$STR{'opening'}: $encodedName");
					$winPb->lblCount1->Text("$count1/$nbrLists");
					$winPb->lblPbCurr2->Text('');
					$winPb->lblCount2->Text('');
					$winPb->pbWinPb2->SetPos(0);
					if ($currShownList ne $$refListGroupMembers{$list}{'name'}) {
						my @listFromCombo = $mech->selector('a._54nc span._54nh');
						foreach my $listLink (@listFromCombo) {
							if ($listLink->{innerHTML} eq $$refListGroupMembers{$list}{'name'}) {
								$listLink->click();
							}
						}
					}
					$$refListGroupMembers{$list}{'status'} = 1; # Opening done
				}
				
				# Scrolling the list
				if ($$refListGroupMembers{$list}{'status'} < 2) {
					$winPb->lblPbCurr1->Text("$STR{'scrolling'}: $encodedName");
					sleep($CONFIG{'TIME_TO_WAIT'});
					&scrollLikePage(\$mech, $CONFIG{'TIME_TO_WAIT'});
					$$refListGroupMembers{$list}{'status'} = 2; # Scrolling done
				}
				
				# Downloading the list
				if ($$refListGroupMembers{$list}{'status'} < 3) {
					$winPb->lblPbCurr1->Text("$STR{'saving'}: $encodedName");
					$htmlPage = "$saveDir\\temp\\page.html";
					my $status;
					if ($includeIcons) { $status = $mech->save_content($htmlPage, "$saveDir\\temp"); }
					else               { $status = $mech->save_content($htmlPage);                   }
					while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { usleep(100000); }
					$$refListGroupMembers{$list}{'status'} = 3; # Downloading done
				}
				
				# Parsing the list
				my $nbrGroupMembersDone = keys %{$$refListGroupMembers{$list}{'profilOrder'}};
				if ($$refListGroupMembers{$list}{'status'} < 4) {
					$winPb->lblPbCurr1->Text("$STR{'parsing'}: $encodedName");
					# Load content from file
					if (-T $htmlPage) {
						if (open(my $fhTemp, "<:encoding(UTF-8)", $htmlPage)) {
							my $file_as_string = do { local $/ = <$fhTemp> };
							$file_as_string    =~ s/[\r\n]//g;
							my @parts          = split(/fbProfileBrowserResult/, $file_as_string);
							undef($file_as_string);
							shift(@parts);
							my $currSection;
							foreach (@parts) { if ($_ !~ /^[^\"]+hidden[^\"]+\"/) { $currSection .= $_; } }
							@parts = ();
							@members = split(/fbProfileBrowserListItem/, $currSection);
							undef($currSection);
							shift(@members);
							$nbrMembers = scalar(@members);
							close($fhTemp);
						}
					}
					
					# Progress bar
					$winPb->pbWinPb2->SetRange(0, $nbrMembers);
					$winPb->pbWinPb2->SetPos($nbrGroupMembersDone);
					$winPb->pbWinPb2->SetStep(1);
					$winPb->lblCount2->Text("$nbrGroupMembersDone/$nbrMembers");
					
					# Parse friends details
					my $k = 0;
					foreach my $member (@members) {
						if ($k >= $nbrGroupMembersDone) {
							my $url;
							my $id;
							my $img;
							# Url and Img
							if ($member =~ / href="([^\&\"]+)(?:&|")[^\>]+hovercard\/user.php\?id=([^\&\"]+)(?:&|")[^\>]*>/) {
								$url = $1;
								$id  = $2;
							}
							# Img
							if ($member =~ /<img class="_s0 _r[wv] img" src="([^\"]+)" alt=""><\/a>/) {
								$img = $1;
							}
							
							# Minimum details required
							if ($url and $id and $img) {
								$winPb->lblPbCurr2->Text("$STR{'friendsExtract'} $id...");
								if ($includeIcons and ($img =~ /\/([^\/\?]+)\?/ or $img =~ /(\w+\.jpg)/)) { # Include profile icons
									my $imgFilename = $1; # Replace image name by profil id
									rcopy("$saveDir\\temp\\$imgFilename", "$saveDir\\images_$groupMembersName\\$id\.jpg"); # Copy image
									$$refListGroupMembers{$list}{'profilImg'}{$id} = "images_$groupMembersName\\$id\.jpg";
								} elsif ($format == 1) { $$refListGroupMembers{$list}{'profilImageUrl'}{$id} = $img; } # HTML Report
								$$refListGroupMembers{$list}{'profilUrl'}{$id} = $url;
								$$refListGroupMembers{$list}{'profilOrder'}{$nbrGroupMembersDone} = $id;
								
								# Gather profil name
								my $url2 = quotemeta($url);
								if ($member =~ /<(?:div|span) class="fsl fwb fcb"><a href="$url2[^\>]+>([^\<]+)</) {
									$$refListGroupMembers{$list}{'profilName'}{$id} = $1;
								}
								
								# Gather details (if available)
								if ($member =~ /class="fsl fwb fcb"><a[^\>]+>[^\<]+<[^\>]+><\/div><div>([^\<]+)<\/div>(.+?)<span/ or
										$member =~ /class="fsl fwb fcb"><a[^\>]+>([^\<]+)<\/a><\/div><div><\/div>([^\<]+)(.+?)<span/) {
									my $details1 = $1;
									my $details2 = $2;
									$details1 =~ s/<[^\>]+>//g;
									$details1 = decode_entities($details1);
									if ($details2 =~ /data-utime="(\d+)/) {
										my $dateStr = &formatDate($1);
										$details2 =~ s/<[^\>]+>//g;
										$details2 .= '('.$dateStr.')';
									} else { $details2 =~ s/<[^\>]+>//g; }
									$details2 = decode_entities($details2);
									$$refListGroupMembers{$list}{'profilDetails'}{$id} = "$details1 $details2";
								}
							}
							$winPb->pbWinPb2->StepIt();
							$nbrGroupMembersDone++;
							$winPb->lblCount2->Text("$k/$nbrMembers");
						}
						$k++;
					}
					$$refListGroupMembers{$list}{'status'} = 4; # Parsing done
					$winPb->pbWinPb1->StepIt();
					$winPb->lblCount1->Text("$count1/$nbrLists");
				}
				$count1++;
				$nbrGroupMembersDone = 0;
				if ($count1 == $nbrLists) { $parsingDone = 1; }
			}
		}
	}
	
	# Parsing done, create the report
	my $count1 = 0;
	$winPb->lblPbCurr1->Text($STR{'createOutput'}.'...');
	$winPb->lblCount1->Text('');
	if ($nbrLists) {
		# Progress 1
		$winPb->lblCount1->Text("$count1/$nbrLists");
		$winPb->pbWinPb1->SetRange(0, $nbrLists);
		$winPb->pbWinPb1->SetPos(0);
		$winPb->pbWinPb1->SetStep(1);
	
		# Create and open the XLSX file
		my $filename;
		if (!$format) {
			$filename = "$saveDir\\$groupMembersName\.xlsx";
			my $excel;
			my $count = 1;
			while (!($excel = Excel::Writer::XLSX->new($filename))) { # If file is already open, must be renamed
				$filename = "$saveDir\\$groupMembersName [".$count++."]\.xlsx";
				if ($count == 10) { last; } # Stop after 10 attempts
			}
			
			# One sheet per category
			foreach my $list (sort keys %{$refListGroupMembers}) {
				&createExcelSheetWithDetails(\$excel, $$refListGroupMembers{$list}{'name'}, $$refListGroupMembers{$list}, $includeIcons, $saveDir);
				$count1++;
				$winPb->lblCount1->Text("$count1/$nbrLists");
				$winPb->pbWinPb1->StepIt();
			}
			$excel->close();
			
		# HTML
		} elsif ($format == 1) {
			$filename = &createHTMLGroupMembers($groupMembersName, $refListGroupMembers, $nbrLists, $includeIcons, $saveDir);
	
		# TXT
		} else {
			$filename = "$saveDir\\$groupMembersName.txt";
			&createTXTGroupMembers($groupMembersName, $filename, $refListGroupMembers, $nbrLists, $includeIcons, $saveDir);
		}
		
		# Open the file
		if ($winGroupMembers->chGroupMembersOpenOutput->Checked()) { $win->ShellExecute('open', $filename,'','',1); }
	}
	
	# Turn off progress bar
	$winPb->lblPbCurr1->Text('');
	$winPb->lblCount1->Text('');
	$winPb->lblPbCurr2->Text('');
	$winPb->lblCount2->Text('');
	$winPb->pbWinPb1->SetPos(0);
	$winPb->pbWinPb2->SetPos(0);
	&winPb_Terminate;
	
	# Delete temporary files
	if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }

  $win->Tray->Change(-tip => $STR{'dumpGroupMembersF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'        ,
                        -balloon_title => 'ExtractFace' ,
                        -balloon_tip   => $STR{'dumpGroupMembersF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpGroupMembers

#--------------------------#
sub createHTMLGroupMembers
#--------------------------#
{
  # Local variables
  my ($groupMembersName, $refListGroupMembers, $nbrLists, $includeIcons, $saveDir) = @_;
  my $firstPage; # First page is the main page
  my $first = 0;
  my $count = 0;
  
  # List of pages
  my %listPages;
  foreach my $list (sort keys %{$refListGroupMembers}) {
    my $name = $$refListGroupMembers{$list}{'name'};
    $listPages{$name} = "$name - $list\.html";
  }
  
  # Create one page per category
  foreach my $list (sort keys %{$refListGroupMembers}) {
    my $encodedName = encode($CONFIG{'CHARSET'}, $$refListGroupMembers{$list}{'name'});
    $winPb->lblPbCurr1->Text("$STR{'createPage'}: $encodedName");
    my $filename = "$saveDir\\$listPages{$$refListGroupMembers{$list}{'name'}}";
    if ($first == 0) { $firstPage = $filename; $first = 1; } # Keep the filename of the first page
    open(HTML, ">:encoding(UTF-8)", $filename);
    print HTML "<!DOCTYPE html>\n";
    print HTML "<html>\n<head>\n<title>$$refListGroupMembers{$list}{'name'}</title>\n";
    print HTML "<meta charset=\"UTF-8\">\n";
		print HTML "<style>\n";
		print HTML "table, th, td {\n";
		print HTML "  border: 1px solid black;\n";
		print HTML "  border-collapse: collapse;\n";
		print HTML "}\n";
		print HTML "th, td {\n";
		print HTML "  padding: 5px;\n";
		print HTML "}\n";
		print HTML "</style>\n";
    print HTML "</head>\n";
    print HTML "<body>\n";
		print HTML "<h1 style=\"color:#003300;font-size: 18pt;font-variant: small-caps;font-weight: bold;\;text-align: center;\">";
    print HTML "$$refListGroupMembers{$list}{'name'}</h1>\n";
    print HTML "<table style=\"margin: auto;\">\n";
    print HTML "<tr><th colspan=4 style=\"height: 50px; color:#003300; background-color:#EEEEEE; font-size: 14pt; font-variant: small-caps; font-weight: bold;\">\n";
    my $header;
    foreach my $listName (sort keys %listPages) {
      if ($listName eq $$refListGroupMembers{$list}{'name'}) { $header .= "$listName - "; }
      else                                                   { $header .= "<a href=\"./$listPages{$listName}\">$listName</a> - "; }
    }
    chop($header); chop($header); chop($header);
    print HTML "$header</th></tr>\n";
    print HTML "<tr><td colspan=4 style=\"text-align: center;\">Origin url: <a href=\"$$refListGroupMembers{$list}{'url'}\">$$refListGroupMembers{$list}{'url'}</a></td></tr>\n";
    my $col = 0; # 2 columns per friend, first is profile icon, second is details
    foreach my $no (sort {$a <=> $b} keys %{$$refListGroupMembers{$list}{'profilOrder'}}) {
      if ($col == 0) { print HTML "<tr>"; }
      if (my $id = $$refListGroupMembers{$list}{'profilOrder'}{$no}) {
        if ($$refListGroupMembers{$list}{'profilImg'}{$id}) { print HTML "<td><img src=\"$$refListGroupMembers{$list}{'profilImg'}{$id}\" alt=\"\"></td>";      }
        else                                                { print HTML "<td><img src=\"$$refListGroupMembers{$list}{'profilImageUrl'}{$id}\" alt=\"\"></td>"; }
        $col++;
        print HTML "<td><strong>Name</strong>: $$refListGroupMembers{$list}{'profilName'}{$id}<br>";
        print HTML "<strong>Profile ID</strong>: $id</strong><br>";
        print HTML "<strong>Profile url</strong>: <a href=\"$$refListGroupMembers{$list}{'profilUrl'}{$id}\" target=\"_blank\">$$refListGroupMembers{$list}{'profilUrl'}{$id}</a><br>";
        print HTML "<strong>Details</strong>: $$refListGroupMembers{$list}{'profilDetails'}{$id}</td>";
        $col++;
      } else { print HTML "<td></td><td></td>"; $col += 2; }
      if ($col == 4) { print HTML "</tr>\n"; $col = 0; }
    }
    print HTML "</body>\n</html>";
    close(HTML);
    
    $count++;
    $winPb->lblCount1->Text("$count/$nbrLists");
    $winPb->pbWinPb1->StepIt();
  }
  
  return($firstPage);  
  
}  #--- End createHTMLGroupMembers

#--------------------------#
sub createTXTGroupMembers
#--------------------------#
{
  # Local variables
  my ($groupMembersName, $filename, $refListGroupMembers, $nbrLists, $includeIcons, $saveDir) = @_;
  my $count = 0;
  
  $winPb->lblPbCurr1->Text("$STR{'createTXT'}");
  open(my $txt, ">:encoding(UTF-8)", $filename);
  print $txt "GROUP NAME\tGROUP URL\tPROFILE ID\tURL\tNAME\tDETAILS\n"; # Header
  foreach my $list (sort keys %{$refListGroupMembers}) {
    foreach my $no (sort keys %{$$refListGroupMembers{$list}{'profilOrder'}}) {
      my $id = $$refListGroupMembers{$list}{'profilOrder'}{$no};
      print $txt "$$refListGroupMembers{$list}{'name'}\t$$refListGroupMembers{$list}{'url'}\t$id\t$$refListGroupMembers{$list}{'profilUrl'}{$id}".
                 "\t$$refListGroupMembers{$list}{'profilName'}{$id}\t$$refListGroupMembers{$list}{'profilDetails'}{$id}\n";
    }
    
    $count++;
    $winPb->lblCount1->Text("$count/$nbrLists");
    $winPb->pbWinPb1->StepIt();
  }
  close($txt);
  
}  #--- End createTXTGroupMembers

#--------------------------#
sub winGroupMembers_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winGroupMembers->AbsLeft();
    my $winTop  = $winGroupMembers->AbsTop();
    $CONFIG{'WINGROUP_MEMBERS_LEFT'} = $winLeft;
    $CONFIG{'WINGROUP_MEMBERS_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winGroupMembers_Terminate


#--------------------------#
sub scrollContacts
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    $THR = threads->create(\&scrollContactsThr, $nbrRetries);
  }
}  #--- End scrollContacts

#--------------------------#
sub scrollContactsThr
#--------------------------#
{
  # Local variables
  my $nbrRetries = shift;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollContactsC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollContactsThr, $nbrRetries);
      } else {
        Win32::GUI::MessageBox($win, $STR{'err2'}, $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollContactsP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show($winChat);
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
	
  if ($mech->uri() =~ /facebook.com/) {
    while (1) {
			if (my $loadMoreContacts = ($mech->selector('div._19hf a', any => 1))[0]) {
				$mech->eval_in_page("var scrollingDiv = (document.getElementsByClassName('_19hf'))[0]; scrollingDiv.scrollIntoView(1)");
				sleep($CONFIG{'TIME_TO_WAIT'});
			} else { last; }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollContactsF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'                  ,
                          -balloon_title => 'ExtractFace'           ,
                          -balloon_tip   => $STR{'scrollContactsF'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else {
		Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010);
	}
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End scrollContactsThr

#--------------------------#
sub scrollChat
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&scrollChatThr, $nbrRetries, $count);
  }
}  #--- End scrollChat

#--------------------------#
sub scrollChatThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChatC'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&scrollChatThr, $nbrRetries, $count);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChatP'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show($winChat);
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
	
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChatP'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
			$count++;
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
				my $firstDisplayedDate;
				my $firstDisplayedDateCode = ($mech->selector('time._3oh-'))[0];
				if ($firstDisplayedDateCode->{innerHTML} =~ /(\d{2}\/\d{2}\/\d{4} \d{1,2}\:\d{2}[ap]m)/) {
					my $dateStr = $1;
					my $strp = DateTime::Format::Strptime->new(pattern => '%m/%d/%Y %I:%M%p');
					my $dt   = $strp->parse_datetime($dateStr);
					$firstDisplayedDate = timelocal(0,0,0,$dt->day(),$dt->month()-1,$dt->year());
				}
        if ($firstDisplayedDate <= $maxDate) { last; }
      } elsif ($maxScrollChat and $count > $maxScrollChat) { last; } # Stop by page
      
			if (($mech->selector('div._2k8v', any => 1))[0]) {
				$mech->eval_in_page("var scrollingDiv = (document.getElementsByClassName('_2k8v'))[0]; scrollingDiv.scrollIntoView(1)");
			} else { last; }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChatF'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'              ,
                          -balloon_title => 'ExtractFace'       ,
                          -balloon_tip   => $STR{'scrollChatF'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else {
		Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010);
	}
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End scrollChatThr

#--------------------------#
sub loadNewMsg
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&loadNewMsgThr, $nbrRetries, $count);
  }
}  #--- End loadNewMsg

#--------------------------#
sub loadNewMsgThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChat2C'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&loadNewMsgThr, $nbrRetries, $count);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChat2P'}.'...');
    
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show($winChat);
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChat2P'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
			$count++;
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
        my $lastDisplayedDate = ($mech->selector('h4._497p._2lpt time._3oh-'))[-1];
        if ($lastDisplayedDate->{innerHTML} =~ /(\d{2}\/\d{2}\/\d{4} \d{1,2}\:\d{2}[ap]m)/) {
					my $strp     = DateTime::Format::Strptime->new(pattern => '%m/%d/%Y %l:%M%p');
					my $dt       = $strp->parse_datetime($1);
          my $dateOnly = timelocal(0,0,0,$dt->day(),$dt->month()-1,$dt->year());
          if ($dateOnly >= $maxDate) { last; }
        }
      } elsif ($maxScrollChat and $count > $maxScrollChat) { last; } # Stop by page
      
			my $loadNewerCode = ($mech->selector('button._3quh._30yy._2t_._41jf'))[1];
			if ($loadNewerCode) {
				$loadNewerCode->click();
				sleep($CONFIG{'TIME_TO_WAIT'});
			} else { last; }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChat2F'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'               ,
                          -balloon_title => 'ExtractFace'        ,
                          -balloon_tip   => $STR{'scrollChat2F'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End loadNewMsgThr

#--------------------------#
sub loadOldMsg
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    my $nbrRetries = 0;
    my $count      = 0;
    $THR = threads->create(\&loadOldMsgThr, $nbrRetries, $count);
  }
}  #--- End loadOldMsg

#--------------------------#
sub loadOldMsgThr
#--------------------------#
{
  # Local variables
  my ($nbrRetries, $count) = @_;
  
  # Cancel button
  $SIG{'KILL'} = sub {
    # Turn off progress bar
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'scrollChat3C'});
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    if ($msgErr =~ /problem connecting/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    } else {
      # Retry 10 times
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
      if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
        # Restart a new thread to continue
        if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb2->lblPbCurr->Text($STR{'crash'}.'...'); }
        sleep(2);
        $THR = threads->create(\&loadOldMsgThr, $nbrRetries, $count);
      } else {
				my $err = (split(/ at /, $msgErr))[0];
				Win32::GUI::MessageBox($win, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
        # Turn off progress bar
        $winPb2->lblPbCurr->Text('');
        $winPb2->lblCount->Text('');
        &winPb2_Terminate;
        $win->ChangeCursor($ARROW);
        $win->Tray->Change(-tip => 'ExtractFace');
      }
    }
    threads->exit();
  };

  # First execution
  if (!$nbrRetries) {
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'scrollChat3P'}.'...');
    # Turn on progress bar
    $winPb2->Center();
    $winPb2->Show($winChat);
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    $win->Disable();
  }
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      Win32::GUI::MessageBox($win, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /facebook.com/) {
    $winPb2->lblPbCurr->Text($STR{'scrollChat3P'}.'...');
    my $maxScrollChatByDate = $winConfig->rbMaxScrollChatByDate->Checked();
    my $maxDate;
    my $maxScrollChat;
    if ($maxScrollChatByDate) {
      my ($d, $m, $y) = $winConfig->dtMaxScrollChatByDate->GetDate();
      $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
    } else { $maxScrollChat = $winConfig->tfMaxScrollChat->Text(); }
    
    while (1) {
			$count++;
      # Scroll again
      if ($maxScrollChatByDate and $maxDate) { # Stop by date
        my $firstDisplayedDate = ($mech->selector('h4._497p._2lpt time._3oh-'))[0];
        if ($firstDisplayedDate->{innerHTML} =~ /(\d{2}\/\d{2}\/\d{4} \d{1,2}\:\d{2}[ap]m)/) {
					my $strp     = DateTime::Format::Strptime->new(pattern => '%m/%d/%Y %l:%M%p');
					my $dt       = $strp->parse_datetime($1);
          my $dateOnly = timelocal(0,0,0,$dt->day(),$dt->month()-1,$dt->year());
          if ($dateOnly <= $maxDate) { last; }
        }
      } elsif ($maxScrollChat and $count > $maxScrollChat) { last; } # Stop by page
      
      my @loadOlderCode = $mech->selector('button._3quh._30yy._2t_._41jf');
			if (scalar(@loadOlderCode) > 1) {
				$loadOlderCode[0]->click();
				sleep($CONFIG{'TIME_TO_WAIT'});
			} else { last; }
    }
    
    $win->Tray->Change(-tip => $STR{'scrollChat3F'});
    if (!$win->IsVisible()) {
      $win->Tray->Change( -balloon_icon  => 'info'               ,
                          -balloon_title => 'ExtractFace'        ,
                          -balloon_tip   => $STR{'scrollChat3F'} , );
      $win->Tray->ShowBalloon(1);
    }
  } else { Win32::GUI::MessageBox($winPb2, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Turn off progress bar
  $win->ChangeCursor($ARROW);
  $winPb2->lblPbCurr->Text('');
  $winPb2->lblCount->Text('');
  &winPb2_Terminate;

}  #--- End loadOldMsgThr

#--------------------------#
sub winChat
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $THR = threads->create(\&winChatThr);
    
    usleep(500000);
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINCHAT_LEFT'} and $CONFIG{'WINCHAT_TOP'}) {
      $winChat->Left($CONFIG{'WINCHAT_LEFT'});
      $winChat->Top($CONFIG{'WINCHAT_TOP'});
    } else { $winChat->Center(); }
    $winChat->DoModal();
  }

}  #--- End winChat

#--------------------------#
sub btnChatRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Start the thread
    $winChat->tfChatName->Text('');
    $THR = threads->create(\&winChatThr);
  }
  
}  #--- End btnChatRefresh_Click

#--------------------------#
sub winChatThr
#--------------------------#
{
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winChatThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winChat, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winChat->btnChatOk->Disable();
      Win32::GUI::MessageBox($winChat, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }

  if ($mech->uri() =~ /facebook.com/) {
    my $currURL  = $mech->uri();
    if ($currURL =~ /https:\/\/www.facebook.com\/messages\/t\/search\/([^\/\?]+)\/?/ or
        $currURL =~ /https:\/\/www.facebook.com\/messages\/t\/([^\/]+)\/?/) {
      my $title = $1;
      $title =~ s/[\#\<\>\:\"\/\\\|\?\*]/_/g;
      $winChat->tfChatName->Text("$title - $STR{'chat'}");
    } else {
      $winChat->btnChatOk->Disable();
      Win32::GUI::MessageBox($winChat, $STR{'warn3'}, $STR{'warn2T'}, 0x40010);
      threads->exit();
    }
  } else { Win32::GUI::MessageBox($winChat, $STR{'warn4'}, $STR{'err1T'}, 0x40010); }
  
  # Ready ?
  &isDumpChatReady();

}  #--- End winChatThr

#--------------------------#
sub tfChatName_Change
#--------------------------#
{
  # Ready ?
  &isDumpChatReady();

}  #--- End tfChatName_Change

#--------------------------#
sub tfDirSaveChat_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winChat->tfDirSaveChat->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winChat->chSaveChatDir->Checked()) {
    $CONFIG{'DIR_SAVE_CHAT'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
    
  # Ready ?
  &isDumpChatReady();

}  #--- End tfDirSaveChat_Change

#--------------------------#
sub btnDirSaveChat_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winChat->tfDirSaveChat->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winChat       ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -directory  => $lastDir       ,
                                        -newui      => 1              , );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winChat       ,
                                        -title      => $STR{'selDir'} ,
                                        -folderonly => 1              ,
                                        -newui      => 1              , );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winChat->tfDirSaveChat->Text($dir);
  }
  
}  #--- End btnDirSaveChat_Click

#--------------------------#
sub btnBrowseDirSaveChat_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winChat->tfDirSaveChat->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveChat_Click

#--------------------------#
sub chSaveChatDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winChat->tfDirSaveChat->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winChat->chSaveChatDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CHAT'} = 1;
    $CONFIG{'DIR_SAVE_CHAT'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winChat->chSaveChatDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_CHAT'} = 1;
    delete($CONFIG{'DIR_SAVE_CHAT'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveChatDir_Click

#--------------------------#
sub rbChatNormalMode_Click
#--------------------------#
{
  $winChat->chDownloadImg->Enable();
  $winChat->chDownloadVid->Enable();
  $winChat->chDownloadAD->Enable();

}  #--- End rbChatNormalMode_Click

#--------------------------#
sub rbChatSafeMode_Click
#--------------------------#
{
  $winChat->chDownloadImg->Checked(0);
  $winChat->chDownloadVid->Checked(0);
  $winChat->chDownloadAD->Checked(0);
  $winChat->chDownloadImg->Disable();
  $winChat->chDownloadVid->Disable();
  $winChat->chDownloadAD->Disable();

}  #--- End rbChatSafeMode_Click

#--------------------------#
sub chDownloadAD_Click
#--------------------------#
{
  if ($winChat->chDownloadAD->Checked()) {
    $winChat->chDownloadImg->Enable();
  } else {
    $winChat->chDownloadImg->Checked(0);
    $winChat->chDownloadImg->Disable();
  }

}  #--- End chDownloadAD_Click

#--------------------------#
sub dtChatDatesRangeS_Change
#--------------------------#
{
  $winChat->rbChatDatesAll->Checked(0);
  $winChat->rbChatDatesRange->Checked(1);

}  #--- End dtChatDatesRangeS_Change

#--------------------------#
sub dtChatDatesRangeE_Change
#--------------------------#
{
  $winChat->rbChatDatesAll->Checked(0);
  $winChat->rbChatDatesRange->Checked(1);

}  #--- End dtChatDatesRangeE_Change

#--------------------------#
sub isDumpChatReady
#--------------------------#
{
  # Local variables
  my $chatName = $winChat->tfChatName->Text();
  my $saveDir  = $winChat->tfDirSaveChat->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$chatName) { $winChat->btnChatOk->Disable(); return(0); }

  $winChat->btnChatOk->Enable();

}  #--- End isDumpChatReady

#--------------------------#
sub btnChatOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winChat->AbsLeft();
      my $winTop  = $winChat->AbsTop();
      $CONFIG{'WINCHAT_LEFT'} = $winLeft;
      $CONFIG{'WINCHAT_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $chatName = $winChat->tfChatName->Text();
    my $saveDir  = $winChat->tfDirSaveChat->Text();
    $chatName    =~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $interlocutor;
    my $interlocutorURL;
		my %messages;
    my $posPb1          = 0;
    my $nbrRetries      = 0;
    my $count           = 0;
    my $step            = 1;
    my $nbrPartsDone    = 0;
    my $nbrMessagesDone = 0;

    if ($chatName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpChat, $chatName, $interlocutor, $interlocutorURL, $saveDir,
                             \%messages, $posPb1, $nbrRetries, $count, $step, $nbrPartsDone,
														 $nbrMessagesDone);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnChatOk_Click

#--------------------------#
sub dumpChat
#--------------------------#
{
  # Local variables
  my ($chatName, $interlocutor, $interlocutorURL, $saveDir, $refMessages, $posPb1, $nbrRetries,
			$count, $step, $nbrPartsDone, $nbrMessagesDone) = @_;
  my $tmpDir        = "$saveDir\\temp";
  my $htmlPage      = "$tmpDir\\page.html";
  my $safeMode      = $winChat->rbChatSafeMode->Checked();
  
  # Filter by dates (if set)
  my $dateS;
  my $dateE;
  if ($winChat->rbChatDatesRange->Checked()) {
    my ($d1, $m1, $y1) = $winChat->dtChatDatesRangeS->GetDate();
    $dateS             = timelocal(0,0,0,$d1,$m1-1,$y1); # Store in Unixtime format
    my ($d2, $m2, $y2) = $winChat->dtChatDatesRangeE->GetDate();
    $dateE             = timelocal(0,0,0,$d2,$m2-1,$y2); # Store in Unixtime format
		$dateE            += 86399; # Add 23h59 to be at the end of the day
  }  

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpChatC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    # Progress window
    $posPb1 = $winPb->pbWinPb1->GetPos();
    $winPb->pbWinPb2->SetPos(0);
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $nbrRetries++; }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpChat, $chatName, $interlocutor, $interlocutorURL, $saveDir,
														 $refMessages, $posPb1, $nbrRetries, $count, $step, $nbrPartsDone,
														 $nbrMessagesDone);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
      Win32::GUI::MessageBox($winPb, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
			# Turn off progress bar
			$winPb->lblPbCurr1->Text('');
			$winPb->lblCount1->Text('');
			$winPb->lblPbCurr2->Text('');
			$winPb->lblCount2->Text('');
			$winPb->pbWinPb1->SetPos(0);
			$winPb->pbWinPb2->SetPos(0);
			&winPb_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };

  # First execution
  if (!$count) {
		# Turn on progress bar
		$winPb->Center($winChat);
		$winPb->Show();
		$win->Disable();
		$winPb->lblPbCurr1->Text($STR{'dumpChatP'}.'...');
		$winPb->pbWinPb1->SetRange(0, 3);
		$winPb->pbWinPb1->SetPos(0);
		$winPb->pbWinPb1->SetStep(1);
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpChatP'}.'...');
  } else { $count--; }
  
  # Connect to current tab
  my $mech = WWW::Mechanize::Firefox->new(tab => 'current');
	
  # Create folders and save the page
  my $origURL = $mech->uri;
  my $profilID; if ($origURL =~ /messages\/t\/(?:search\/)?([^?#]+)\#?/) { $profilID = $1; } # $profilID is the profil ID of the interlocutor
  if ($step == 1) {
    if (!-d $tmpDir) { mkdir($tmpDir); }
    my $status;
		$winPb->lblPbCurr1->Text($STR{'saveTab'}.'...');
    # Safe mode, we save only html
    if ($safeMode) {
      $status = $mech->save_content($htmlPage);
      sleep($CONFIG{'TIME_TO_WAIT'});
    # Normal mode, we save html and all documents
    } else {
      $status = $mech->save_content($htmlPage, $tmpDir);
			sleep($CONFIG{'TIME_TO_WAIT'});
      while ($status->{currentState} != $status->{PERSIST_STATE_FINISHED}) { sleep(1); }
    }
    
    $step = 2; # Page have been saved
		$winPb->pbWinPb1->StepIt();
		$winPb->lblCount1->Text("1/3");
  }
  
  # Parse html page
  if ($step == 2) {
		$winPb->lblPbCurr1->Text($STR{'parsePage'}.'...');
    my $i = 0;
    # Interlocutor name and url
		if (!$interlocutor) {
			my $headerNameCode = $mech->selector('h2._17w2', one => 1);
			if ($headerNameCode->{innerHTML} =~ /<span[^\>]+> ?<!--[^\>]+>([^<]+)/) { $interlocutor   = $1; }
		}
		if (!$interlocutorURL) {
			my $headerUrlCode  = $mech->selector('div._4v0l a', any => 1);
			if ($headerUrlCode->{href}) { $interlocutorURL = $headerUrlCode->{href}; }
		}
		
    # Parse HTML file
		my @byDateParts;
    if (-T $htmlPage) {
      if (open(my $fhTemp, "<:encoding(UTF-8)", $htmlPage)) {
        my $file_as_string = do { local $/ = <$fhTemp> };
        $file_as_string =~ s/[\r\n]//g;
				my $section    = (split(/function\(Bootloader\)/, $file_as_string))[0];
				undef($file_as_string);
				my $msgSection = (split(/aria-label="Messages"/, $section))[1]; # Keep the messages area
				undef($section);
				# If there is at least one date tag
				if ($msgSection) {
					@byDateParts = split(/_497p _2lpt/, $msgSection); # Split using date tag
					shift(@byDateParts);
				} else { push(@byDateParts, $msgSection); }
        close($fhTemp);
      }
			
			if (scalar(@byDateParts)) {
				my $nbrParts  = scalar(@byDateParts);
				$nbrPartsDone = keys %{$refMessages};
				# Progress bar
				$winPb->pbWinPb2->SetRange(0, $nbrParts);
				$winPb->pbWinPb2->SetPos($nbrPartsDone);
				$winPb->pbWinPb2->SetStep(1);
				$winPb->lblCount2->Text("$nbrPartsDone/$nbrParts");
				
				my $k = 0;
				foreach my $datePart (@byDateParts) {
          if ($k >= $nbrPartsDone) {
						my $startingDate;
						# Get the date (if available)
						if ($datePart =~ /<time class="_3oh-">([^\<]+)<\/time>/) { $startingDate = $1; }
						# Split the messages
						my @msgParts;
						if ($datePart =~ /_1t_p clearfix/) {
							@msgParts = split(/_1t_p clearfix/, $datePart);
							shift(@msgParts);
						} else { push(@msgParts, $datePart); }
						if (scalar(@msgParts)) {
							my $msgCount = 0;
							$nbrMessagesDone = keys %{$$refMessages{$nbrPartsDone}};
							foreach my $datePart (@msgParts) {
								if ($msgCount >= $nbrMessagesDone) {
									my ($msgHeader, @msgContent) = split(/direction_ltr/, $datePart);
									# Sender is the other
									if ($msgHeader =~ /_1t_r/) {
										my $date;
										my $dateStr;
										# Verify date
										if ($startingDate and $startingDate =~ /(\d{2}\/\d{2}\/\d{4} \d{1,2}\:\d{2}[ap]m)/) {
											my $strp = DateTime::Format::Strptime->new(pattern => '%m/%d/%Y %l:%M%p');
											my $dt   = $strp->parse_datetime($1);
											$date    = $dt->epoch();
											$dateStr = $dt->ymd;
										}
										my $keepMsg = 1;
										# Message is older than the requested date
										if ($dateS and $date and $date < $dateS) { $keepMsg = 0; }
										# Message is newer than the requested date
										if (($dateE and $date and $date > $dateE) or ($dateE and !$date)) { $keepMsg = 0; }
										if ($keepMsg) {
											$winPb->lblPbCurr2->Text("$STR{'parsingMsg'} $dateStr...");
											$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'date'} = $date if $date;
											# Sender name and message time
											if ($msgHeader =~ /data-tooltip-content="([^\"]+)"/) { $$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'time'} = $1; }
											# Sender name only
											if ($msgHeader =~ /alt="([^\"]+)"/) {
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'senderName'} = $1;
												if (!$interlocutor) { $interlocutor = $1; }
											}
											# Sender image url or filename
											if ($msgHeader =~ /src="([^\"]+)"/) {
												my $profileImgSRC = $1;
												my $profileImg;
												if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
												if    ($profileImgSRC =~ /\/([^\/\?]+)\?/) { $profileImg = $1;             }
												elsif ($profileImgSRC =~ /\.jpg$/)         { $profileImg = $profileImgSRC; }
												if (!$safeMode and -e "$tmpDir\\$profileImg" and !-e "$saveDir\\images_$chatName\\$profileImg") {
													rcopy("$tmpDir\\$profileImg", "$saveDir\\images_$chatName\\$profileImg");
												} elsif (!$safeMode and !-e "$saveDir\\images_$chatName\\$profileImg" and
																 !-e "$saveDir\\images_$chatName\\$profileImg" and $profileImgSRC) {
													$mech->save_url($profileImgSRC, "$saveDir\\images_$chatName\\$profileImg");
												} else { $profileImg = $profileImgSRC; }
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'senderImg'} = $profileImg;
											}
											# Parse message
											my $strCount = 0;
											foreach my $msg (@msgContent) {
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'messages'} .= &parseMessage($msg, $safeMode, $saveDir, $tmpDir, $chatName, \$mech);
											}
											$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'messages'} =~ s/<br>$//;
											$nbrMessagesDone++;
										}
										
									# Sender is me
									} else {
										# Parse message
										foreach my $msg (@msgContent) {
											# Verify date
											my $date;
											my $dateStr;
											if ($startingDate and $startingDate =~ /(\d{2}\/\d{2}\/\d{4} \d{1,2}\:\d{2}[ap]m)/) {
												my $strp = DateTime::Format::Strptime->new(pattern => '%m/%d/%Y %l:%M%p');
												my $dt   = $strp->parse_datetime($1);
												$date    = $dt->epoch();
												$dateStr = $dt->ymd;
											}
											my $keepMsg = 1;
											# Message is older than the requested date
											if ($dateS and $date and $date < $dateS) { $keepMsg = 0; }
											# Message is newer than the requested date
											if (($dateE and $date and $date > $dateE) or ($dateE and !$date)) { $keepMsg = 0; }
											if ($keepMsg) {
												$winPb->lblPbCurr2->Text("$STR{'parsingMsg'} $dateStr...");
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'senderName'} = 'Me';
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'date'} = $date if $date;
												if ($msg =~ /data-tooltip-content="([^\"]+)"/) { # Message time
													$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'time'} = $1;
												}
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'messages'} = &parseMessage($msg, $safeMode, $saveDir, $tmpDir, $chatName, \$mech);
												$$refMessages{$nbrPartsDone}{$nbrMessagesDone}{'messages'} =~ s/<br>$//;
												$nbrMessagesDone++;
											}
											$msgCount++;
										}
										$msgCount--;
									}
								}
								$msgCount++;
							}
						}
						$nbrPartsDone++;
					}
					$k++;
					$winPb->pbWinPb2->StepIt();
					$winPb->lblCount2->Text("$k/$nbrParts");
				}
				$step = 3;
				$winPb->lblPbCurr2->Text('');
				$winPb->lblCount2->Text('');
				$winPb->pbWinPb2->SetPos(0);
				$winPb->pbWinPb1->StepIt();
				$winPb->lblCount1->Text("2/3");
			}
    }
	}
	
	my $htmlChatPage;
	if ($step == 3) {
		# Total number of messages
		my $nbrMessages;
		foreach my $msg (keys %{$refMessages}) { $nbrMessages += keys %{$$refMessages{$msg}}; }
		if ($nbrMessages) {
			$winPb->lblPbCurr1->Text($STR{'saveChat'}.'...');
			$htmlChatPage = "$saveDir\\$chatName.html";
			if (!$interlocutor) { $interlocutor = $chatName; }
			&createDumpChatReport($htmlChatPage, $safeMode, $chatName, $interlocutor, $interlocutorURL, $refMessages, $nbrMessages);
		}
		$winPb->pbWinPb1->StepIt();
		$winPb->lblCount1->Text("3/3");
	}
	
	# Turn off progress bar
	$winPb->lblPbCurr1->Text('');
	$winPb->lblCount1->Text('');
	$winPb->lblPbCurr2->Text('');
	$winPb->lblCount2->Text('');
	$winPb->pbWinPb1->SetPos(0);
	$winPb->pbWinPb2->SetPos(0);
	&winPb_Terminate;
  
  # Delete temporary files
  if ($winConfig->chDelTempFiles->Checked()) { remove_tree($tmpDir); }
	
	# Finish
	if ($htmlChatPage) { $win->ShellExecute('open', $htmlChatPage,'','',1); } # Open the page
	else 							 { Win32::GUI::MessageBox($win, "$STR{'noMsgDumped'}.", $STR{'winChat'}, 0x40040); } # No messages were dumped

  $win->Tray->Change(-tip => $STR{'dumpChatF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'            ,
                        -balloon_title => 'ExtractFace'     ,
                        -balloon_tip   => $STR{'dumpChatF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpChat

#--------------------------#
sub parseMessage
#--------------------------#
{
  # Local variables
  my ($msgCode, $safeMode, $saveDir, $tmpDir, $chatName, $refMech) = @_;
	my $message;
	
	# Last message, remove junk
	$msgCode = (split(/class="_4u-f"/, $msgCode))[0] if $msgCode =~ /class="_4u-f"/;
  
	# Text
	if ($msgCode =~ /(<span[^\>]+_58nk[^\>]+>)(.+?)<\/span>/) {
		$message .= $2 . '<br>';
		$message =~ s/<!--(.+?)-->//g; # Remove comment
		my $junk .= $1;
		$msgCode = &truncateText($msgCode, length($1)+length($2), $1);
		
		# Emoticons
		if ($message =~ /img[^\>]+src="[^\"]+"/) {
			while ($message =~ /(<img[^\>]+class="[^\"]+"[^\>]+src="[^\"]+"[^\>]*>)/ or
						 $message =~ /(<img[^\>]+src="[^\"]+"[^\>]+class="[^\"]+"[^\>]*>)/) {
				my $emoticonTag = $1;
				if ($emoticonTag =~ /src="([^\"]+)"/) {
					my $emotionSRC = $1;
					my $emoticonFn;
					if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
					if    ($emotionSRC =~ /\/([^\/\?]+)\?/) { $emoticonFn = $1;          }
					elsif ($emotionSRC =~ /\.png$/)         { $emoticonFn = $emotionSRC; }
					if (!$safeMode and -e "$tmpDir\\$emoticonFn" and !-e "$saveDir\\images_$chatName\\$emoticonFn") {
						rcopy("$tmpDir\\$emoticonFn", "$saveDir\\images_$chatName\\$emoticonFn");
					} elsif (!$safeMode and !-e "$saveDir\\images_$chatName\\$emoticonFn" and
									 !-e "$saveDir\\images_$chatName\\$emoticonFn" and $emotionSRC) {
						$$refMech->save_url($emotionSRC, "$saveDir\\images_$chatName\\$emoticonFn");
					} else { $emoticonFn = $emotionSRC; }
					# Create a new emoticon tag
					if ($emoticonFn !~ /^http/) { $emoticonFn = "images_$chatName\\$emoticonFn"; }
					my $newEmoticonTag = "<img src=\"$emoticonFn\"";
					if ($emoticonTag =~ /( alt="[^\"]+")/) { $newEmoticonTag .= $1; }
					$newEmoticonTag .= ">";
					# Replace in $message
					$message =~ s/$emoticonTag/$newEmoticonTag/e;
				}
			}
		}
	}
	
	# Notification
	if ($msgCode =~ /(<span[^\>]+_50f7[^\>]+>)([^\<]+)/) {
		$message .= "<div style=\"margins: 5px; border: 1px solid black; border-radius: 5px; padding: 5px; color: #CC0000;\">";
		$message .= "$2</span><br>";
		$message =~ s/<!--(.+?)-->//g; # Remove comment
		my $junk .= $1;
		$msgCode = &truncateText($msgCode, length($1)+length($2), $1);
	}
	
	# Warning (ex.: Object deleted, violation of rules)
	if ($msgCode =~ /(<div[^\>]+_1o13[^\>]+>)([^\<]*)/) {
		my $text = $2;
		if (!$text) { $text = "Object was removed."; }
		$message .= "<div style=\"margins: 5px; border: 1px solid red; border-radius: 5px; padding: 5px; color: red;\">";
		$message .= "$text</div><br>";
		$message =~ s/<!--(.+?)-->//g; # Remove comment
		my $junk .= $1;
		$msgCode = &truncateText($msgCode, length($1)+length($2), $1);
	}
	
	# Warning (ex.: Message removed, Account requires verification)
	if ($msgCode =~ /(<em[^\>]+_4qba[^\>]+>)(.+?)<\/em>/) {
		my $extract1 = $1;
		my $extract2 = $2;
		if ($extract2 =~ /temporarily removed/) {
			$message .= "<div style=\"margins: 5px; border: 1px solid red; border-radius: 5px; padding: 5px; color: red;\">";
			$message .= "$extract2</div><br>";
			$message =~ s/<!--(.+?)-->//g; # Remove comment
			my $junk .= $1;
			$msgCode = &truncateText($msgCode, length($1)+length($2), $extract1);
		}
	}
	
	# Shared link
	if ($msgCode =~ /(<a[^\>]+_5rw4[^\>]+)>(.+?)<\/a>/) {
		my $extract1 = $1;
		my $extract2 = $2;
		if ($extract1 =~ / href="([^\"]+)"/) {
			my $sharedLinkUrl = $1;
			if ($sharedLinkUrl !~ /^http/) { $sharedLinkUrl = "https://www.facebook.com$sharedLinkUrl"; }
			my $sharedLinkTitle;
			my $sharedLinkTxt;
			if ($extract2 =~ /<div[^\>]+_4ik6[^\>]+>([^\<]+)/) {
				$sharedLinkTitle = $1;
				$sharedLinkTxt  .= "$STR{'sharedLink'}: <a href=\"$sharedLinkUrl\" target=\"_blank\">$sharedLinkTitle</a><br><br>";
				$extract2           = &truncateText($extract2, length($sharedLinkTitle), $sharedLinkTitle);
				if ($extract2 =~ /<div[^\>]+_4ik6[^\>]+>([^\<]+)/) { $sharedLinkTxt .= $1; }
			} else { $sharedLinkTxt = $sharedLinkUrl; }
			# Map
			my $mapImgTag;
			if ($msgCode =~ /<div[^\>]+_3xn1[^\>]+style="background-image: ?url\(&quot;(.+?)&quot;\);/) {
				my $mapURL = $1;
				$mapURL    =~ s/&amp;/&/g;
				# Download the image ?
				if (!$safeMode) {
					my $mapFn = $sharedLinkTitle . '.jpg';
					$mapFn =~ s/[\<\>\:\"\/\\\|\?\*]/_/g;
					if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
					$$refMech->save_url($mapURL, "$saveDir\\images_$chatName\\$mapFn");
					$mapImgTag .= "<img src=\"images_$chatName\\$mapFn\" alt=\"\"><br>";
				} else { $mapImgTag .= "<img src=\"$mapURL\" alt=\"\"><br>"; }
			}
			if ($sharedLinkUrl and $sharedLinkTxt) {
				$message .= "<div style=\"margins: 5px; border: 1px solid grey; border-radius: 5px; padding: 5px;\">";
				if ($mapImgTag) { $message .= $mapImgTag; }
				$message .= "$sharedLinkTxt</div><br>";
			}
		}
	}
	
	# Invite for Messenger
	if ($msgCode =~ /<div[^\>]+_3thf[^\>]+>(.+)<\/div>/) {
		my $extract = $1;
		if ($extract =~ /src="([^\"]+)"/) {
			my $imgSRC = $1;
			if ($extract =~ /<div[^\>]+_1hm6[^\>]+>(.+?)<\/div>/) {
				my $text = $1;
				my $imgName;
				if    ($imgSRC =~ /\/([^\/\?]+)\?/) { $imgName = $1;      }
				elsif ($imgSRC =~ /\.png$/)         { $imgName = $imgSRC; }
				# Download the image ?
				if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
				if (!$safeMode and -e "$tmpDir\\$imgName" and !-e "$saveDir\\images_$chatName\\$imgName") {
					rcopy("$tmpDir\\$imgName", "$saveDir\\images_$chatName\\$imgName");
				} elsif (!$safeMode and !-e "$saveDir\\images_$chatName\\$imgName" and
								 !-e "$saveDir\\images_$chatName\\$imgName" and $imgSRC) {
					if ($imgSRC !~ /^http/) { $imgSRC = "https://www.facebook.com$imgSRC"; }
					$$refMech->save_url($imgSRC, "$saveDir\\images_$chatName\\$imgName");
				} else { $imgName = $imgSRC; }
				# Create a new emoticon tag
				if ($imgName !~ /^http/) { $imgName = "images_$chatName\\$imgName"; }
				$message .= "<div style=\"margins: 5px; border: 1px solid grey; border-radius: 5px; padding: 5px;\">";
				$message .= "<img src=\"$imgName\" alt=\"\"><br>$text</div><br>";
			}
		}
	}
	
	# Sticker
	if ($msgCode =~ /(<div[^\>]+_ui9[^\>]+)>(.+?)<\/div>/) {
		my $extract1 = $1;
		my $extract2 = $2;
		if ($extract1 =~ /data-testid="sticker"/ and ($extract1 =~ /style="background-image: ?url\((?:&quot;)?(\/stickers\/asset\/\?sticker_id[^\&]+)/ or
																								  $extract1 =~ /style="background-image: ?url\(&quot;([^\&]+)&quot;\); background-size/)) {
			my $imgURL = $1;
			if ($imgURL !~ /^http/) { $imgURL = "https://www.facebook.com$imgURL"; }
			# Sticker use redirection
			if (($imgURL =~ /sticker_id=/)) {
				my $mechSticker = WWW::Mechanize::Firefox->new(autodie => 0);
				$mechSticker->get($imgURL, synchronize => 0);
				sleep($CONFIG{'TIME_TO_WAIT'});
				$imgURL = $mechSticker->uri;
			}
			# Download the image ?
			if (!$safeMode and $imgURL =~ /\/([^\/]+)$/) {
				my $imgName = $1;
				if ($imgURL =~ /\/([^\/]+)$/) { $imgName = $1; }
				if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
				$$refMech->save_url($imgURL, "$saveDir\\images_$chatName\\$imgName");
				$message .= "<img src=\"images_$chatName\\$imgName\" alt=\"\"><br>";
			} else { $message .= "<img src=\"$imgURL\" alt=\"\"><br>"; }
		}
		
		# Thumbs up (this one cannot be displayed if not dowloaded)
		elsif ($extract2 =~ /<svg/ and $extract2 =~ /Thumbs Up Sign/) {
			my $imgURL = 'https://www.facebook.com/rsrc.php/ya/r/FwHVs2eE5cr.svg';
			# Download the image
			if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
			$$refMech->save_url($imgURL, "$saveDir\\images_$chatName\\FwHVs2eE5cr.svg");
			$message .= "<img src=\"images_$chatName\\FwHVs2eE5cr.svg\" alt=\"\" style=\"width:35px;height:35px;\">";
		}
		
		# Emoji
		if ($extract2 =~ /<img[^\>]+_1ifu[^\>]+/ and $extract2 =~ /<div tabindex="0">(.+)<\/span>/) {
			$message .= $1;
			while ($message =~ /(<img[^\>]+class="[^\"]+"[^\>]+src="[^\"]+"[^\>]*>)/ or
						 $message =~ /(<img[^\>]+src="[^\"]+"[^\>]+class="[^\"]+"[^\>]*>)/) {
				my $emojiTag = $1;
				if ($emojiTag =~ /src="([^\"]+)"/) {
					my $emojiSRC = $1;
					my $emojiFn;
					if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
					if    ($emojiSRC =~ /\/([^\/\?]+)\?/) { $emojiFn = $1;        }
					elsif ($emojiSRC =~ /\.png$/)         { $emojiFn = $emojiSRC; }
					if (!$safeMode and -e "$tmpDir\\$emojiFn" and !-e "$saveDir\\images_$chatName\\$emojiFn") {
						rcopy("$tmpDir\\$emojiFn", "$saveDir\\images_$chatName\\$emojiFn");
					} elsif (!$safeMode and !-e "$saveDir\\images_$chatName\\$emojiFn" and
									 !-e "$saveDir\\images_$chatName\\$emojiFn" and $emojiSRC) {
						$$refMech->save_url($emojiSRC, "$saveDir\\images_$chatName\\$emojiFn");
					} else { $emojiFn = $emojiSRC; }
					# Create a new emoticon tag
					if ($emojiFn !~ /^http/) { $emojiFn = "images_$chatName\\$emojiFn"; }
					my $newEmojiTag = "<img src=\"$emojiFn\" alt=\"\">";
					# Replace in $message
					$message =~ s/$emojiTag/$newEmojiTag/e;
				}
			}
		}
	}
	
	# Picture
	if ($msgCode =~ /<div[^\>]+_4tsk[^\>]+>(.+?)<\/div>/) {
		my $extract = $1;
		if ($extract =~ /(<img[^\>]+_5pf5[^\>]+>.+?<\/a>)/) {
			$message .= $1;
			if ($message =~ /src="([^\"]+)"/) {
				my $picSRC = $1;
				my $picFn;
				if    ($picSRC =~ /\/([^\/\?]+)\?/		) { $picFn = $1;      }
				elsif ($picSRC =~ /\.(?:jpg|png|gif)$/) { $picFn = $picSRC; }
				# Full size
				my $picURL;
				if ($winChat->chDownloadImg->Checked() and $message =~ /href="([^\"]+)"/) {
					$picURL = $1;
					$picURL =~ s/&amp;/&/g;
					$$refMech->save_url($picURL, "$saveDir\\images_$chatName\\$picFn");
				}
				# Normal size
				if (!-d "$saveDir\\images_$chatName") { mkdir("$saveDir\\images_$chatName"); }
				if (!$safeMode and -e "$tmpDir\\$picFn" and !-e "$saveDir\\images_$chatName\\$picFn") {
					rcopy("$tmpDir\\$picFn", "$saveDir\\images_$chatName\\$picFn");
				} elsif (!$safeMode and !-e "$saveDir\\images_$chatName\\$picFn" and
								 !-e "$saveDir\\images_$chatName\\$picFn" and $picSRC) {
					$$refMech->save_url($picSRC, "$saveDir\\images_$chatName\\$picFn");
				} else { $picFn = $picSRC; }
				# Replace in $message
				if ($picFn !~ /^http/) { $picFn = "images_$chatName\\$picFn"; }
				$message =~ s/src=\"$picSRC\"/src=\"$picFn\"/;
				$message =~ s/ class="[^\"]+"//g;
				$message =~ s/ style="[^\"]+"//g;
				$message =~ s/<\/a>/<\/a><br>/g;
			}
		}
	}
	
	# Attached document
	if ($msgCode =~ /(<a[^\>]+_2uf4.+?)<\/a>/) {
		my $extract = $1;
		my $attachedURL;
		my $attachedName;
		if ($extract =~ /href="([^\"]+)"/) { $attachedURL  = $1; $attachedURL =~ s/&amp;/&/g; }
		if ($extract =~ /-->([^\<]+)<!--/) { $attachedName = $1; }
		
		# Download attached document
		if ($winChat->chDownloadAD->Checked() and $attachedURL and $attachedName) {
			if (!-d "$saveDir\\docs_$chatName") { mkdir("$saveDir\\docs_$chatName"); }
			my $localPJFile = "$saveDir\\docs_$chatName\\$attachedName";
			if ($attachedURL =~ /u=([^\&]+)\&/) {
				my $directURL = unescape($1);
				$$refMech->save_url($directURL, $localPJFile);
				$message .= "<span style=\"color: #8B2323;\">$STR{'attached'}: <a href=\"docs_$chatName\\$attachedName\" target=\"_blank\">$attachedName</a></span><br>";
			} else {
				$message .= "<span style=\"color: #8B2323;\">$STR{'attached'}: <a href=\"$attachedURL\" target=\"_blank\">Download $attachedName</a></span><br>";
			}
		# Gather the link only
		} else {
			$message .= "<span style=\"color: #8B2323;\">$STR{'attached'}: <a href=\"$attachedURL\" target=\"_blank\">Download $attachedName</a></span><br>";
		}
	}
	
	# Video
	if ($msgCode =~ /(<video[^\>]+_ox1.+?)<\/video>/) {
		my $extract = $1;
		if ($extract =~ /src="([^\"]+)"/) {
			my $videoImgUrl = $1; # Image filename
			
			# Create result code
			if (!-d "$saveDir\\videos_$chatName") { mkdir("$saveDir\\videos_$chatName"); }
			# Link
			if ($videoImgUrl =~ /^https/) {
				$message .= "<video width=\"320\" height=\"240\" controls><source src=\"$videoImgUrl\" type=\"video/mp4\">Your browser does not support the video tag.</video><br>";
			} elsif (-e "$tmpDir\\$videoImgUrl" and !-e "$saveDir\\videos_$chatName\\$videoImgUrl") {
				rcopy("$tmpDir\\$videoImgUrl", "$saveDir\\videos_$chatName\\$videoImgUrl");
				$message .= "<video width=\"320\" height=\"240\" controls><source src=\"videos_$chatName\\$videoImgUrl\" type=\"video/mp4\">Your browser does not support the video tag.</video><br>";
			}
		}
	}
	
	# Vocal message
	if ($msgCode =~ /(<a[^\>]+_2e-1.+?)<\/a>/) {
		my $extract = $1;
		if ($extract =~ /<span[^\>]+_2e-4[^\>]+>([^\<]+)/) {
			my $duree = $1;
			$message .= "<span style=\"color: #CC0000;\">$STR{'vocalMsgLast'}: $duree</span><br>";
		}
	}
	
  return($message);

}  #--- End parseMessage

#--------------------------#
sub truncateText
#--------------------------#
{
  # Local variables
  my ($text, $long, $toIndex) = @_;
  
  my $lineWidth = length($text);
  my $pos       = index($text, $toIndex);
  my $offset    = $pos+$long;
  $text         = substr($text,$offset,$lineWidth-$offset);

  return($text);

}  #--- End truncateText

#--------------------------#
sub createDumpChatReport
#--------------------------#
{
  # Local variables
	my ($htmlChatPage, $safeMode, $chatName, $interlocutor, $interlocutorURL, $refMessages, $nbrMessages) = @_;
  my $count = 0;
	
	# Progress bar
	$winPb->pbWinPb2->SetRange(0, $nbrMessages);
	$winPb->pbWinPb2->SetPos(0);
	$winPb->pbWinPb2->SetStep(1);
	$winPb->lblCount2->Text("0/$nbrMessages");
	
  # Save the chat in a HTML file
	open(HTML, ">:encoding(UTF-8)", $htmlChatPage);
	print HTML "<!DOCTYPE html>\n";
	print HTML "<html>\n<head>\n<title>$interlocutor</title>\n";
	print HTML "<meta charset=\"UTF-8\">\n";
	print HTML "<style>\n";
	print HTML "table, th, td {\n";
  print HTML "  border: 1px solid black;\n";
  print HTML "  border-collapse: collapse;\n";
	print HTML "}\n";
	print HTML "th, td {\n";
  print HTML "  padding: 5px;\n";
	print HTML "}\n";
	print HTML "</style>\n";
	print HTML "</head>\n";
	print HTML "<body>\n";
	print HTML "<h1 style=\"color:#003300;font-size: 18pt;font-variant: small-caps;font-weight: bold;\;text-align: center;\">";
	print HTML "$interlocutor</h1>\n";
	print HTML "<h2 style=\"color:#003300;font-size: 16pt;\;text-align: center;\">";
	print HTML "<a href=\"$interlocutorURL\" target=\"_blank\">$interlocutorURL<\/a></h2>\n";
	print HTML "<table style=\"margin: auto;\">\n";
	print HTML "<tr>\n";
	print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'image'}</td>\n";
	print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'name'}</td>\n";
	print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'date'}</td>\n";
	print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'time'}</td>\n";
	print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'message'}</td>\n";
	print HTML "</tr>\n";
	foreach my $msg (sort { $a <=> $b } keys %{$refMessages}) {
		foreach my $partMsg (sort { $a <=> $b } keys %{$$refMessages{$msg}}) {
			print HTML "<tr>\n";
			my $isMe = 1 if $$refMessages{$msg}{$partMsg}{'senderName'} eq 'Me';
			# Image
			my $imgTag;
			if    ($isMe and $winChat->chHideMe->Checked()) { print HTML "<td style=\"background-color:black\">"; }
			elsif (!$isMe) {
				print HTML "<td style=\"background-color:#E0E0E0;text-align: center;vertical-align: center;\">";
				my $imgPath;
				if ($safeMode) 			 { $imgPath = "$$refMessages{$msg}{$partMsg}{'senderImg'}";                   	   }
				else           			 { $imgPath = "images_$chatName\\$$refMessages{$msg}{$partMsg}{'senderImg'}"; 		 }
				if ($imgPath ne '-') { $imgTag  = "<img src=\"$imgPath\" alt=\"\" style=\"width:32px;height:32px;\">"; }
				else                 { $imgTag  = '-'; };
			}
			else { print HTML "<td>"; }
			if ($$refMessages{$msg}{$partMsg}{'senderImg'}) { print HTML "$imgTag</td>\n"; }
			else { print HTML "</td>\n"; }
			# Name
			if    ($isMe and $winChat->chHideMe->Checked())  { print HTML "<td style=\"background-color:black\">";   }
			elsif (!$isMe)                                   { print HTML "<td style=\"background-color:#E0E0E0\">"; }
			else                                             { print HTML "<td>"; }
			if ($$refMessages{$msg}{$partMsg}{'senderName'}) { print HTML "$$refMessages{$msg}{$partMsg}{'senderName'}</td>\n"; }
			else { print HTML "</td>\n"; }
			# Date
			if    ($isMe and $winChat->chHideMe->Checked()) { print HTML "<td style=\"background-color:black\">";   }
			elsif (!$isMe) 																	{ print HTML "<td style=\"background-color:#E0E0E0\">"; }
			else 																						{ print HTML "<td>"; }
			if ($$refMessages{$msg}{$partMsg}{'date'}) {
				my $dateStr = &formatDate($$refMessages{$msg}{$partMsg}{'date'});
				my $date = (split(/ /, $dateStr))[0];
				print HTML "$date</td>\n";
			} else { print HTML "</td>\n"; }
			# Time
			if    ($isMe and $winChat->chHideMe->Checked()) { print HTML "<td style=\"background-color:black\">";   }
			elsif (!$isMe) 																	{ print HTML "<td style=\"background-color:#E0E0E0\">"; }
			else 																						{ print HTML "<td>"; }
			if ($$refMessages{$msg}{$partMsg}{'time'}) {
				my $senderName = $$refMessages{$msg}{$partMsg}{'senderName'};
				if ($senderName and $$refMessages{$msg}{$partMsg}{'time'} =~ /$senderName /) { $$refMessages{$msg}{$partMsg}{'time'} =~ s/$senderName //; }
				if ($$refMessages{$msg}{$partMsg}{'time'} =~ /(\w+ \d{1,2}, \d{4} \d{1,2}:\d{2} [ap]m)/) {
					my $strp = DateTime::Format::Strptime->new(pattern => '%B %e, %Y %l:%M %p');
					my $dt   = $strp->parse_datetime($1);
					$$refMessages{$msg}{$partMsg}{'time'} = $dt->hms;
				}
				print HTML "$$refMessages{$msg}{$partMsg}{'time'}</td>\n";
			} else { print HTML "</td>\n"; }
			# Messages
			if    ($isMe and $winChat->chHideMe->Checked()) { print HTML "<td style=\"background-color:black\">";   }
			elsif (!$isMe)                                  { print HTML "<td style=\"background-color:#E0E0E0\">"; }
			else                                            { print HTML "<td>"; }
			if ($$refMessages{$msg}{$partMsg}{'messages'})  { print HTML "$$refMessages{$msg}{$partMsg}{'messages'}</td>\n"; }
			else { print HTML "</td>\n"; }
			print HTML "</tr>\n";
			
			$count++;
			$winPb->lblCount2->Text("$count/$nbrMessages");
			$winPb->pbWinPb2->StepIt();
		}
	}
	print HTML "</table>\n</body>\n</html>\n";
	close(HTML);

}  #--- End createDumpChatReport

#--------------------------#
sub winChat_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winChat->AbsLeft();
    my $winTop  = $winChat->AbsTop();
    $CONFIG{'WINCHAT_LEFT'} = $winLeft;
    $CONFIG{'WINCHAT_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  return(-1);

}  #--- Fin winChat_Terminate

#--------------------------#
sub winVocalMsg
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winVocalMsg->tfVocalMsgName->Text('');
    
    # Start the thread
    $THR = threads->create(\&winVocalMsgThr);
    
    usleep(500000);
    if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINVM_LEFT'} and $CONFIG{'WINVM_TOP'}) {
      $winVocalMsg->Left($CONFIG{'WINVM_LEFT'});
      $winVocalMsg->Top($CONFIG{'WINVM_TOP'});
    } else { $winVocalMsg->Center(); }
    $winVocalMsg->DoModal();
  }

}  #--- End winVocalMsg

#--------------------------#
sub btnVocalMsgRefresh_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    $winVocalMsg->tfVocalMsgName->Text('');
    $THR = threads->create(\&winVocalMsgThr);
  }
  
}  #--- End btnVocalMsgRefresh_Click

#--------------------------#
sub winVocalMsgThr
#--------------------------#
{
  # Local variables
  my $saveDir = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($msgErr =~ /NS_ERROR_FILE_IS_LOCKED/) {
      # Restart a new thread to continue
      $THR = threads->create(\&winVocalMsgThr);
    } else {
      if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
      Win32::GUI::MessageBox($winVocalMsg, $STR{'err3'}, $STR{'err1T'}, 0x40010);
    }
  };
  
  my $mech;
  eval { $mech = WWW::Mechanize::Firefox->new(tab => 'current'); };
  if ($@) {
    if ($@ =~ /Failed to connect to/) {
      $winVocalMsg->btnVocalMsgOk->Disable();
      Win32::GUI::MessageBox($winVocalMsg, $STR{'err1'}, $STR{'err1T'}, 0x40010);
    }
    threads->exit();
  }
  
  if ($mech->uri() =~ /m.facebook.com/) {
		if (my $interlocutor = $mech->selector('span._52jh', any => 1)) {
			my $encodedName = encode($CONFIG{'CHARSET'}, $interlocutor->{innerHTML});
			$winVocalMsg->tfVocalMsgName->Text($encodedName);
		}
  } else { Win32::GUI::MessageBox($winVocalMsg, $STR{'warn5'}, $STR{'err1T'}, 0x40010); }
  $winVocalMsg->ChangeCursor($ARROW);
  
  # Ready ?
  &isDumpVocalMsgReady();

}  #--- End winVocalMsgThr

#--------------------------#
sub tfVocalMsgName_Change
#--------------------------#
{
  # Local variables
  my $saveDir = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winVocalMsg->chSaveVocalMsgDir->Checked()) {
    $CONFIG{'DIR_SAVE_VM'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpVocalMsgReady();

}  #--- End tfVocalMsgName_Change

#--------------------------#
sub tfDirSaveVocalMsg_Change
#--------------------------#
{
  # Local variables
  my $VocalMsgName = $winVocalMsg->tfVocalMsgName->Text();
  my $saveDir      = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  # Remember the save dir
  if ($saveDir and -d $saveDir and $winVocalMsg->chSaveVocalMsgDir->Checked()) {
    $CONFIG{'DIR_SAVE_VM'} = $saveDir;
    &saveConfig(\%CONFIG);
  }
  
  # Ready ?
  &isDumpVocalMsgReady();

}  #--- End tfDirSaveVocalMsg_Change

#--------------------------#
sub btnDirSaveVocalMsg_Click
#--------------------------#
{
  # Local variables
  my $lastDir = $winVocalMsg->tfDirSaveVocalMsg->Text();
  my $dir;

  # Show dialog window
  if ($lastDir) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) {
      while ($lastDir =~ /[^\\]$/) { chop($lastDir); }
    }
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winVocalMsg	,
                                        -title      => $STR{'selDir'} 	,
                                        -folderonly => 1              	,
                                        -directory  => $lastDir       	,
                                        -newui      => 1              	, );
  } else {
    $dir = Win32::GUI::BrowseForFolder( -owner      => $winVocalMsg	,
                                        -title      => $STR{'selDir'} 	,
                                        -folderonly => 1              	,
                                        -newui      => 1              	, );
  }

  # Selected folder
  if ($dir and -d $dir) {
    if ($dir =~ /\\$/) { chop($dir); }
    $winVocalMsg->tfDirSaveVocalMsg->Text($dir);
  }
  
}  #--- End btnDirSaveVocalMsg_Click

#--------------------------#
sub btnBrowseDirSaveVocalMsg_Click
#--------------------------#
{
  # Local variables
  my $outputDir = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  if (-d $outputDir) {
    # Open Window Explorer
    Win32::Process::Create(my $ProcessObj                 ,
                           "$ENV{'WINDIR'}\\explorer.exe" ,
                           "explorer $outputDir"          ,
                           0                              ,
                           NORMAL_PRIORITY_CLASS          ,
                           ".");
  }
  
}  #--- End btnBrowseDirSaveVocalMsg_Click

#--------------------------#
sub chSaveVocalMsgDir_Click
#--------------------------#
{
  # Local variables
  my $dir = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  # If directory exists, save it
  if ($dir and -d $dir and $winVocalMsg->chSaveVocalMsgDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_VM'} = 1;
    $CONFIG{'DIR_SAVE_VM'} = $dir;
    &saveConfig(\%CONFIG);
  # Don't save
  } elsif (!$winVocalMsg->chSaveVocalMsgDir->Checked()) {
    $CONFIG{'REMEMBER_SAVE_VM'} = 0;
    delete($CONFIG{'DIR_SAVE_VM'});
    &saveConfig(\%CONFIG);
  }

}  #--- End chSaveVocalMsgDir_Click

#--------------------------#
sub chVocalMsgOpenOutput_Click
#--------------------------#
{
  # Save the choice
  if ($winVocalMsg->chVocalMsgOpenOutput->Checked()) {
    $CONFIG{'VM_OPEN_OUTPUT'} = 1;
    &saveConfig(\%CONFIG);
  # Don't save
  } else {
    $CONFIG{'VM_OPEN_OUTPUT'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chVocalMsgOpenOutput_Click

#--------------------------#
sub isDumpVocalMsgReady
#--------------------------#
{
  # Local variables
  my $vocalMsgName = $winVocalMsg->tfVocalMsgName->Text();
  my $saveDir      = $winVocalMsg->tfDirSaveVocalMsg->Text();
  
  # Valid directory and valid name for save ?
  if (!$saveDir or !(-d $saveDir) or !$vocalMsgName) {
    $winVocalMsg->btnVocalMsgOk->Disable();
    return(0);
  }

  $winVocalMsg->btnVocalMsgOk->Enable();

}  #--- End isDumpVocalMsgReady

#--------------------------#
sub btnVocalMsgOk_Click
#--------------------------#
{
  # Avoid new thread
  if ($THR and $THR->is_running()) {
    Win32::GUI::MessageBox($win, $STR{'warn1'},$STR{'warn1T'},0x40010);
  } else {
    # Remember position
    if ($winConfig->chRememberPos->Checked()) {
      my $winLeft = $winVocalMsg->AbsLeft();
      my $winTop  = $winVocalMsg->AbsTop();
      $CONFIG{'WINVM_LEFT'} = $winLeft;
      $CONFIG{'WINVM_TOP'}  = $winTop;
      &saveConfig(\%CONFIG);
    }
    
    # Local variables
    my $vocalMsgName  	= $winVocalMsg->tfVocalMsgName->Text();
    $vocalMsgName     	=~ s/[\<\>\:\"\/\\\|\?\*]/-/g;
    my $saveDir         = $winVocalMsg->tfDirSaveVocalMsg->Text();
    my %listVocalMsg;
    my $nbrVM		        = 0;
    my $posPb1          = 0;
    my $step            = 0;
    my $nbrVMDone				= 0;
    my $nbrRetries			= 0;

    if ($vocalMsgName and -d $saveDir) {
      # Start the thread
      $THR = threads->create(\&dumpVocalMsg, $vocalMsgName, $saveDir, \%listVocalMsg, $nbrVM, 
                             $nbrVMDone, $posPb1, $step, $nbrRetries);
      return(-1);
    } else { Win32::GUI::MessageBox($win, $STR{'err5'}, $STR{'err1T'}, 0x40010); }
  }

}  #--- End btnVocalMsgOk_Click

#--------------------------#
sub dumpVocalMsg
#--------------------------#
{
  # Local variables
  my ($vocalMsgName, $saveDir, $refListVocalMsg, $nbrVM, $nbrVMDone, $posPb1, $step, $nbrRetries) = @_;
  my $firstExec    = 0;

  # Cancel button
  $SIG{'KILL'} = sub {
    $win->ChangeCursor($ARROW);
    $win->Tray->Change(-tip => $STR{'dumpVocalMsgC'});
    # Turn off progress bar
    $winPb->lblPbCurr1->Text('');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    $winPb->pbWinPb1->SetPos(0);
    $winPb->pbWinPb2->SetPos(0);
    &winPb_Terminate;
    threads->exit();
  };
  
  # Deal with crash
  $SIG{__DIE__} = sub {
    my $msgErr = $_[0];
    chomp($msgErr);
    $msgErr =~ s/[\t\r\n]/ /g;
    if ($winConfig->chDebugLogging->Checked()) { &debug($msgErr); }
    $win->ChangeCursor($ARROW);
    $posPb1 = $winPb->pbWinPb1->GetPos();
    # Retry 10 times
    if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) {
      $nbrRetries++;
      # Progress window
      $winPb->pbWinPb2->SetPos(0);
      $winPb->lblPbCurr2->Text('');
      $winPb->lblCount2->Text('');
    }
    if ($nbrRetries < $CONFIG{'NBR_RESUME'}) {
      # Restart a new thread to continue
      if ($msgErr !~ /NS_ERROR_FILE_IS_LOCKED/) { $winPb->lblPbCurr1->Text($STR{'crash'}.'...'); }
      sleep(2);
      $THR = threads->create(\&dumpVocalMsg, $vocalMsgName, $saveDir, $refListVocalMsg, $nbrVM, 
                             $nbrVMDone, $posPb1, $step, $nbrRetries);
    } else {
			my $err = (split(/ at /, $msgErr))[0];
      Win32::GUI::MessageBox($winPb, "$STR{'err3'}: $err", $STR{'err1T'}, 0x40010);
      # Turn off progress bar
      $winPb2->lblPbCurr->Text('');
      $winPb2->lblCount->Text('');
      &winPb2_Terminate;
      $win->ChangeCursor($ARROW);
      $win->Tray->Change(-tip => 'ExtractFace');
    }
    # Kill this thread
    threads->exit();
  };
	
  # First execution
  if (!$step) {
		# Turn on progress bar
		$winPb->Center($winChat);
		$winPb->Show();
		$win->Disable();
		$winPb->lblPbCurr1->Text($STR{'dumpVocalMsgP'}.'...');
		$winPb->pbWinPb1->SetRange(0, 3);
		$winPb->pbWinPb1->SetPos(0);
		$winPb->pbWinPb1->SetStep(1);
    $win->ChangeCursor($HOURGLASS);
    $win->Tray->Change(-tip => $STR{'dumpVocalMsgP'}.'...');
		$step = 1;
  }
	
	# Connect to current tab in Firefox
	my $mech = WWW::Mechanize::Firefox->new(tab => 'current', autodie => 0);
	
	# Browse all the conversation and parse the pages to list vocal messages
	if ($step == 1) {
		$winPb->lblPbCurr1->Text($STR{'browseAllChat'}.'...');
		# Parse current page
		my @msgs = $mech->selector('div.messageAttachments a');
		foreach my $msg (@msgs) {
			if ($msg->{href} =~ /(audioclip[^\.]+\.mp4)/) {
				my $name = $1;
				if ($msg->{href} =~ /u=([^\&]+)\&/) {
					$$refListVocalMsg{$name}{'url'} = unescape($1);
				}
			}
		}
		# Browse all other message messages
		my $seeOlderLink = ($mech->selector('div.acw.apm a', any => 1))[0];
		while ($seeOlderLink and $seeOlderLink->{outerHTML} =~ /last_message_timestamp/) {
			$seeOlderLink->click();
			sleep($CONFIG{'TIME_TO_WAIT'});
			my @msgs = $mech->selector('div.messageAttachments a');
			foreach my $msg (@msgs) {
				if ($msg->{href} =~ /(audioclip[^\.]+\.mp4)/) {
					my $name = $1;
					if ($msg->{href} =~ /u=([^\&]+)\&/) {
						$$refListVocalMsg{$name}{'url'} = unescape($1);
					}
				}
			}
			$seeOlderLink = ($mech->selector('div.acw.apm a', any => 1))[0];
		}
		$step = 2;
		$winPb->pbWinPb1->StepIt();
		$winPb->lblCount1->Text("1/3");
	}
	
	# Download Vocal Message
	if ($step == 2) {
		# Progress bar
		$nbrVM = keys %{$refListVocalMsg};
		$winPb->pbWinPb2->SetRange(0, $nbrVM);
		$winPb->pbWinPb2->SetPos($nbrVMDone);
		$winPb->pbWinPb2->SetStep(1);
		$winPb->lblCount2->Text("$nbrVMDone/$nbrVM");
		$winPb->lblPbCurr1->Text($STR{'downloadVM'}.'...');
		if (!-d "$saveDir\\vm_$vocalMsgName") { mkdir("$saveDir\\vm_$vocalMsgName"); }
		# Download all vocal messages
		my $k = 0;
		foreach my $name (sort keys %{$refListVocalMsg}) {
			if ($k >= $nbrVMDone) {
				my $vmFilename = "$saveDir\\vm_$vocalMsgName\\$name";
				if (!-e $vmFilename and $$refListVocalMsg{$name}{'url'}) {
					$winPb->lblPbCurr2->Text("$STR{'downloading'} $name...");
					$mech->save_url($$refListVocalMsg{$name}{'url'}, $vmFilename);
				}
				$$refListVocalMsg{$name}{'path'} = "vm_$vocalMsgName\\$name";
				$nbrVMDone++;
			}
			$k++;
			$winPb->pbWinPb2->StepIt();
			$winPb->lblCount2->Text("$k/$nbrVM");
		}
		$step = 3;
		$winPb->lblPbCurr2->Text('');
		$winPb->lblCount2->Text('');
		$winPb->pbWinPb2->SetPos(0);
		$winPb->pbWinPb1->StepIt();
		$winPb->lblCount1->Text("2/3");
	}
	
  # Save the Vocal Message list in a HTML file
	my $htmlVMPage;
	if ($step == 3 and $nbrVM) {
		my $count = 0;
		$winPb->lblPbCurr1->Text($STR{'saveChat'}.'...');
		# Progress bar
		$winPb->pbWinPb2->SetRange(0, $nbrVM);
		$winPb->pbWinPb2->SetPos(0);
		$winPb->pbWinPb2->SetStep(1);
		$winPb->lblCount2->Text("0/$nbrVM");
		$htmlVMPage = "$saveDir\\$vocalMsgName.html";
		open(HTML, ">:encoding(UTF-8)", $htmlVMPage);
		print HTML "<!DOCTYPE html>\n";
		print HTML "<html>\n<head>\n<title>$vocalMsgName</title>\n";
		print HTML "<meta charset=\"UTF-8\">\n";
		print HTML "<style>\n";
		print HTML "table, th, td {\n";
		print HTML "  border: 1px solid black;\n";
		print HTML "  border-collapse: collapse;\n";
		print HTML "}\n";
		print HTML "th, td {\n";
		print HTML "  padding: 5px;\n";
		print HTML "}\n";
		print HTML "</style>\n";
		print HTML "</head>\n";
		print HTML "<body>\n";
		print HTML "<h1 style=\"color:#003300;font-size: 18pt;font-variant: small-caps;font-weight: bold;\;text-align: center;\">";
		print HTML "$vocalMsgName</h1>\n";
		print HTML "<table style=\"margin: auto;\">\n";
		print HTML "<tr>\n";
		print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'file'}</td>\n";
		print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'url'}</td>\n";
		print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'date'}</td>\n";
		print HTML "<td style=\"font-weight: bold;text-align: center;\">$STR{'listen'}</td>\n";
		print HTML "</tr>\n";
		foreach my $name (sort keys %{$refListVocalMsg}) {
			print HTML "<tr>";
			print HTML "<td>$name</td>";
			print HTML "<td>$$refListVocalMsg{$name}{'url'}</td>";
			if ($name =~ /-(\d{10})/) {
				my $dt = DateTime->from_epoch(epoch => $1);
				print HTML "<td>" . $dt->strftime('%F %T') . "</td>";
			} else { print HTML "<td></td>"; }
			if ($$refListVocalMsg{$name}{'path'}) {
				print HTML "<td><audio controls><source src=\"" . $$refListVocalMsg{$name}{'path'} . "\" type=\"audio/mp4\"></audio></td>";
			}
			print HTML "</tr>\n";
			$count++;
			$winPb->lblCount2->Text("$count/$nbrVM");
			$winPb->pbWinPb2->StepIt();
		}
		print HTML "</table>\n</body>\n</html>\n";
		close(HTML);
		$winPb->pbWinPb1->StepIt();
		$winPb->lblCount1->Text("3/3");
	}
	
	# Turn off progress bar
	$winPb->lblPbCurr1->Text('');
	$winPb->lblCount1->Text('');
	$winPb->lblPbCurr2->Text('');
	$winPb->lblCount2->Text('');
	$winPb->pbWinPb1->SetPos(0);
	$winPb->pbWinPb2->SetPos(0);
	&winPb_Terminate;
	
	# Delete temporary files
	if ($winConfig->chDelTempFiles->Checked()) { remove_tree("$saveDir\\temp"); }
	
	# Finish
	if ($htmlVMPage) {
		if ($winVocalMsg->chVocalMsgOpenOutput->Checked()) {
			$win->ShellExecute('open', $htmlVMPage,'','',1); # Open the page
		}
	} else { Win32::GUI::MessageBox($win, "$STR{'noMsgDumped'}.", $STR{'winVocalMsg'}, 0x40040); } # No Vocal Messages were dumped

  $win->Tray->Change(-tip => $STR{'dumpVocalMsgF'});
  if (!$win->IsVisible()) {
    $win->Tray->Change( -balloon_icon  => 'info'        ,
                        -balloon_title => 'ExtractFace' ,
                        -balloon_tip   => $STR{'dumpVocalMsgF'} , );
    $win->Tray->ShowBalloon(1);
  }
  $win->ChangeCursor($ARROW);

}  #--- End dumpVocalMsg

#--------------------------#
sub winVocalMsg_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winVocalMsg->AbsLeft();
    my $winTop  = $winVocalMsg->AbsTop();
    $CONFIG{'WINVM_LEFT'} = $winLeft;
    $CONFIG{'WINVM_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  return(-1);

}  #--- Fin winVocalMsg_Terminate

#--------------------------#
sub btnCancel_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb->lblPbCurr1->Text($STR{'cancel2'}.'...');
    $winPb->lblCount1->Text('');
    $winPb->lblPbCurr2->Text('');
    $winPb->lblCount2->Text('');
    &winPb_Terminate;
    if ($THR->is_running()) { $THR->kill('KILL')->detach(); }
    $win->ChangeCursor($ARROW);
  }
  return(1);

}  #--- End btnCancel_Click

#--------------------------#
sub btnCancel2_Click
#--------------------------#
{
  # Stop requests
  if ($THR) {
    $winPb2->lblPbCurr->Text($STR{'cancel2'}.'...');
    $winPb2->lblPbCurr->Text('');
    $winPb2->lblCount->Text('');
    &winPb2_Terminate;
    if ($THR->is_running()) { $THR->kill('KILL')->detach(); }
    $win->ChangeCursor($ARROW);
  }
  return(1);

}  #--- End btnCancel2_Click

#--------------------------#
sub winConfig
#--------------------------#
{
  # Default tab is General options
  $winConfig->configTab->Select(0);
  $winConfig->lblTool->Show();
  $winConfig->btnExportLang->Show();
  $winConfig->btnCheckUpdate->Show();
  $winConfig->chAutoUpdate->Show();
  $winConfig->lblFunctions->Show();
  $winConfig->chRememberPos->Show();
  $winConfig->lblTimeToWait->Show();
  $winConfig->tfTimeToWait->Show();
  $winConfig->upTimeToWait->Show();
  $winConfig->lblTimeToWait2->Show();
  $winConfig->lblNbrResume->Show();
  $winConfig->tfNbrResume->Show();
  $winConfig->upNbrResume->Show();
  $winConfig->chDelTempFiles->Show();
  $winConfig->chDebugLogging->Show();
  $winConfig->lblCharset->Show();
  $winConfig->cbCharset->Show();
  $winConfig->btnOpenLog->Show();
  $winConfig->chOptSeemore->Hide();
  $winConfig->chOptComments->Hide();
  $winConfig->chOptPosts->Hide();
  $winConfig->chOptTranslate->Hide();
  $winConfig->lblMaxScrollChat->Hide();
  $winConfig->rbMaxScrollChatByPage->Hide();
  $winConfig->tfMaxScrollChat->Hide();
  $winConfig->upMaxScrollChat->Hide();
  $winConfig->rbMaxScrollChatByDate->Hide();
  $winConfig->dtMaxScrollChatByDate->Hide();
  $winConfig->lblMaxScroll->Hide();
  $winConfig->rbMaxScrollByPage->Hide();
  $winConfig->tfMaxScroll->Hide();
  $winConfig->upMaxScroll->Hide();
  $winConfig->rbMaxScrollByDate->Hide();
  $winConfig->dtMaxScrollByDate->Hide();
  $winConfig->chOptScrollTop->Hide();
  
  if ($winConfig->chRememberPos->Checked() and $CONFIG{'WINCONFIG_LEFT'} and $CONFIG{'WINCONFIG_TOP'}) {
    $winConfig->Left($CONFIG{'WINCONFIG_LEFT'});
    $winConfig->Top($CONFIG{'WINCONFIG_TOP'});
  } else { $winConfig->Center(); }
  $winConfig->DoModal();

}  #--- End winConfig

#--------------------------#
sub configTab_Click
#--------------------------#
{
  # Show General Options
  if (!$winConfig->configTab->SelectedItem()) {
    $winConfig->lblTool->Show();
    $winConfig->btnExportLang->Show();
    $winConfig->btnCheckUpdate->Show();
    $winConfig->chAutoUpdate->Show();
    $winConfig->lblFunctions->Show();
    $winConfig->chRememberPos->Show();
    $winConfig->lblTimeToWait->Show();
    $winConfig->tfTimeToWait->Show();
    $winConfig->upTimeToWait->Show();
    $winConfig->lblTimeToWait2->Show();
    $winConfig->lblNbrResume->Show();
    $winConfig->tfNbrResume->Show();
    $winConfig->upNbrResume->Show();
    $winConfig->chDelTempFiles->Show();
    $winConfig->chDebugLogging->Show();
    $winConfig->lblCharset->Show();
    $winConfig->cbCharset->Show();
    $winConfig->btnOpenLog->Show();
    $winConfig->lblMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByPage->Hide();
    $winConfig->tfMaxScrollChat->Hide();
    $winConfig->upMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByDate->Hide();
    $winConfig->dtMaxScrollChatByDate->Hide();
    $winConfig->lblMaxScroll->Hide();
    $winConfig->rbMaxScrollByPage->Hide();
    $winConfig->tfMaxScroll->Hide();
    $winConfig->upMaxScroll->Hide();
    $winConfig->rbMaxScrollByDate->Hide();
    $winConfig->dtMaxScrollByDate->Hide();
    $winConfig->chOptScrollTop->Hide();
    $winConfig->chOptSeemore->Hide();
    $winConfig->chOptComments->Hide();
    $winConfig->chOptPosts->Hide();
    $winConfig->chOptTranslate->Hide();
    
  # Show Scroll Options
  } elsif ($winConfig->configTab->SelectedItem() == 1) {
    $winConfig->lblMaxScrollChat->Show();
    $winConfig->rbMaxScrollChatByPage->Show();
    $winConfig->tfMaxScrollChat->Show();
    $winConfig->upMaxScrollChat->Show();
    $winConfig->rbMaxScrollChatByDate->Show();
    $winConfig->dtMaxScrollChatByDate->Show();
    $winConfig->lblMaxScroll->Show();
    $winConfig->rbMaxScrollByPage->Show();
    $winConfig->tfMaxScroll->Show();
    $winConfig->upMaxScroll->Show();
    $winConfig->rbMaxScrollByDate->Show();
    $winConfig->dtMaxScrollByDate->Show();
    $winConfig->chOptScrollTop->Show();
    $winConfig->chOptSeemore->Hide();
    $winConfig->chOptComments->Hide();
    $winConfig->chOptPosts->Hide();
    $winConfig->chOptTranslate->Hide();
    $winConfig->lblTool->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->lblFunctions->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblTimeToWait->Hide();
    $winConfig->tfTimeToWait->Hide();
    $winConfig->upTimeToWait->Hide();
    $winConfig->lblTimeToWait2->Hide();
    $winConfig->lblNbrResume->Hide();
    $winConfig->tfNbrResume->Hide();
    $winConfig->upNbrResume->Hide();
    $winConfig->chDelTempFiles->Hide();
    $winConfig->chDebugLogging->Hide();
    $winConfig->lblCharset->Hide();
    $winConfig->cbCharset->Hide();
    $winConfig->btnOpenLog->Hide();
  
  # Show Chat options
  } else {
    $winConfig->chOptSeemore->Show();
    $winConfig->chOptComments->Show();
    $winConfig->chOptPosts->Show();
    $winConfig->chOptTranslate->Show();
    $winConfig->lblTool->Hide();
    $winConfig->btnExportLang->Hide();
    $winConfig->btnCheckUpdate->Hide();
    $winConfig->chAutoUpdate->Hide();
    $winConfig->lblFunctions->Hide();
    $winConfig->chRememberPos->Hide();
    $winConfig->lblTimeToWait->Hide();
    $winConfig->tfTimeToWait->Hide();
    $winConfig->upTimeToWait->Hide();
    $winConfig->lblTimeToWait2->Hide();
    $winConfig->lblNbrResume->Hide();
    $winConfig->tfNbrResume->Hide();
    $winConfig->upNbrResume->Hide();
    $winConfig->chDelTempFiles->Hide();
    $winConfig->chDebugLogging->Hide();
    $winConfig->lblCharset->Hide();
    $winConfig->cbCharset->Hide();
    $winConfig->btnOpenLog->Hide();
    $winConfig->lblMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByPage->Hide();
    $winConfig->tfMaxScrollChat->Hide();
    $winConfig->upMaxScrollChat->Hide();
    $winConfig->rbMaxScrollChatByDate->Hide();
    $winConfig->dtMaxScrollChatByDate->Hide();
    $winConfig->lblMaxScroll->Hide();
    $winConfig->rbMaxScrollByPage->Hide();
    $winConfig->tfMaxScroll->Hide();
    $winConfig->upMaxScroll->Hide();
    $winConfig->rbMaxScrollByDate->Hide();
    $winConfig->dtMaxScrollByDate->Hide();
    $winConfig->chOptScrollTop->Hide();
  }

}  #--- End configTab_Click

#--------------------------#
sub winConfig_Terminate
#--------------------------#
{
  # Remember position
  if ($winConfig->chRememberPos->Checked()) {
    my $winLeft = $winConfig->AbsLeft();
    my $winTop  = $winConfig->AbsTop();
    $CONFIG{'WINCONFIG_LEFT'} = $winLeft;
    $CONFIG{'WINCONFIG_TOP'}  = $winTop;
    &saveConfig(\%CONFIG);
  }
  
  return(-1);

}  #--- End winConfig_Terminate

#--------------------------#
sub btnExportLang_Click
#--------------------------#
{
  # Save strings in Lang.ini
  open(LANG,">$LANG_FILE");
  flock(LANG, 2);
  foreach my $cle (keys %STR) { print LANG "$cle = $STR{$cle}\n"; }
  close(LANG);
  # Open the page
  $win->ShellExecute('open', $LANG_FILE,'','',1);

}  #--- End btnExportLang_Click

#--------------------------#
sub btnCheckUpdate_Click
#--------------------------#
{
  &checkUpdate(1);

}  #--- End btnCheckUpdate_Click

#--------------------------#
sub checkUpdate
#--------------------------#
{
  # Local variables
  my $confirm = shift;
  
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent("ExtractFaceUpdate $VERSION");
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    if ($content =~ /([\d\.]+)/i) { $currVer = $1; }
    # No update available
    if ($currVer le $VERSION) {
      if ($confirm) { Win32::GUI::MessageBox($win, $STR{'update1'}, $STR{'update2'}, 0x40040); } # Up to date
    } else {
      $win->Show();
      # Download with browser
      my $answer = Win32::GUI::MessageBox($winConfig, "$STR{'update4'} $currVer $STR{'update5'} ?", $STR{'update3'}, 0x40024);
      if ($answer == 6) {
        # Open Firefox to XL-Tools page
        $win->ShellExecute('open', $URL_TOOL,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} ExtractFace",0x40010);
      }
    }
  }
  # Error 
  else {
    my $status  = $res->code;
    my $error   = $res->status_line;
    Win32::GUI::MessageBox($win, "$STR{'err1T'}: $STR{'returnedCode'} = [$status]; $STR{'returnedError'} = [$error].", $STR{'err7'},0x40010);
  }

}  #--- End checkUpdate

#--------------------------#
sub chAutoUpdate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chAutoUpdate->Checked()) {
    $CONFIG{'AUTO_UPDATE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'AUTO_UPDATE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chAutoUpdate_Click

#--------------------------#
sub chRememberPos_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chRememberPos->Checked()) {
    $CONFIG{'REMEMBER_POS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'REMEMBER_POS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chRememberPos_Click

#--------------------------#
sub tfTimeToWait_Change
#--------------------------#
{
  # Local variables
  my $timeToWait = $winConfig->tfTimeToWait->Text();
  
  # Remember
  if ($START == 1) {
    $CONFIG{'TIME_TO_WAIT'} = $timeToWait;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfTimeToWait_Change

#--------------------------#
sub tfNbrResume_Change
#--------------------------#
{
  # Local variables
  my $nbrResume = $winConfig->tfNbrResume->Text();
  
  # Remember
  if ($START == 1) {
    $CONFIG{'NBR_RESUME'} = $nbrResume;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfNbrResume_Change

#--------------------------#
sub chDelTempFiles_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDelTempFiles->Checked()) {
    $CONFIG{'DEL_TEMP_FILES'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'DEL_TEMP_FILES'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDelTempFiles_Click

#--------------------------#
sub chDebugLogging_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chDebugLogging->Checked()) {
    $CONFIG{'DEBUG_LOGGING'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'DEBUG_LOGGING'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chDebugLogging_Click

#--------------------------#
sub cbCharset_Change
#--------------------------#
{
  my $charset = $winConfig->cbCharset->GetString($winConfig->cbCharset->GetCurSel());
  
  # Save the choice
  $CONFIG{'CHARSET'} = $charset;
  &saveConfig(\%CONFIG);

}  #--- End cbCharset_Change

#--------------------------#
sub btnOpenLog_Click
#--------------------------#
{
  # Open file with default program
  if ($DEBUG_FILE and -T $DEBUG_FILE) {
    $win->ShellExecute('open', $DEBUG_FILE,'','',1) or
      Win32::GUI::MessageBox($win, "$STR{'errorOpening'}: ".Win32::FormatMessage(Win32::GetLastError()), $STR{'err1T'}, 0x40010);
  }

}  #--- End btnOpenLog_Click

#--------------------------#
sub tfMaxScrollChat_Change
#--------------------------#
{
  # Local variables
  my $maxScroll = $winConfig->tfMaxScrollChat->Text();

  # Remember
  if ($START == 1) {
    $winConfig->rbMaxScrollChatByDate->Checked(0);
    $winConfig->rbMaxScrollChatByPage->Checked(1);
    $CONFIG{'MAX_LOADING_MSG'} = $maxScroll;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxScrollChat_Change

#--------------------------#
sub dtMaxScrollChatByDate_Change
#--------------------------#
{
  $winConfig->rbMaxScrollChatByPage->Checked(0);
  $winConfig->rbMaxScrollChatByDate->Checked(1);

}  #--- End dtMaxScrollChatByDate_Change

#--------------------------#
sub tfMaxScroll_Change
#--------------------------#
{
  # Local variables
  my $maxScroll = $winConfig->tfMaxScroll->Text();  
  
  # Remember
  if ($START == 1) {
    $winConfig->rbMaxScrollByDate->Checked(0);
    $winConfig->rbMaxScrollByPage->Checked(1);
    $CONFIG{'MAX_SCROLL'} = $maxScroll;
    &saveConfig(\%CONFIG);
  }

}  #--- End tfMaxScroll_Change

#--------------------------#
sub dtMaxScrollByDate_Change
#--------------------------#
{
  $winConfig->rbMaxScrollByPage->Checked(0);
  $winConfig->rbMaxScrollByDate->Checked(1);

}  #--- End dtMaxScrollByDate_Change

#--------------------------#
sub chOptScrollTop_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptScrollTop->Checked()) {
    $CONFIG{'OPT_SCROLL_TOP'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'OPT_SCROLL_TOP'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptScrollTop_Click

#--------------------------#
sub chOptSeemore_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptSeemore->Checked()) {
    $CONFIG{'EXPAND_SEE_MORE'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_SEE_MORE'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptSeemore_Click

#--------------------------#
sub chOptPosts_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptPosts->Checked()) {
    $CONFIG{'EXPAND_MORE_POSTS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_MORE_POSTS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptPosts_Click

#--------------------------#
sub chOptComments_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptComments->Checked()) {
    $CONFIG{'EXPAND_MORE_COMMENTS'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'EXPAND_MORE_COMMENTS'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptComments_Click

#--------------------------#
sub chOptTranslate_Click
#--------------------------#
{
  # Save the choice
  if ($winConfig->chOptTranslate->Checked()) {
    $CONFIG{'SEE_TRANSLATION'} = 1;
    &saveConfig(\%CONFIG);
  } else {
    $CONFIG{'SEE_TRANSLATION'} = 0;
    &saveConfig(\%CONFIG);
  }

}  #--- End chOptTranslate_Click

#--------------------------#
sub help
#--------------------------#
{
  # Open Firefox to XL-Tools page
  $win->ShellExecute('open', $URL_DOC,'','',1) or Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "$STR{'update3'} ExtractFace",0x40010);

}  #--- End help

#--------------------------#
sub loadPage
#--------------------------#
{
  # Local variables
  my ($refMech, $url) = @_;
  
  $$refMech->get($url, synchronize => 0);
  sleep($CONFIG{'TIME_TO_WAIT'});
  my $currURL = $$refMech->uri();
  my $currTitle;
  if ($currURL and $currURL =~ /https:\/\/www.facebook.com\//) {
    if    ($currURL =~ /https:\/\/www.facebook.com\/profile.php\?id=([^\/\&]+)/) { $currTitle = $1; }
    elsif ($currURL =~ /https:\/\/www.facebook.com\/([^\/\?]+)/                ) { $currTitle = $1; }
  }

  return($currURL, $currTitle);

}  #--- End loadPage

#--------------------------#
sub formatDate
#--------------------------#
{
  # Local variables
  my $unixtime = shift;
  
  # Convert to string, local timezone
  if ($unixtime =~ /\./) { $unixtime = (split(/\./, $unixtime))[0]; }
  my ($s,$min,$hr,$d,$m,$y,$weekday,$ha,$isDST) = localtime($unixtime);
  $y += 1900;
  $m++;
  $m   = $m   < 10 ? $m   = "0".$m   : $m;
  $d   = $d   < 10 ? $d   = "0".$d   : $d;
  $hr  = $hr  < 10 ? $hr  = "0".$hr  : $hr;
  $min = $min < 10 ? $min = "0".$min : $min;
  $s   = $s   < 10 ? $s   = "0".$s   : $s;
  return("$y-$m-$d $hr:$min:$s");

}  #--- End formatDate

#--------------------------#
sub debug
#--------------------------#
{
  # Local variables
  my $refMsg  = shift;
  my $dateStr = &formatDate(time);
  
  # Save error msg in debug log file
  if (-e $DEBUG_FILE) { open(DEBUG,">>$DEBUG_FILE"); }
  else                { open(DEBUG,">$DEBUG_FILE");  }
  flock(DEBUG, 2);
  print DEBUG "$dateStr\t$refMsg\n";
  close(DEBUG);  

}  #--- End debug

#--------------------------#
sub saveConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # Save configuration hash values
  open(CONFIG,">$CONFIG_FILE");
  flock(CONFIG, 2);
  foreach my $cle (keys %{$refConfig}) { print CONFIG "$cle = $$refConfig{$cle}\n"; }
  close(CONFIG);  

}  #--- End saveConfig

#--------------------------#
sub loadConfig
#--------------------------#
{
  # Local variables
  my $refConfig = shift;
  
  # If ini file exists
  if (-T $CONFIG_FILE) {
    # Open and load config values
    open(CONFIG, $CONFIG_FILE);
    my @tab = <CONFIG>;
    close(CONFIG);
    
    foreach (@tab) {
      chomp($_);
      my ($key, $value) = split(/ = /, $_);
      if ($key) { $$refConfig{$key}  = $value; }
    }
  }
  
  # Start minimized
  if (exists($$refConfig{'START_MINIMIZED'}))       { $win->chStartMinimized->Checked($$refConfig{'START_MINIMIZED'});                  }
  else                                              { $win->chStartMinimized->Checked(0);                                               } # Default is not checked
  
  # General settings
  if (exists($$refConfig{'REMEMBER_POS'}))          { $winConfig->chRememberPos->Checked($$refConfig{'REMEMBER_POS'});                  }
  else                                              { $winConfig->chRememberPos->Checked(0);                                            } # Default is not checked
  if (exists($$refConfig{'TIME_TO_WAIT'}))          { $winConfig->upTimeToWait->SetPos($$refConfig{'TIME_TO_WAIT'});                    }
  else                                              { $winConfig->upTimeToWait->SetPos(2); $$refConfig{'TIME_TO_WAIT'} =  2;            } # Default value is 2
  if (exists($$refConfig{'NBR_RESUME'}))            { $winConfig->upNbrResume->SetPos($$refConfig{'NBR_RESUME'});                       }
  else                                              { $winConfig->upNbrResume->SetPos(10); $$refConfig{'NBR_RESUME'}   = 10;            } # Default value is 10
  if (exists($$refConfig{'OPT_SCROLL_TOP'}))        { $winConfig->chOptScrollTop->Checked($$refConfig{'OPT_SCROLL_TOP'});               }
  else                                              { $winConfig->chOptScrollTop->Checked(1); $$refConfig{'OPT_SCROLL_TOP'} = 1;        } # Default is checked
  if (exists($$refConfig{'AUTO_UPDATE'}))           { $winConfig->chAutoUpdate->Checked($$refConfig{'AUTO_UPDATE'});                    }
  else                                              { $winConfig->chAutoUpdate->Checked(1);   $$refConfig{'AUTO_UPDATE'}    = 1;        } # Default is checked
  if (exists($$refConfig{'DEL_TEMP_FILES'}))        { $winConfig->chDelTempFiles->Checked($$refConfig{'DEL_TEMP_FILES'});               }
  else                                              { $winConfig->chDelTempFiles->Checked(1); $$refConfig{'DEL_TEMP_FILES'} = 1;        } # Default is checked
  if (exists($$refConfig{'DEBUG_LOGGING'}))         { $winConfig->chDebugLogging->Checked($$refConfig{'DEBUG_LOGGING'});                }
  else                                              { $winConfig->chDebugLogging->Checked(0); $$refConfig{'DEBUG_LOGGING'} = 0;         } # Default is not checked
  if (exists($$refConfig{'CHARSET'}))               { $winConfig->cbCharset->SetCurSel($winConfig->cbCharset->FindString($$refConfig{'CHARSET'})); }
  else                                              { $winConfig->cbCharset->SetCurSel(0);    $$refConfig{'CHARSET'} = 'cp1252';        } # Default is cp1252
  if (exists($$refConfig{'EXPAND_SEE_MORE'}))       { $winConfig->chOptSeemore->Checked($$refConfig{'EXPAND_SEE_MORE'});                }
  else                                              { $winConfig->chOptSeemore->Checked(1);   $$refConfig{'EXPAND_SEE_MORE'}      = 1;  } # Default is checked
  if (exists($$refConfig{'EXPAND_MORE_POSTS'}))     { $winConfig->chOptPosts->Checked($$refConfig{'EXPAND_MORE_POSTS'});                }
  else                                              { $winConfig->chOptPosts->Checked(1);     $$refConfig{'EXPAND_MORE_POSTS'}    = 1;  } # Default is checked
  if (exists($$refConfig{'EXPAND_MORE_COMMENTS'}))  { $winConfig->chOptComments->Checked($$refConfig{'EXPAND_MORE_COMMENTS'});          }
  else                                              { $winConfig->chOptComments->Checked(1);  $$refConfig{'EXPAND_MORE_COMMENTS'} = 1;  } # Default is checked
  if (exists($$refConfig{'SEE_TRANSLATION'}))       { $winConfig->chOptTranslate->Checked($$refConfig{'SEE_TRANSLATION'});              }
  else                                              { $winConfig->chOptTranslate->Checked(0); $$refConfig{'SEE_TRANSLATION'}      = 0;  } # Default is not checked
  if (exists($$refConfig{'MAX_LOADING_MSG'}))       { $winConfig->upMaxScrollChat->SetPos($$refConfig{'MAX_LOADING_MSG'});              }
  else                                              { $winConfig->upMaxScrollChat->SetPos(0); $$refConfig{'MAX_LOADING_MSG'} = 0;       } # Default value is 0 (No maximum)
  if (exists($$refConfig{'MAX_SCROLL'}))            { $winConfig->upMaxScroll->SetPos($$refConfig{'MAX_SCROLL'});                       }
  else                                              { $winConfig->upMaxScroll->SetPos(0); $$refConfig{'MAX_SCROLL'} = 0;                } # Default value is 0 (No maximum)

  # Directories
  if (exists($$refConfig{'DIR_SAVE_ALBUMS'})  and -d $$refConfig{'DIR_SAVE_ALBUMS'})  { $winAlbums->tfDirSaveAlbums->Text($$refConfig{'DIR_SAVE_ALBUMS'});        }
  if (exists($$refConfig{'DIR_SAVE_FRIENDS'}) and -d $$refConfig{'DIR_SAVE_FRIENDS'}) { $winFriends->tfDirSaveFriends->Text($$refConfig{'DIR_SAVE_FRIENDS'});     }
  if (exists($$refConfig{'DIR_SAVE_EVENT'})   and -d $$refConfig{'DIR_SAVE_EVENT'})   { $winEvent->tfDirSaveEvent->Text($$refConfig{'DIR_SAVE_EVENT'});           }
  if (exists($$refConfig{'DIR_SAVE_CONTRIB'}) and -d $$refConfig{'DIR_SAVE_CONTRIB'}) { $winContrib->tfDirSaveContrib->Text($$refConfig{'DIR_SAVE_CONTRIB'});     }
  if (exists($$refConfig{'DIR_SAVE_GROUP_MEMBERS'}) and -d $$refConfig{'DIR_SAVE_GROUP_MEMBERS'}) { $winGroupMembers->tfDirSaveGroupMembers->Text($$refConfig{'DIR_SAVE_GROUP_MEMBERS'});     }
  if (exists($$refConfig{'DIR_SAVE_CHAT'})    and -d $$refConfig{'DIR_SAVE_CHAT'})    { $winChat->tfDirSaveChat->Text($$refConfig{'DIR_SAVE_CHAT'});              }
  if (exists($$refConfig{'DIR_SAVE_VM'})      and -d $$refConfig{'DIR_SAVE_VM'}) 			{ $winVocalMsg->tfDirSaveVocalMsg->Text($$refConfig{'DIR_SAVE_VM'});     		}

  # Window options
  # Dump Albums
  if (exists($$refConfig{'REMEMBER_SAVE_ALBUMS'}))  { $winAlbums->chSaveAlbumDir->Checked($$refConfig{'REMEMBER_SAVE_ALBUMS'});               }
  else                                              { $winAlbums->chSaveAlbumDir->Checked(1);     $$refConfig{'REMEMBER_SAVE_ALBUMS'}   = 1;  } # Default is checked
  if (exists($$refConfig{'ALBUMS_PUBLISH_DATE'}))   { $winAlbums->chPublishDate->Checked($$refConfig{'ALBUMS_PUBLISH_DATE'});                 }
  else                                              { $winAlbums->chPublishDate->Checked(0);      $$refConfig{'ALBUMS_PUBLISH_DATE'}    = 0;  } # Default is not checked
  if (exists($$refConfig{'ALBUMS_OPEN_HTML'}))      { $winAlbums->chAlbumsOpenHTML->Checked($$refConfig{'ALBUMS_OPEN_HTML'});                 }
  else                                              { $winAlbums->chAlbumsOpenHTML->Checked(1);   $$refConfig{'ALBUMS_OPEN_HTML'}       = 1;  } # Default is checked
  if (exists($$refConfig{'ALBUMS_OPEN_DIR'}))       { $winAlbums->chAlbumsOpenDir->Checked($$refConfig{'ALBUMS_OPEN_DIR'});                   }
  else                                              { $winAlbums->chAlbumsOpenDir->Checked(0);    $$refConfig{'ALBUMS_OPEN_DIR'}        = 0;  } # Default is not checked
  # Dump friends
  if (exists($$refConfig{'REMEMBER_SAVE_FRIENDS'})) { $winFriends->chSaveFriendsDir->Checked($$refConfig{'REMEMBER_SAVE_FRIENDS'});              }
  else                                              { $winFriends->chSaveFriendsDir->Checked(1);  $$refConfig{'REMEMBER_SAVE_FRIENDS'}     = 1;  } # Default is checked
  if (exists($$refConfig{'FRIENDS_INCLUDE_ICONS'})) { $winFriends->chFriendsProfileIcons->Checked($$refConfig{'FRIENDS_INCLUDE_ICONS'});         }
  else                                              { $winFriends->chFriendsProfileIcons->Checked(1); $$refConfig{'FRIENDS_INCLUDE_ICONS'} = 1;  } # Default is checked
  if (exists($$refConfig{'FRIENDS_OPEN_OUTPUT'}))   { $winFriends->chFriendsOpenOutput->Checked($$refConfig{'FRIENDS_OPEN_OUTPUT'});             }
  else                                              { $winFriends->chFriendsOpenOutput->Checked(1); $$refConfig{'FRIENDS_OPEN_OUTPUT'}     = 1;  } # Default is checked
  # Dump Events
  if (exists($$refConfig{'REMEMBER_SAVE_EVENT'}))   { $winEvent->chSaveEventDir->Checked($$refConfig{'REMEMBER_SAVE_EVENT'});                    }
  else                                              { $winEvent->chSaveEventDir->Checked(1);          $$refConfig{'REMEMBER_SAVE_EVENT'}   = 1;  } # Default is checked
  if (exists($$refConfig{'EVENT_PROFILE_ICONS'}))   { $winEvent->chEventProfileIcons->Checked($$refConfig{'EVENT_PROFILE_ICONS'});               }
  else                                              { $winEvent->chEventProfileIcons->Checked(1);     $$refConfig{'EVENT_PROFILE_ICONS'}   = 1;  } # Default is checked
  if (exists($$refConfig{'EVENT_OPEN_XLSX'}))       { $winEvent->chEventOpenXLSX->Checked($$refConfig{'EVENT_OPEN_XLSX'});                       }
  else                                              { $winEvent->chEventOpenXLSX->Checked(1);         $$refConfig{'EVENT_OPEN_XLSX'}       = 1;  } # Default is checked
  # Dump contrib
  if (exists($$refConfig{'REMEMBER_SAVE_CONTRIB'})) { $winContrib->chSaveContribDir->Checked($$refConfig{'REMEMBER_SAVE_CONTRIB'});              }
  else                                              { $winContrib->chSaveContribDir->Checked(1);      $$refConfig{'REMEMBER_SAVE_CONTRIB'} = 1;  } # Default is checked
  if (exists($$refConfig{'CONTRIB_PROFILE_ICONS'})) { $winContrib->chContribProfileIcons->Checked($$refConfig{'CONTRIB_PROFILE_ICONS'});         }
  else                                              { $winContrib->chContribProfileIcons->Checked(1); $$refConfig{'CONTRIB_PROFILE_ICONS'} = 1;  } # Default is checked
  if (exists($$refConfig{'CONTRIB_OPEN_XLSX'}))     { $winContrib->chContribOpenXLSX->Checked($$refConfig{'CONTRIB_OPEN_XLSX'});                 }
  else                                              { $winContrib->chContribOpenXLSX->Checked(1);     $$refConfig{'CONTRIB_OPEN_XLSX'}     = 1;  } # Default is checked
  # Dump Group Members
  if (exists($$refConfig{'REMEMBER_SAVE_GROUP_MEMBERS'})) { $winGroupMembers->chSaveGroupMembersDir->Checked($$refConfig{'REMEMBER_SAVE_GROUP_MEMBERS'});              }
  else                                              			{ $winGroupMembers->chSaveGroupMembersDir->Checked(1);  $$refConfig{'REMEMBER_SAVE_GROUP_MEMBERS'}     = 1;  } # Default is checked
  if (exists($$refConfig{'GROUP_MEMBERS_INCLUDE_ICONS'})) { $winGroupMembers->chGroupMembersProfileIcons->Checked($$refConfig{'GROUP_MEMBERS_INCLUDE_ICONS'});         }
  else                                              			{ $winGroupMembers->chGroupMembersProfileIcons->Checked(1); $$refConfig{'GROUP_MEMBERS_INCLUDE_ICONS'} = 1;  } # Default is checked
  if (exists($$refConfig{'GROUP_MEMBERS_OPEN_OUTPUT'}))   { $winGroupMembers->chGroupMembersOpenOutput->Checked($$refConfig{'GROUP_MEMBERS_OPEN_OUTPUT'});             }
  else                                              			{ $winGroupMembers->chGroupMembersOpenOutput->Checked(1); $$refConfig{'GROUP_MEMBERS_OPEN_OUTPUT'}     = 1;  } # Default is checked
  # Dump chat
  if (exists($$refConfig{'REMEMBER_SAVE_CHAT'}))    { $winChat->chSaveChatDir->Checked($$refConfig{'REMEMBER_SAVE_CHAT'});                    }
  else                                              { $winChat->chSaveChatDir->Checked(1);        $$refConfig{'REMEMBER_SAVE_CHAT'}     = 1;  } # Default is checked
  # Dump Group Members
  if (exists($$refConfig{'REMEMBER_SAVE_VM'})) 			{ $winVocalMsg->chSaveVocalMsgDir->Checked($$refConfig{'REMEMBER_SAVE_VM'});              }
  else                                              { $winVocalMsg->chSaveVocalMsgDir->Checked(1);  $$refConfig{'REMEMBER_SAVE_VM'}     = 1;  } # Default is checked
  if (exists($$refConfig{'VM_OPEN_OUTPUT'}))   			{ $winVocalMsg->chVocalMsgOpenOutput->Checked($$refConfig{'VM_OPEN_OUTPUT'});             }
  else                                              { $winVocalMsg->chVocalMsgOpenOutput->Checked(1); $$refConfig{'VM_OPEN_OUTPUT'}     = 1;  } # Default is checked
  
  &saveConfig($refConfig);

}  #--- End loadConfig

#--------------------------#
sub scrollPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  # Scrolling down and wait for content to load
  $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
  sleep($time);
  
  # Evaluate end of the page
  my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
  if ($end == 1) {
    sleep($time); # Wait another X seconds and evaluate again
    ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
    if ($end == 1) { return(1); } # End of the page
  }

}  #--- End scrollPage

#--------------------------#
sub scrollLikePage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # Click on "See more" button and wait for content to load
    sleep($time);
    my $seeMore = $$refMech->selector('a.pam.uiBoxLightblue.uiMorePagerPrimary', any => 1);
    if ($seeMore) {
      $seeMore->click();
    } else { last; } # End
  }

}  #--- End scrollLikePage

#--------------------------#
sub scrollVPostsPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # Click on "See more" button and wait for content to load
    sleep($time);
    my $seeMore = $$refMech->selector('a.pam.uiBoxWhite.topborder.uiMorePagerPrimary', any => 1);
    if ($seeMore) {
      $seeMore->click();
    } else { last; } # End
  }

}  #--- End scrollVPostsPage

#--------------------------#
sub scrollAlbumPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # End of the page ?
    sleep($time);
    my @parts = $$refMech->selector('div._30f');
    if (scalar(@parts) > 1) { return(1); } # End of the page
    # Scrolling down and wait for content to load
    else {
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      sleep($time);
    }
  }

}  #--- End scrollAlbumPage

#--------------------------#
sub scrollFriendPage
#--------------------------#
{
  # Local variables
  my ($refMech, $time) = @_;
  
  while (1) {
    # End of the page ?
    my @parts = $$refMech->selector('div._3dc.lfloat._ohe._5brz');
    if (scalar(@parts) > 1) { return(1); } # End of the page
    # Scrolling down and wait for content to load
    else {
      my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
      if ($end == 1) { # End of the page, done ? Really ? With a bit more
        sleep($time);
        $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
        ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
        if ($end == 1) { return(1); }
      }
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      sleep($time);
    }
  }

}  #--- End scrollFriendPage

#--------------------------#
sub scrollToBottom
#--------------------------#
{
  # Local variables
  my ($refMech, $time, $count) = @_;
  
  my $maxScrollByDate = $winConfig->rbMaxScrollByDate->Checked();
  my $maxDate;
  my $maxScroll;
  if ($maxScrollByDate) {
    my ($d, $m, $y) = $winConfig->dtMaxScrollByDate->GetDate();
    $maxDate        = timelocal(0,0,0,$d,$m-1,$y); # Store in Unixtime format
  } else { $maxScroll = $winConfig->tfMaxScroll->Text(); }
  
  while (1) {
    # Scrolling down and wait for content to load
    $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
    $count++;
    sleep($time);
    
    # Scroll again
    if ($maxScrollByDate and $maxDate) { # Stop by date
      my $lastDisplayedDate = ($$refMech->selector('a._5pcq abbr'))[-1];
      if ($lastDisplayedDate->{outerHTML} =~ /data-utime="([^\"]+)"/) {
        my $date = $1;
        if ($date <= $maxDate) { return(1); }
      }
    } elsif ($maxScroll and $count >= $maxScroll) { return(1); } # Stop by page
    
    # Evaluate end of the page
    my ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
    if ($end == 1) { # End of the page, done ? Really ? With a bit more
      sleep($time);
      $$refMech->eval_in_page('window.scrollTo(0,document.body.scrollHeight)');
      ($end, $type) = $$refMech->eval_in_page('(window.innerHeight + window.scrollY) >= document.body.offsetHeight');
      if ($end == 1) { return(1); }
    }
  }

}  #--- End scrollToBottom

#--------------------------#
sub selectCatFriendPage
#--------------------------#
{
  # Local variables
  my ($refMech, $cat) = @_;
  
  my @links = $$refMech->selector('div._3dc.lfloat._ohe._5brz a');
  foreach my $link (@links) {
    if ($link->{name} eq $cat) {
      $link->click();
      return(1);
    }
  }

}  #--- End selectCatFriendPage

#--------------------------#
sub expandContent
#--------------------------#
{
  # Local variables
  my ($refMech) = @_;
  
  # Continue Reading
  $$refMech->eval_in_page("var el = document.getElementsByClassName('text_exposed_link'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  
  # See more
  if ($winConfig->chOptSeemore->Checked()) {
    $$refMech->eval_in_page("var el = document.getElementsByClassName('see_more_link'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('_5v47 fss'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIReplySocialSentenceLinkText UFIReplySocialSentenceVerified'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  }
  
  # More post (wait to find the good classname)

  # View \d+ more comments? / View previous comments / Reply / etc
  if ($winConfig->chOptComments->Checked()) {
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIPagerLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFICommentLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFIBlingBox uiBlingBox feedbackBling'); for (var i=0;i<el.length; i++) { el[i].click(); }");
  }
  
  # See translation
  if ($winConfig->chOptTranslate->Checked()) {
    # Translate comment
    $$refMech->eval_in_page("var el = document.getElementsByClassName('UFITranslateLink'); for (var i=0;i<el.length; i++) { el[i].click(); }");
    # Translate post
    my @links = $$refMech->selector('div._43f9 a');
    foreach (@links) { $_->click; }
  }
  

}  #--- End expandContent

#--------------------------#
sub cssSpriteBD
#--------------------------#
{
  # Local variables
  my ($sprite) = @_;
  my %bdSprites = (
    '_4_o0' => 'span._4_o0 { background-position:0 0 }', 
    '_4_o1' => 'span._4_o1 { background-position:0 -17px }', 
    '_4_o2' => 'span._4_o2 { background-position:0 -34px }', 
    '_4_o3' => 'span._4_o3 { background-position:0 -51px }', 
    '_4_o4' => 'span._4_o4 { background-position:0 -68px }', 
    '_4_o5' => 'span._4_o5 { background-position:0 -85px }', 
    '_4_o6' => 'span._4_o6 { background-position:0 -102px }', 
    '_4_o7' => 'span._4_o7 { background-position:0 -119px }', 
    '_4_o8' => 'span._4_o8 { background-position:0 -136px }', 
    '_4_o9' => 'span._4_o9 { background-position:0 -153px }', 
    '_4_oa' => 'span._4_oa { background-position:0 -170px }', 
    '_4_ob' => 'span._4_ob { background-position:0 -187px }', 
    '_4_oc' => 'span._4_oc { background-position:0 -204px }', 
    '_4_od' => 'span._4_od { background-position:0 -221px }', 
    '_4_oe' => 'span._4_oe { background-position:0 -238px }', 
    '_4_of' => 'span._4_of { background-position:0 -255px }', 
    '_2b_' => 'span._2b_ { background-position:0 -272px }', 
    '_2c0' => 'span._2c0 { background-position:0 -289px }', 
    '_4_og' => 'span._4_og { background-position:0 -306px }', 
    '_4_oh' => 'span._4_oh { background-position:0 -323px }', 
    '_4_oi' => 'span._4_oi { background-position:0 -340px }', 
    '_4_oj' => 'span._4_oj { background-position:0 -357px }', 
    '_4_ok' => 'span._4_ok { background-position:0 -374px }', 
    '_4_ol' => 'span._4_ol { background-position:0 -391px }', 
    '_2c1' => 'span._2c1 { background-position:0 -408px }', 
    '_2c2' => 'span._2c2 { background-position:0 -425px }', 
    '_2c3' => 'span._2c3 { background-position:0 -442px }', 
    '_2c4' => 'span._2c4 { background-position:0 -459px }', 
    '_2c5' => 'span._2c5 { background-position:0 -476px }', 
    '_2c6' => 'span._2c6 { background-position:0 -493px }', 
    '_2c7' => 'span._2c7 { background-position:0 -510px }', 
    '_2c8' => 'span._2c8 { background-position:0 -527px }', 
    '_2c9' => 'span._2c9 { background-position:0 -544px }', 
    '_2ca' => 'span._2ca { background-position:0 -561px }', 
    '_2cb' => 'span._2cb { background-position:0 -578px }', 
    '_2cc' => 'span._2cc { background-position:0 -595px }', 
    '_2cd' => 'span._2cd { background-position:0 -612px }', 
    '_2ce' => 'span._2ce { background-position:0 -629px }', 
    '_2cf' => 'span._2cf { background-position:0 -646px }', 
    '_2cg' => 'span._2cg { background-position:0 -663px }', 
    '_4_om' => 'span._4_om { background-position:0 -680px }', 
    '_4_on' => 'span._4_on { background-position:0 -697px }', 
    '_4_oo' => 'span._4_oo { background-position:0 -714px }', 
    '_2ch' => 'span._2ch { background-position:0 -731px }', 
    '_2ci' => 'span._2ci { background-position:0 -748px }', 
    '_2cj' => 'span._2cj { background-position:0 -765px }', 
    '_2ck' => 'span._2ck { background-position:0 -782px }', 
    '_4_op' => 'span._4_op { background-position:0 -799px }', 
    '_4_oq' => 'span._4_oq { background-position:0 -816px }', 
    '_4_or' => 'span._4_or { background-position:0 -833px }', 
    '_4_os' => 'span._4_os { background-position:0 -850px }', 
    '_4_ot' => 'span._4_ot { background-position:0 -867px }', 
    '_4_ou' => 'span._4_ou { background-position:0 -884px }', 
    '_4_ov' => 'span._4_ov { background-position:0 -901px }', 
    '_4_ow' => 'span._4_ow { background-position:0 -918px }', 
    '_4_ox' => 'span._4_ox { background-position:0 -935px }', 
    '_4_oy' => 'span._4_oy { background-position:0 -952px }', 
    '_4_oz' => 'span._4_oz { background-position:0 -969px }', 
    '_4_o-' => 'span._4_o- { background-position:0 -986px }', 
    '_4_o_' => 'span._4_o_ { background-position:0 -1003px }', 
    '_4_p0' => 'span._4_p0 { background-position:0 -1020px }', 
    '_4_p1' => 'span._4_p1 { background-position:0 -1037px }', 
    '_4_p2' => 'span._4_p2 { background-position:0 -1054px }', 
    '_4_p3' => 'span._4_p3 { background-position:0 -1071px }', 
    '_4_p4' => 'span._4_p4 { background-position:0 -1088px }', 
    '_4_p5' => 'span._4_p5 { background-position:0 -1105px }', 
    '_4_p6' => 'span._4_p6 { background-position:0 -1122px }', 
    '_2cl' => 'span._2cl { background-position:0 -1139px }', 
    '_2cm' => 'span._2cm { background-position:0 -1156px }', 
    '_4_p7' => 'span._4_p7 { background-position:0 -1173px }', 
    '_4_p8' => 'span._4_p8 { background-position:0 -1190px }', 
    '_2cn' => 'span._2cn { background-position:0 -1207px }', 
    '_2co' => 'span._2co { background-position:0 -1224px }', 
    '_2cp' => 'span._2cp { background-position:0 -1241px }', 
    '_2cq' => 'span._2cq { background-position:0 -1258px }', 
    '_2cr' => 'span._2cr { background-position:0 -1275px }', 
    '_2cs' => 'span._2cs { background-position:0 -1292px }', 
    '_4_p9' => 'span._4_p9 { background-position:0 -1309px }', 
    '_2ct' => 'span._2ct { background-position:0 -1326px }', 
    '_2cu' => 'span._2cu { background-position:0 -1343px }', 
    '_2cv' => 'span._2cv { background-position:0 -1360px }', 
    '_2cw' => 'span._2cw { background-position:0 -1377px }', 
    '_4_pa' => 'span._4_pa { background-position:0 -1394px }', 
    '_2cx' => 'span._2cx { background-position:0 -1411px }', 
    '_4_pb' => 'span._4_pb { background-position:0 -1428px }', 
    '_4_pc' => 'span._4_pc { background-position:0 -1445px }', 
    '_4_pd' => 'span._4_pd { background-position:0 -1462px }', 
    '_4_pe' => 'span._4_pe { background-position:0 -1479px }', 
    '_4_pf' => 'span._4_pf { background-position:0 -1496px }', 
    '_4_pg' => 'span._4_pg { background-position:0 -1513px }', 
    '_4_ph' => 'span._4_ph { background-position:0 -1530px }', 
    '_4_pi' => 'span._4_pi { background-position:0 -1547px }', 
    '_4_pj' => 'span._4_pj { background-position:0 -1564px }', 
    '_4_pk' => 'span._4_pk { background-position:0 -1581px }', 
    '_4_pl' => 'span._4_pl { background-position:0 -1598px }', 
    '_4_pm' => 'span._4_pm { background-position:0 -1615px }', 
    '_4_pn' => 'span._4_pn { background-position:0 -1632px }', 
    '_2cy' => 'span._2cy { background-position:0 -1649px }', 
    '_2cz' => 'span._2cz { background-position:0 -1666px }', 
    '_4_po' => 'span._4_po { background-position:0 -1683px }', 
    '_4_pp' => 'span._4_pp { background-position:0 -1700px }', 
    '_4_pq' => 'span._4_pq { background-position:0 -1717px }', 
    '_2c-' => 'span._2c- { background-position:0 -1734px }', 
    '_4_pr' => 'span._4_pr { background-position:0 -1751px }', 
    '_4_ps' => 'span._4_ps { background-position:0 -1768px }', 
    '_4_pt' => 'span._4_pt { background-position:0 -1785px }', 
    '_4_pu' => 'span._4_pu { background-position:0 -1802px }', 
    '_4_pv' => 'span._4_pv { background-position:0 -1819px }', 
    '_4_pw' => 'span._4_pw { background-position:0 -1836px }', 
    '_4_px' => 'span._4_px { background-position:0 -1853px }', 
    '_4_py' => 'span._4_py { background-position:0 -1870px }', 
    '_4_pz' => 'span._4_pz { background-position:0 -1887px }', 
    '_4_p-' => 'span._4_p- { background-position:0 -1904px }', 
    '_4_p_' => 'span._4_p_ { background-position:0 -1921px }', 
    '_4_q0' => 'span._4_q0 { background-position:0 -1938px }', 
    '_4_q1' => 'span._4_q1 { background-position:0 -1955px }', 
    '_4_q2' => 'span._4_q2 { background-position:0 -1972px }', 
    '_4_q3' => 'span._4_q3 { background-position:0 -1989px }', 
    '_4_q4' => 'span._4_q4 { background-position:0 -2006px }', 
    '_4_q5' => 'span._4_q5 { background-position:0 -2023px }', 
    '_4_q6' => 'span._4_q6 { background-position:0 -2040px }', 
    '_4_q7' => 'span._4_q7 { background-position:0 -2057px }', 
    '_4_q8' => 'span._4_q8 { background-position:0 -2074px }', 
    '_4_q9' => 'span._4_q9 { background-position:0 -2091px }', 
    '_2c_' => 'span._2c_ { background-position:0 -2108px }', 
    '_2d0' => 'span._2d0 { background-position:0 -2125px }', 
    '_2d1' => 'span._2d1 { background-position:0 -2142px }', 
    '_2d2' => 'span._2d2 { background-position:0 -2159px }', 
    '_2d3' => 'span._2d3 { background-position:0 -2176px }', 
    '_2d4' => 'span._2d4 { background-position:0 -2193px }', 
    '_2d5' => 'span._2d5 { background-position:0 -2210px }', 
    '_2d6' => 'span._2d6 { background-position:0 -2227px }', 
    '_2d7' => 'span._2d7 { background-position:0 -2244px }', 
    '_2d8' => 'span._2d8 { background-position:0 -2261px }', 
    '_2d9' => 'span._2d9 { background-position:0 -2278px }', 
    '_2da' => 'span._2da { background-position:0 -2295px }', 
    '_2db' => 'span._2db { background-position:0 -2312px }', 
    '_2dc' => 'span._2dc { background-position:0 -2329px }', 
    '_2dd' => 'span._2dd { background-position:0 -2346px }', 
    '_2de' => 'span._2de { background-position:0 -2363px }', 
    '_2df' => 'span._2df { background-position:0 -2380px }', 
    '_2dg' => 'span._2dg { background-position:0 -2397px }', 
    '_2dh' => 'span._2dh { background-position:0 -2414px }', 
    '_2di' => 'span._2di { background-position:0 -2431px }', 
    '_2dj' => 'span._2dj { background-position:0 -2448px }', 
    '_2dk' => 'span._2dk { background-position:0 -2465px }', 
    '_2dl' => 'span._2dl { background-position:0 -2482px }', 
    '_2dm' => 'span._2dm { background-position:0 -2499px }', 
    '_2dn' => 'span._2dn { background-position:0 -2516px }', 
    '_2do' => 'span._2do { background-position:0 -2533px }', 
    '_2dp' => 'span._2dp { background-position:0 -2550px }', 
    '_2dq' => 'span._2dq { background-position:0 -2567px }', 
    '_491' => 'span._491 { background-position:0 -2584px }', 
    '_2dr' => 'span._2dr { background-position:0 -2601px }', 
    '_2ds' => 'span._2ds { background-position:0 -2618px }', 
    '_2dt' => 'span._2dt { background-position:0 -2635px }', 
    '_2du' => 'span._2du { background-position:0 -2652px }', 
    '_2dv' => 'span._2dv { background-position:0 -2669px }', 
    '_2dw' => 'span._2dw { background-position:0 -2686px }', 
    '_2dx' => 'span._2dx { background-position:0 -2703px }', 
    '_2dy' => 'span._2dy { background-position:0 -2720px }', 
    '_2dz' => 'span._2dz { background-position:0 -2737px }', 
    '_2d-' => 'span._2d- { background-position:0 -2754px }', 
    '_2d_' => 'span._2d_ { background-position:0 -2771px }', 
    '_2e0' => 'span._2e0 { background-position:0 -2788px }', 
    '_2e1' => 'span._2e1 { background-position:0 -2805px }', 
    '_2e2' => 'span._2e2 { background-position:0 -2822px }', 
    '_2e3' => 'span._2e3 { background-position:0 -2839px }', 
    '_2e4' => 'span._2e4 { background-position:0 -2856px }', 
    '_2e5' => 'span._2e5 { background-position:0 -2873px }', 
    '_2e6' => 'span._2e6 { background-position:0 -2890px }', 
    '_2e7' => 'span._2e7 { background-position:0 -2907px }', 
    '_2e8' => 'span._2e8 { background-position:0 -2924px }', 
    '_2e9' => 'span._2e9 { background-position:0 -2941px }', 
    '_2ea' => 'span._2ea { background-position:0 -2958px }', 
    '_4_qa' => 'span._4_qa { background-position:0 -2975px }', 
    '_4_qb' => 'span._4_qb { background-position:0 -2992px }', 
    '_4_qc' => 'span._4_qc { background-position:0 -3009px }', 
    '_4_qd' => 'span._4_qd { background-position:0 -3026px }', 
    '_4_qe' => 'span._4_qe { background-position:0 -3043px }', 
    '_4_qf' => 'span._4_qf { background-position:0 -3060px }', 
    '_4_qg' => 'span._4_qg { background-position:0 -3077px }', 
    '_4_qh' => 'span._4_qh { background-position:0 -3094px }', 
    '_4_qi' => 'span._4_qi { background-position:0 -3111px }', 
    '_4_qj' => 'span._4_qj { background-position:0 -3128px }', 
    '_4_qk' => 'span._4_qk { background-position:0 -3145px }', 
    '_4_ql' => 'span._4_ql { background-position:0 -3162px }', 
    '_2eb' => 'span._2eb { background-position:0 -3179px }', 
    '_2ec' => 'span._2ec { background-position:0 -3196px }', 
    '_2ed' => 'span._2ed { background-position:0 -3213px }', 
    '_2ee' => 'span._2ee { background-position:0 -3230px }', 
    '_2ef' => 'span._2ef { background-position:0 -3247px }', 
    '_2eg' => 'span._2eg { background-position:0 -3264px }', 
    '_2eh' => 'span._2eh { background-position:0 -3281px }', 
    '_2ei' => 'span._2ei { background-position:0 -3298px }', 
    '_2ej' => 'span._2ej { background-position:0 -3315px }', 
    '_2ek' => 'span._2ek { background-position:0 -3332px }', 
    '_2el' => 'span._2el { background-position:0 -3349px }', 
    '_2em' => 'span._2em { background-position:0 -3366px }', 
    '_2en' => 'span._2en { background-position:0 -3383px }', 
    '_2eo' => 'span._2eo { background-position:0 -3400px }', 
    '_2ep' => 'span._2ep { background-position:0 -3417px }', 
    '_2eq' => 'span._2eq { background-position:0 -3434px }', 
    '_2er' => 'span._2er { background-position:0 -3451px }', 
    '_2es' => 'span._2es { background-position:0 -3468px }', 
    '_2et' => 'span._2et { background-position:0 -3485px }', 
    '_2eu' => 'span._2eu { background-position:0 -3502px }', 
    '_2ev' => 'span._2ev { background-position:0 -3519px }', 
    '_2ew' => 'span._2ew { background-position:0 -3536px }', 
    '_2ex' => 'span._2ex { background-position:0 -3553px }', 
    '_4_qm' => 'span._4_qm { background-position:0 -3570px }', 
    '_2ey' => 'span._2ey { background-position:0 -3587px }', 
    '_4_qn' => 'span._4_qn { background-position:0 -3604px }', 
    '_4_qo' => 'span._4_qo { background-position:0 -3621px }', 
    '_4_qp' => 'span._4_qp { background-position:0 -3638px }', 
    '_2ez' => 'span._2ez { background-position:0 -3655px }', 
    '_4_qq' => 'span._4_qq { background-position:0 -3672px }', 
    '_4_qr' => 'span._4_qr { background-position:0 -3689px }', 
    '_4_qs' => 'span._4_qs { background-position:0 -3706px }', 
    '_2e-' => 'span._2e- { background-position:0 -3723px }', 
    '_2e_' => 'span._2e_ { background-position:0 -3740px }', 
    '_2f0' => 'span._2f0 { background-position:0 -3757px }', 
    '_4_qt' => 'span._4_qt { background-position:0 -3774px }', 
    '_2f1' => 'span._2f1 { background-position:0 -3791px }', 
    '_2f2' => 'span._2f2 { background-position:0 -3808px }', 
    '_2f3' => 'span._2f3 { background-position:0 -3825px }', 
    '_2f4' => 'span._2f4 { background-position:0 -3842px }', 
    '_2f5' => 'span._2f5 { background-position:0 -3859px }', 
    '_2f6' => 'span._2f6 { background-position:0 -3876px }', 
    '_2f7' => 'span._2f7 { background-position:0 -3893px }', 
    '_2f8' => 'span._2f8 { background-position:0 -3910px }', 
    '_2f9' => 'span._2f9 { background-position:0 -3927px }', 
    '_2fa' => 'span._2fa { background-position:0 -3944px }', 
    '_4_qu' => 'span._4_qu { background-position:0 -3961px }', 
    '_4_qv' => 'span._4_qv { background-position:0 -3978px }', 
    '_4_qw' => 'span._4_qw { background-position:0 -3995px }', 
    '_4_qx' => 'span._4_qx { background-position:0 -4012px }', 
    '_2fb' => 'span._2fb { background-position:0 -4029px }', 
    '_4_qy' => 'span._4_qy { background-position:0 -4046px }', 
    '_2fc' => 'span._2fc { background-position:0 -4063px }', 
    '_2fd' => 'span._2fd { background-position:0 -4080px }', 
    '_4_qz' => 'span._4_qz { background-position:0 -4097px }', 
    '_2fe' => 'span._2fe { background-position:0 -4114px }', 
    '_2ff' => 'span._2ff { background-position:0 -4131px }', 
    '_2fg' => 'span._2fg { background-position:0 -4148px }', 
    '_4_q-' => 'span._4_q- { background-position:0 -4165px }', 
    '_4_q_' => 'span._4_q_ { background-position:0 -4182px }', 
    '_4_r0' => 'span._4_r0 { background-position:0 -4199px }', 
    '_4_r1' => 'span._4_r1 { background-position:0 -4216px }', 
    '_4_r2' => 'span._4_r2 { background-position:0 -4233px }', 
    '_2fh' => 'span._2fh { background-position:0 -4250px }', 
    '_4_r3' => 'span._4_r3 { background-position:0 -4267px }', 
    '_2fi' => 'span._2fi { background-position:0 -4284px }', 
    '_2fj' => 'span._2fj { background-position:0 -4301px }', 
    '_2fk' => 'span._2fk { background-position:0 -4318px }', 
    '_2fl' => 'span._2fl { background-position:0 -4335px }', 
    '_4_r4' => 'span._4_r4 { background-position:0 -4352px }', 
    '_4_r5' => 'span._4_r5 { background-position:0 -4369px }', 
    '_2fm' => 'span._2fm { background-position:0 -4386px }', 
    '_2fn' => 'span._2fn { background-position:0 -4403px }', 
    '_4_r6' => 'span._4_r6 { background-position:0 -4420px }', 
    '_4_r7' => 'span._4_r7 { background-position:0 -4437px }', 
    '_4_r8' => 'span._4_r8 { background-position:0 -4454px }', 
    '_4_r9' => 'span._4_r9 { background-position:0 -4471px }', 
    '_4_ra' => 'span._4_ra { background-position:0 -4488px }', 
    '_4_rb' => 'span._4_rb { background-position:0 -4505px }', 
    '_4_rc' => 'span._4_rc { background-position:0 -4522px }', 
    '_4_rd' => 'span._4_rd { background-position:0 -4539px }', 
    '_4_re' => 'span._4_re { background-position:0 -4556px }', 
    '_4_rf' => 'span._4_rf { background-position:0 -4573px }', 
    '_2fo' => 'span._2fo { background-position:0 -4590px }', 
    '_2fp' => 'span._2fp { background-position:0 -4607px }', 
    '_4_rg' => 'span._4_rg { background-position:0 -4624px }', 
    '_4_rh' => 'span._4_rh { background-position:0 -4641px }', 
    '_4_ri' => 'span._4_ri { background-position:0 -4658px }', 
    '_4_rj' => 'span._4_rj { background-position:0 -4675px }', 
    '_2fq' => 'span._2fq { background-position:0 -4692px }', 
    '_4_rk' => 'span._4_rk { background-position:0 -4709px }', 
    '_4_rl' => 'span._4_rl { background-position:0 -4726px }', 
    '_4_rm' => 'span._4_rm { background-position:0 -4743px }', 
    '_4_rn' => 'span._4_rn { background-position:0 -4760px }', 
    '_4_ro' => 'span._4_ro { background-position:0 -4777px }', 
    '_4_rp' => 'span._4_rp { background-position:0 -4794px }', 
    '_4_rq' => 'span._4_rq { background-position:0 -4811px }', 
    '_4_rr' => 'span._4_rr { background-position:0 -4828px }', 
    '_4_rs' => 'span._4_rs { background-position:0 -4845px }', 
    '_4_rt' => 'span._4_rt { background-position:0 -4862px }', 
    '_2fr' => 'span._2fr { background-position:0 -4879px }', 
    '_4_ru' => 'span._4_ru { background-position:0 -4896px }', 
    '_492' => 'span._492 { background-position:0 -4913px }', 
    '_4_rv' => 'span._4_rv { background-position:0 -4930px }', 
    '_4_rw' => 'span._4_rw { background-position:0 -4947px }', 
    '_4_rx' => 'span._4_rx { background-position:0 -4964px }', 
    '_4_ry' => 'span._4_ry { background-position:0 -4981px }', 
    '_4_rz' => 'span._4_rz { background-position:0 -4998px }', 
    '_4_r-' => 'span._4_r- { background-position:0 -5015px }', 
    '_4_r_' => 'span._4_r_ { background-position:0 -5032px }', 
    '_4_s0' => 'span._4_s0 { background-position:0 -5049px }', 
    '_4_s1' => 'span._4_s1 { background-position:0 -5066px }', 
    '_4_s2' => 'span._4_s2 { background-position:0 -5083px }', 
    '_4_s3' => 'span._4_s3 { background-position:0 -5100px }', 
    '_4_s4' => 'span._4_s4 { background-position:0 -5117px }', 
    '_4_s5' => 'span._4_s5 { background-position:0 -5134px }', 
    '_4_s6' => 'span._4_s6 { background-position:0 -5151px }', 
    '_4_s7' => 'span._4_s7 { background-position:0 -5168px }', 
    '_2fs' => 'span._2fs { background-position:0 -5185px }', 
    '_2ft' => 'span._2ft { background-position:0 -5202px }', 
    '_2fu' => 'span._2fu { background-position:0 -5219px }', 
    '_2fv' => 'span._2fv { background-position:0 -5236px }', 
    '_2fw' => 'span._2fw { background-position:0 -5253px }', 
    '_2fx' => 'span._2fx { background-position:0 -5270px }', 
    '_1q3y' => 'span._1q3y { background-position:0 -5287px }', 
    '_2fz' => 'span._2fz { background-position:0 -5304px }', 
    '_2f-' => 'span._2f- { background-position:0 -5321px }', 
    '_2f_' => 'span._2f_ { background-position:0 -5338px }', 
    '_2g0' => 'span._2g0 { background-position:0 -5355px }', 
    '_2g1' => 'span._2g1 { background-position:0 -5372px }', 
    '_2g2' => 'span._2g2 { background-position:0 -5389px }', 
    '_2g3' => 'span._2g3 { background-position:0 -5406px }', 
    '_2g4' => 'span._2g4 { background-position:0 -5423px }', 
    '_2g5' => 'span._2g5 { background-position:0 -5440px }', 
    '_2g6' => 'span._2g6 { background-position:0 -5457px }', 
    '_2g7' => 'span._2g7 { background-position:0 -5474px }', 
    '_2g8' => 'span._2g8 { background-position:0 -5491px }', 
    '_2g9' => 'span._2g9 { background-position:0 -5508px }', 
    '_2ga' => 'span._2ga { background-position:0 -5525px }', 
    '_2gb' => 'span._2gb { background-position:0 -5542px }', 
    '_2gc' => 'span._2gc { background-position:0 -5559px }', 
    '_2gd' => 'span._2gd { background-position:0 -5576px }', 
    '_2ge' => 'span._2ge { background-position:0 -5593px }', 
    '_2gf' => 'span._2gf { background-position:0 -5610px }', 
    '_2gg' => 'span._2gg { background-position:0 -5627px }', 
    '_2gh' => 'span._2gh { background-position:0 -5644px }', 
    '_2gi' => 'span._2gi { background-position:0 -5661px }', 
    '_2gj' => 'span._2gj { background-position:0 -5678px }', 
    '_2gk' => 'span._2gk { background-position:0 -5695px }', 
    '_2gl' => 'span._2gl { background-position:0 -5712px }', 
    '_2gm' => 'span._2gm { background-position:0 -5729px }', 
    '_2gn' => 'span._2gn { background-position:0 -5746px }', 
    '_2go' => 'span._2go { background-position:0 -5763px }', 
    '_2gp' => 'span._2gp { background-position:0 -5780px }', 
    '_2gq' => 'span._2gq { background-position:0 -5797px }', 
    '_2gr' => 'span._2gr { background-position:0 -5814px }', 
    '_2gs' => 'span._2gs { background-position:0 -5831px }', 
    '_2gt' => 'span._2gt { background-position:0 -5848px }', 
    '_2gu' => 'span._2gu { background-position:0 -5865px }', 
    '_2gv' => 'span._2gv { background-position:0 -5882px }', 
    '_2gw' => 'span._2gw { background-position:0 -5899px }', 
    '_2gx' => 'span._2gx { background-position:0 -5916px }', 
    '_2gy' => 'span._2gy { background-position:0 -5933px }', 
    '_2gz' => 'span._2gz { background-position:0 -5950px }', 
    '_2g-' => 'span._2g- { background-position:0 -5967px }', 
    '_2g_' => 'span._2g_ { background-position:0 -5984px }', 
    '_4_s8' => 'span._4_s8 { background-position:0 -6001px }', 
    '_4_s9' => 'span._4_s9 { background-position:0 -6018px }', 
    '_4_sa' => 'span._4_sa { background-position:0 -6035px }', 
    '_4_sb' => 'span._4_sb { background-position:0 -6052px }', 
    '_4_sc' => 'span._4_sc { background-position:0 -6069px }', 
    '_4_sd' => 'span._4_sd { background-position:0 -6086px }', 
    '_4_se' => 'span._4_se { background-position:0 -6103px }', 
    '_4_sf' => 'span._4_sf { background-position:0 -6120px }', 
    '_4_sg' => 'span._4_sg { background-position:0 -6137px }', 
    '_4_sh' => 'span._4_sh { background-position:0 -6154px }', 
    '_4_si' => 'span._4_si { background-position:0 -6171px }', 
    '_4_sj' => 'span._4_sj { background-position:0 -6188px }', 
    '_4_sk' => 'span._4_sk { background-position:0 -6205px }', 
    '_4_sl' => 'span._4_sl { background-position:0 -6222px }', 
    '_4_sm' => 'span._4_sm { background-position:0 -6239px }', 
    '_4_sn' => 'span._4_sn { background-position:0 -6256px }', 
    '_4_so' => 'span._4_so { background-position:0 -6273px }', 
    '_4_sp' => 'span._4_sp { background-position:0 -6290px }', 
    '_4_sq' => 'span._4_sq { background-position:0 -6307px }', 
    '_4_sr' => 'span._4_sr { background-position:0 -6324px }', 
    '_4_ss' => 'span._4_ss { background-position:0 -6341px }', 
    '_4_st' => 'span._4_st { background-position:0 -6358px }', 
    '_4_su' => 'span._4_su { background-position:0 -6375px }', 
    '_4_sv' => 'span._4_sv { background-position:0 -6392px }', 
    '_4_sw' => 'span._4_sw { background-position:0 -6409px }', 
    '_4_sx' => 'span._4_sx { background-position:0 -6426px }', 
    '_4_sy' => 'span._4_sy { background-position:0 -6443px }', 
    '_4_sz' => 'span._4_sz { background-position:0 -6460px }', 
    '_4_s-' => 'span._4_s- { background-position:0 -6545px }', 
    '_4_s_' => 'span._4_s_ { background-position:0 -6562px }', 
    '_4_t0' => 'span._4_t0 { background-position:0 -6579px }', 
    '_4_t1' => 'span._4_t1 { background-position:0 -6596px }', 
    '_4_t2' => 'span._4_t2 { background-position:0 -6613px }', 
    '_4_t3' => 'span._4_t3 { background-position:0 -6630px }', 
    '_4_t4' => 'span._4_t4 { background-position:0 -6681px }', 
    '_2h0' => 'span._2h0 { background-position:0 -6732px }', 
    '_2h1' => 'span._2h1 { background-position:0 -6749px }', 
    '_4_t5' => 'span._4_t5 { background-position:0 -6851px }', 
    '_4_t6' => 'span._4_t6 { background-position:0 -6868px }', 
    '_2h2' => 'span._2h2 { background-position:0 -6885px }', 
    '_4_t7' => 'span._4_t7 { background-position:0 -6902px }', 
    '_4_t8' => 'span._4_t8 { background-position:0 -6919px }', 
    '_4_t9' => 'span._4_t9 { background-position:0 -6936px }', 
    '_4_ta' => 'span._4_ta { background-position:0 -6953px }', 
    '_2h3' => 'span._2h3 { background-position:0 -6970px }', 
    '_4_tb' => 'span._4_tb { background-position:0 -6987px }', 
    '_4_tc' => 'span._4_tc { background-position:0 -7004px }', 
    '_4_td' => 'span._4_td { background-position:0 -7021px }', 
    '_4_te' => 'span._4_te { background-position:0 -7038px }', 
    '_4_tf' => 'span._4_tf { background-position:0 -7055px }', 
    '_4_tg' => 'span._4_tg { background-position:0 -7072px }', 
    '_4_th' => 'span._4_th { background-position:0 -7089px }', 
    '_2h4' => 'span._2h4 { background-position:0 -7157px }', 
    '_2h5' => 'span._2h5 { background-position:0 -7174px }', 
    '_2h6' => 'span._2h6 { background-position:0 -7191px }', 
    '_4_ti' => 'span._4_ti { background-position:0 -7276px }', 
    '_4_tj' => 'span._4_tj { background-position:0 -7293px }', 
    '_4_tk' => 'span._4_tk { background-position:0 -7395px }', 
    '_4_tl' => 'span._4_tl { background-position:0 -7412px }', 
    '_4_tm' => 'span._4_tm { background-position:0 -7463px }', 
    '_4_tn' => 'span._4_tn { background-position:0 -7480px }', 
    '_4_to' => 'span._4_to { background-position:0 -7497px }', 
    '_4_tp' => 'span._4_tp { background-position:0 -7514px }', 
    '_4_tq' => 'span._4_tq { background-position:0 -7531px }', 
    '_4_tr' => 'span._4_tr { background-position:0 -7548px }', 
    '_4_ts' => 'span._4_ts { background-position:0 -7565px }', 
    '_4_tt' => 'span._4_tt { background-position:0 -7582px }', 
    '_4_tu' => 'span._4_tu { background-position:0 -6477px }', 
    '_4_tv' => 'span._4_tv { background-position:0 -6494px }', 
    '_4_tw' => 'span._4_tw { background-position:0 -6511px }', 
    '_4_tx' => 'span._4_tx { background-position:0 -6528px }', 
    '_2h7' => 'span._2h7 { background-position:0 -6647px }', 
    '_2h8' => 'span._2h8 { background-position:0 -6664px }', 
    '_2h9' => 'span._2h9 { background-position:0 -6698px }', 
    '_2ha' => 'span._2ha { background-position:0 -6715px }', 
    '_4_ty' => 'span._4_ty { background-position:0 -6766px }', 
    '_4_tz' => 'span._4_tz { background-position:0 -6783px }', 
    '_4_t-' => 'span._4_t- { background-position:0 -6800px }', 
    '_4_t_' => 'span._4_t_ { background-position:0 -6817px }', 
    '_4_u0' => 'span._4_u0 { background-position:0 -6834px }', 
    '_4_u1' => 'span._4_u1 { background-position:0 -7106px }', 
    '_4_u2' => 'span._4_u2 { background-position:0 -7123px }', 
    '_4_u3' => 'span._4_u3 { background-position:0 -7140px }', 
    '_4_u4' => 'span._4_u4 { background-position:0 -7208px }', 
    '_2hb' => 'span._2hb { background-position:0 -7225px }', 
    '_4_u5' => 'span._4_u5 { background-position:0 -7242px }', 
    '_4_u6' => 'span._4_u6 { background-position:0 -7259px }', 
    '_4_u7' => 'span._4_u7 { background-position:0 -7310px }', 
    '_4_u8' => 'span._4_u8 { background-position:0 -7327px }', 
    '_4_u9' => 'span._4_u9 { background-position:0 -7344px }', 
    '_4_ua' => 'span._4_ua { background-position:0 -7361px }', 
    '_2hc' => 'span._2hc { background-position:0 -7378px }', 
    '_4_ub' => 'span._4_ub { background-position:0 -7429px }', 
    '_4_uc' => 'span._4_uc { background-position:0 -7446px }', 
    '_4_ud' => 'span._4_ud { background-position:0 -7599px }', 
    '_4_ue' => 'span._4_ue { background-position:0 -7616px }',
  );

  
  # Return the code if exist
  if (exists($bdSprites{$sprite})) { return($bdSprites{$sprite}); }

}  #--- End cssSpriteBD

#--------------------------#
sub emoticon
#--------------------------#
{
  # Local variables
  my ($emoticonTag) = @_;
  my %bdImoticon = (
    'emoticon_smile' => 'span.emoticon_smile { background-position:0 -340px }', 
    'emoticon_frown' => 'span.emoticon_frown { background-position:0 -119px }', 
    'emoticon_poop' => 'span.emoticon_poop { background-position:0 -289px }', 
    'emoticon_putnam' => 'span.emoticon_putnam { background-position:0 -306px }', 
    'emoticon_tongue' => 'span.emoticon_tongue { background-position:0 -391px }', 
    'emoticon_grin' => 'span.emoticon_grin { background-position:0 -170px }', 
    'emoticon_gasp' => 'span.emoticon_gasp { background-position:0 -136px }', 
    'emoticon_wink' => 'span.emoticon_wink { background-position:0 -442px }', 
    'emoticon_glasses' => 'span.emoticon_glasses { background-position:0 -153px }', 
    'emoticon_sunglasses' => 'span.emoticon_sunglasses { background-position:0 -374px }', 
    'emoticon_grumpy' => 'span.emoticon_grumpy { background-position:0 -187px }', 
    'emoticon_unsure' => 'span.emoticon_unsure { background-position:0 -408px }', 
    'emoticon_cry' => 'span.emoticon_cry { background-position:0 -85px }', 
    'emoticon_devil' => 'span.emoticon_devil { background-position:0 -102px }', 
    'emoticon_angel' => 'span.emoticon_angel { background-position:0 -17px }', 
    'emoticon_kiss' => 'span.emoticon_kiss { background-position:0 -238px }', 
    'emoticon_heart' => 'span.emoticon_heart { background-position:0 -204px }', 
    'emoticon_kiki' => 'span.emoticon_kiki { background-position:0 -221px }', 
    'emoticon_squint' => 'span.emoticon_squint { background-position:0 -357px }', 
    'emoticon_confused' => 'span.emoticon_confused { background-position:0 -51px }', 
    'emoticon_confused_rev' => 'span.emoticon_confused_rev { background-position:0 -68px }', 
    'emoticon_upset' => 'span.emoticon_upset { background-position:0 -425px }', 
    'emoticon_pacman' => 'span.emoticon_pacman { background-position:0 -255px }', 
    'emoticon_robot' => 'span.emoticon_robot { background-position:0 -459px }', 
    'emoticon_colonthree' => 'span.emoticon_colonthree { background-position:0 -34px }', 
    'emoticon_penguin' => 'span.emoticon_penguin { background-position:0 -272px }', 
    'emoticon_shark' => 'span.emoticon_shark { background-position:0 -323px }', 
    'emoticon_like' => 'span.emoticon_like { background-position:0 0 }', 
  );

  
  # Return the code if exist
  if (exists($bdImoticon{$emoticonTag})) { return($bdImoticon{$emoticonTag}); }

}  #--- End emoticon